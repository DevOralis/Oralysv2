{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Gestion des Menus Standards{% endblock %}

{% block menu %}
{% include "menu_restauration.html" %}
{% endblock %}

{% block content %}

<div class="content">
    {% if messages %}
        {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
        <i class="fas fa-{% if message.tags == 'error' %}times-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2 fw-bold"></i>
        <div><strong>{% if message.tags == 'error' %}Erreur :{% elif message.tags == 'success' %}Succès :{% elif message.tags == 'warning' %}Attention :{% else %}Information :{% endif %}</strong> {{ message }}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
        </div>
        {% endfor %}
{% endif %}

  <!-- Table Header Component -->
    <div class="card mb-3">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-list me-2"></i>
      Liste des Menus Standards
        </div>
        <div class="card-body">
            <form method="get" id="search-form" class="mb-4">
                <div class="row g-2">
          <!-- Barre de recherche -->
          <div class="col-12 col-sm-12 col-md-6 col-lg-6 order-1">
            <div class="input-group">
              <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                <i class="fas fa-search"></i>
              </span>
                      <input type="search" name="q" id="menuSearch" class="form-control border-primary" style="border-color: #1e90ff;" placeholder="Recherche menus..." value="{{ request.GET.q|default:'' }}">
            </div>
            </div>
                  <!-- Filtre par repas -->
                  <div class="col-12 col-sm-12 col-md-3 col-lg-3 order-2">
                    <select name="repas" id="repasFilter" class="form-select border-primary">
              <option value="">Tous les repas</option>
              <option value="Petit déjeuner" {% if request.GET.repas == 'Petit déjeuner' %}selected{% endif %}>Petit déjeuner</option>
              <option value="Déjeuner" {% if request.GET.repas == 'Déjeuner' %}selected{% endif %}>Déjeuner</option>
              <option value="Collation" {% if request.GET.repas == 'Collation' %}selected{% endif %}>Collation</option>
              <option value="Dîner" {% if request.GET.repas == 'Dîner' %}selected{% endif %}>Dîner</option>
            </select>
                </div>
          <!-- Bouton Nouveau -->
                  <div class="col-12 col-sm-12 col-md-3 col-lg-3 order-3">
            <button type="button" class="btn w-100 text-nowrap px-3 py-2 text-white" style="background-color: #1e90ff; border-color: #1e90ff;" id="toggleMenuFormBtn" data-original-text='<i class="fas fa-plus me-2"></i><span class="d-none d-lg-inline">Nouveau</span>'>
              <i class="fas fa-plus me-2"></i>
              <span class="d-none d-lg-inline">Nouveau</span>
            </button>
            </div>
        </div>
      </form>

      <!-- Table Component -->
            <div class="table-container">
                <table class="table table-striped table-hover" id="searchableTable">
                    <thead class="table-light borderless">
                        <tr class="main-row">
                            <th class="d-none d-md-table-cell">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>
                                <div class="d-flex align-items-center">
                                    <span>Date</span>
                                    <i class="fas fa-sort ms-1 text-muted"></i>
    </div>
                            </th>
                            <th>
                                <div class="d-flex align-items-center">
                                    <span>Repas</span>
                                    <i class="fas fa-sort ms-1 text-muted"></i>
    </div>
                            </th>
              <th>
                <div class="d-flex align-items-center">
                  <span>Plats</span>
                  <i class="fas fa-sort ms-1 text-muted"></i>
                </div>
              </th>
                            <th class="d-none d-md-table-cell">Personnes Hébergées</th>
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for menu in menus %}
                        <tr class="main-row">
                            <td class="d-none d-md-table-cell">
                                <input type="checkbox" class="row-check">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <h6 class="mb-0 fw-semibold">{{ menu.date|date:"d/m/Y" }}</h6>
                                        <small class="text-muted">{{ menu.date|date:"l"|title }}</small>
                                    </div>
                                </div>
                            </td>
                <td>
                    {% if menu.repas == 'Petit déjeuner' %}
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-sun"></i> {{ menu.repas }} (07h00)
                        </span>
                    {% elif menu.repas == 'Déjeuner' %}
                        <span class="badge bg-success text-white">
                            <i class="fas fa-utensils"></i> {{ menu.repas }} (12h30)
                        </span>
                    {% elif menu.repas == 'Collation' %}
                        <span class="badge bg-info text-white">
                            <i class="fas fa-coffee"></i> {{ menu.repas }} (16h30)
                        </span>
                    {% elif menu.repas == 'Dîner' %}
                        <span class="badge bg-primary text-white">
                            <i class="fas fa-moon"></i> {{ menu.repas }} (20h00)
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">{{ menu.repas }}</span>
                    {% endif %}
                </td>
              <td>
                <div class="d-flex align-items-center">
                  <div>
                    <h6 class="mb-0 fw-semibold">{{ menu.plats.all|join:", "|truncatechars:30 }}</h6>
                    <small class="text-muted">{{ menu.plats.count }} plat{{ menu.plats.count|pluralize }}</small>
                  </div>
                                    </div>
                </td>
                            <td class="d-none d-md-table-cell">
                    {% if menu.nb_personnes > 0 %}
                  <span class="badge bg-success">{{ menu.nb_personnes }} personne{{ menu.nb_personnes|pluralize }}</span>
                    {% else %}
                  <span class="badge bg-secondary">Aucune personne</span>
                    {% endif %}
                </td>
                <td class="text-end">
                    <div class="d-flex gap-1 justify-content-end">
                  <button type="button" class="btn btn-sm btn-light border text-dark" title="Modifier" 
                          onclick="showEditForm({{ menu.id }}, '{{ menu.date|date:'Y-m-d' }}', '{{ menu.repas }}', '{{ menu.plats.all|join:',' }}')">
                            <i class="fas fa-edit"></i>
                  </button>
                        <button type="button" class="btn btn-sm btn-light border text-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteMenuModal{{ menu.id }}" title="Supprimer">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            </tr>
                    {% empty %}
                        <tr>
              <td colspan="5" class="text-center py-4">
                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucun menu standard disponible</p>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
      </div>
                
      <!-- Pagination Component -->
                {% if pagination_info and pagination_info.total_pages > 1 %}
                <nav class="mt-3">
                  <ul class="pagination justify-content-center flex-wrap">
                    {% if pagination_info.has_previous %}
                      <li class="page-item">
              <a class="page-link" href="?page={{ pagination_info.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.repas %}&repas={{ request.GET.repas }}{% endif %}" aria-label="Précédent">
                          <i class="fas fa-chevron-left d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Préc</span>
                        </a>
                      </li>
                    {% else %}
                      <li class="page-item disabled">
                        <span class="page-link">
                          <i class="fas fa-chevron-left d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Préc</span>
                        </span>
                      </li>
                    {% endif %}

                    {% for num in pagination_info.page_range %}
                      {% if num == '...' %}
                        <li class="page-item disabled">
                          <span class="page-link">…</span>
                        </li>
                      {% else %}
                        {% if num == pagination_info.current_page %}
                          <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                          </li>
                        {% else %}
                          <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.repas %}&repas={{ request.GET.repas }}{% endif %}">{{ num }}</a>
                          </li>
                        {% endif %}
                      {% endif %}
                    {% endfor %}

                    {% if pagination_info.has_next %}
                      <li class="page-item">
              <a class="page-link" href="?page={{ pagination_info.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.repas %}&repas={{ request.GET.repas }}{% endif %}" aria-label="Suivant">
                          <i class="fas fa-chevron-right d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Suiv</span>
                        </a>
                      </li>
                    {% else %}
                      <li class="page-item disabled">
                        <span class="page-link">
                          <i class="fas fa-chevron-right d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Suiv</span>
                        </span>
                      </li>
                    {% endif %}
                  </ul>
                </nav>
                {% endif %}

      </div>
            </div>
  </div>

  <!-- Espace entre la liste et les formulaires (réduit pour cohérence avec plats.html) -->
  <div class="mb-0"></div>

  <!-- Formulaire d'ajout (en dehors de la carte de liste) -->
  <div class="card mt-3 mb-4 ms-1 ms-sm-2 ms-md-3 me-1 me-sm-2 me-md-3" id="addMenuFormCard" style="display: block;">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <h5 class="mb-0" style="font-size: inherit; font-weight: 500;">
        <i class="fas fa-plus-circle me-2"></i>Ajouter un Menu Standard
      </h5>
    </div>
    <div class="card-body">
      <form id="addMenuForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">
        <div class="mb-3">
          <label for="{{ form.date.id_for_label }}" class="form-label fw-semibold">Date <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
            {{ form.date }}
          </div>
        </div>
        <div class="mb-3">
          <label for="{{ form.repas.id_for_label }}" class="form-label fw-semibold">Type de repas <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-clock"></i></span>
            {{ form.repas }}
          </div>
        </div>
        <div class="mb-3">
          <label for="{{ form.plats.id_for_label }}" class="form-label fw-semibold">Plats <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-list"></i></span>
            {{ form.plats }}
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-end">
          <button type="button" class="btn btn-secondary" id="cancelMenuFormBtn">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn text-white" style="background-color: #1e90ff; border-color: #1e90ff;">
            <i class="fas fa-save me-2"></i>Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Formulaire de modification (en dehors de la carte de liste) -->
  <div class="card mt-3 mb-4 ms-1 ms-sm-2 ms-md-3 me-1 me-sm-2 me-md-3" id="editMenuFormCard" style="display: none;">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <h5 class="mb-0" style="font-size: inherit; font-weight: 500;">
        <i class="fas fa-edit me-2"></i>Modifier le Menu Standard
      </h5>
    </div>
    <div class="card-body">
      <form id="editMenuForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="menu_id" id="edit_menu_id">
        <div class="mb-3">
          <label for="edit_menu_date" class="form-label fw-semibold">Date <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
            <input type="date" name="date" id="edit_menu_date" class="form-control" required>
          </div>
        </div>
        <div class="mb-3">
          <label for="edit_menu_repas" class="form-label fw-semibold">Type de repas <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-clock"></i></span>
            <select name="repas" id="edit_menu_repas" class="form-select" required>
              <option value="Petit déjeuner">Petit déjeuner</option>
              <option value="Déjeuner">Déjeuner</option>
              <option value="Collation">Collation</option>
              <option value="Dîner">Dîner</option>
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label for="edit_menu_plats" class="form-label fw-semibold">Plats <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-list"></i></span>
            <select name="plats" id="edit_menu_plats" class="form-select" multiple required>
              {% for plat in plats %}
                <option value="{{ plat.id }}">{{ plat.nom }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="d-flex gap-2 justify-content-end">
          <button type="button" class="btn btn-secondary" id="cancelEditMenuFormBtn">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn text-white" style="background-color: #1e90ff; border-color: #1e90ff;">
            <i class="fas fa-edit me-2"></i>Mettre à jour
          </button>
        </div>
      </form>
    </div>
</div>

<!-- Modal Ajout Menu -->
<div class="modal fade" id="modalMenu" tabindex="-1" aria-labelledby="modalMenuLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">
        <div class="modal-header bg-gradient-primary text-white">
          <h5 class="modal-title" id="modalMenuLabel">
            <i class="fas fa-plus-circle me-2"></i>Ajouter un Menu Standard
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="{{ form.date.id_for_label }}" class="form-label fw-semibold">Date <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-calendar"></i></span>
              {{ form.date }}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.repas.id_for_label }}" class="form-label fw-semibold">Type de repas <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-clock"></i></span>
              {{ form.repas }}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="{{ form.plats.id_for_label }}" class="form-label fw-semibold">Plats <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-list"></i></span>
              {{ form.plats }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Modales Bootstrap pour confirmation de suppression -->
{% for menu in menus %}
<div class="modal fade" id="confirmDeleteMenuModal{{ menu.id }}" tabindex="-1" aria-labelledby="confirmDeleteMenuModalLabel{{ menu.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteMenuModalLabel{{ menu.id }}">
            <i class="fas fa-trash-alt me-2"></i>Confirmation de suppression
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
        Voulez-vous vraiment supprimer le menu standard du <strong>{{ menu.date|date:"d/m/Y" }}</strong> ({{ menu.repas }}) ?
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-danger" onclick="deleteMenu({{ menu.id }})">
              <i class="fas fa-trash-alt me-1"></i>Supprimer
          </button>
                  </div>
                </div>
              </div>
            </div>
        {% endfor %}

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
  // Gestion des messages de succès/erreur
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    // Auto-fermeture des alertes après 5 secondes
    setTimeout(() => {
      if (alert && !alert.classList.contains('alert-dismissed')) {
        const closeButton = alert.querySelector('.btn-close');
        if (closeButton) {
          closeButton.click();
        }
      }
    }, 5000);
  });

  // Amélioration de l'accessibilité
  const searchInput = document.getElementById('menuSearch');
  if (searchInput) {
    searchInput.setAttribute('aria-label', 'Rechercher dans les menus standards');
    searchInput.setAttribute('title', 'Tapez une date ou un type de repas pour rechercher');
  }

  const repasSelect = document.getElementById('repasFilter');
  if (repasSelect) {
    repasSelect.setAttribute('aria-label', 'Filtrer par type de repas');
  }

  // Gestion du formulaire d'édition inline
  const editMenuFormCard = document.getElementById('editMenuFormCard');
  const cancelEditMenuFormBtn = document.getElementById('cancelEditMenuFormBtn');
  const editMenuForm = document.getElementById('editMenuForm');

  if (cancelEditMenuFormBtn && editMenuFormCard) {
    cancelEditMenuFormBtn.addEventListener('click', function() {
      editMenuFormCard.style.display = 'none';
      editMenuForm.reset();
    });
  }

  // Gestion de la soumission du formulaire d'édition
  if (editMenuForm) {
    editMenuForm.addEventListener('submit', function(event) {
      event.preventDefault();
      
      const formData = new FormData(this);
      
      // Récupérer l'ID du menu depuis le champ caché
      const menuId = document.getElementById('edit_menu_id').value;
      
      if (menuId) {
        formData.append('menu_id', menuId);
        formData.append('action', 'edit');
        
        // Envoyer la requête de modification
        fetch(window.location.href, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Masquer le formulaire d'édition
            editMenuFormCard.style.display = 'none';
            editMenuForm.reset();
            // Rafraîchir la page
            window.location.reload();
          } else {
            // Afficher les erreurs de validation détaillées
            let errorMessage = 'Erreur lors de la modification: ' + (data.message || 'Erreur inconnue');
            
            if (data.errors) {
              errorMessage += '\n\nErreurs de validation:\n';
              for (const [field, errors] of Object.entries(data.errors)) {
                errorMessage += `- ${field}: ${errors.join(', ')}\n`;
              }
            }
            
            alert(errorMessage);
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          alert('Une erreur est survenue lors de la modification du menu');
        });
      } else {
        alert('Erreur: Impossible de récupérer l\'ID du menu à modifier');
      }
    });
  }
});

// Fonction globale pour afficher le formulaire d'édition
function showEditForm(menuId, menuDate, menuRepas, menuPlats) {
  // Masquer le formulaire d'ajout s'il est ouvert
  const addMenuFormCard = document.getElementById('addMenuFormCard');
  const toggleMenuFormBtn = document.getElementById('toggleMenuFormBtn');
  if (addMenuFormCard && addMenuFormCard.style.display !== 'none') {
    addMenuFormCard.style.display = 'none';
    if (toggleMenuFormBtn) {
      toggleMenuFormBtn.innerHTML = toggleMenuFormBtn.getAttribute('data-original-text');
      toggleMenuFormBtn.classList.remove('btn-secondary');
      toggleMenuFormBtn.classList.add('btn-primary');
    }
  }
  
  // Remplir le formulaire d'édition avec les données existantes
  const editMenuId = document.getElementById('edit_menu_id');
  const dateInput = document.getElementById('edit_menu_date');
  const repasSelect = document.getElementById('edit_menu_repas');
  const platsSelect = document.getElementById('edit_menu_plats');
  const editMenuFormCard = document.getElementById('editMenuFormCard');

  if (editMenuId) editMenuId.value = menuId;
  if (dateInput) dateInput.value = menuDate || '';
  if (repasSelect) repasSelect.value = menuRepas || '';
  
  // Gérer la sélection multiple des plats
  if (platsSelect && menuPlats) {
    const platIds = menuPlats.split(',').map(id => id.trim());
    Array.from(platsSelect.options).forEach(option => {
      option.selected = platIds.includes(option.value);
    });
  }
  
  // Placer le formulaire d'édition au même emplacement (après l'entête de liste)
  const listCard = document.querySelector('.card.mb-3');
  const editFormCard = document.getElementById('editMenuFormCard');
  const addCard = document.getElementById('addMenuFormCard');
  if (editFormCard) {
    if (addCard && addCard.parentNode) {
      // Placer l'édition juste avant l'ajout dans le même parent
      addCard.parentNode.insertBefore(editFormCard, addCard);
    } else if (listCard && listCard.parentNode) {
      // Fallback: placer juste après la card de liste
      listCard.parentNode.insertBefore(editFormCard, listCard.nextSibling);
    }
  }
  // Afficher le formulaire d'édition
  if (editFormCard) {
    editFormCard.style.display = 'block';
    editFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

// Fonction globale pour supprimer un menu
function deleteMenu(menuId) {
  if (confirm('Êtes-vous sûr de vouloir supprimer ce menu ?')) {
    const formData = new FormData();
    formData.append('menu_id', menuId);
    formData.append('action', 'delete');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(window.location.href, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Fermer le modal de confirmation
        const modal = bootstrap.Modal.getInstance(document.getElementById(`confirmDeleteMenuModal${menuId}`));
        modal.hide();
        // Rafraîchir la page
        window.location.reload();
      } else {
        alert('Erreur lors de la suppression: ' + (data.message || 'Erreur inconnue'));
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      alert('Une erreur est survenue lors de la suppression du menu');
    });
  }
}

// Gestion des modals et des checkboxes
document.addEventListener('DOMContentLoaded', function() {
  // Gestion de la checkbox "Sélectionner tout"
  const selectAllCheckbox = document.getElementById('selectAll');
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      const rowCheckboxes = document.querySelectorAll('.row-check');
      rowCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });
  }

  // Gestion des checkboxes individuelles
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('row-check')) {
      const rowCheckboxes = document.querySelectorAll('.row-check');
      const selectAllCheckbox = document.getElementById('selectAll');
      
      if (selectAllCheckbox) {
        const checkedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
        const totalCount = rowCheckboxes.length;
        
        if (checkedCount === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === totalCount) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }
    }
  });
});

// Recherche et filtre instantanés
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('menuSearch');
  const repasFilter = document.getElementById('repasFilter');
  let searchTimeout;

  // Fonction pour effectuer la recherche
  function performSearch() {
    const query = searchInput ? searchInput.value.trim() : '';
    const repas = repasFilter ? repasFilter.value : '';
    
    // Construire l'URL avec les paramètres
    const params = new URLSearchParams();
    if (query) params.append('q', query);
    if (repas) params.append('repas', repas);
    
    // Rediriger vers la nouvelle URL
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.location.href = newUrl;
  }

  // Écouter les changements dans la barre de recherche
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      searchTimeout = setTimeout(() => {
        performSearch();
      }, 500); // Délai de 500ms pour éviter trop de requêtes
    });

    // Écouter la touche Entrée
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        performSearch();
      }
    });
  }

  // Écouter les changements dans le filtre de repas
  if (repasFilter) {
    repasFilter.addEventListener('change', function() {
      performSearch();
    });
  }

  // Gestion du formulaire inline
  const toggleMenuFormBtn = document.getElementById('toggleMenuFormBtn');
  const addMenuFormCard = document.getElementById('addMenuFormCard');
  const cancelMenuFormBtn = document.getElementById('cancelMenuFormBtn');
  const addMenuForm = document.getElementById('addMenuForm');

  if (toggleMenuFormBtn && addMenuFormCard) {
    toggleMenuFormBtn.addEventListener('click', function() {
      if (addMenuFormCard.style.display === 'none') {
        // Masquer le formulaire d'édition s'il est ouvert
        const editMenuFormCard = document.getElementById('editMenuFormCard');
        if (editMenuFormCard && editMenuFormCard.style.display !== 'none') {
          editMenuFormCard.style.display = 'none';
        }
        
        addMenuFormCard.style.display = 'block';
        addMenuFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        toggleMenuFormBtn.innerHTML = '<i class="fas fa-times me-2"></i><span class="d-none d-lg-inline">Annuler</span>';
        toggleMenuFormBtn.classList.remove('btn-primary');
        toggleMenuFormBtn.classList.add('btn-secondary');
      } else {
        addMenuFormCard.style.display = 'none';
        toggleMenuFormBtn.innerHTML = toggleMenuFormBtn.getAttribute('data-original-text');
        toggleMenuFormBtn.classList.remove('btn-secondary');
        toggleMenuFormBtn.classList.add('btn-primary');
        addMenuForm.reset();
      }
    });
  }

  if (cancelMenuFormBtn) {
    cancelMenuFormBtn.addEventListener('click', function() {
      addMenuFormCard.style.display = 'none';
      toggleMenuFormBtn.innerHTML = toggleMenuFormBtn.getAttribute('data-original-text');
      toggleMenuFormBtn.classList.remove('btn-secondary');
      toggleMenuFormBtn.classList.add('btn-primary');
      addMenuForm.reset();
    });
  }
});
</script>
{% endblock %}