{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Gestion des plats{% endblock %}

{% block extra_css %}
<style>
  .ingredients-details {
    margin-top: 8px;
  }
  
  .ingredients-details .badge {
    font-size: 0.7rem;
    padding: 4px 8px;
  }
  
  .ingredients-details .text-primary {
    font-weight: 600;
    min-width: 30px;
    text-align: center;
  }
  
  .ingredients-details .text-muted {
    font-size: 0.75rem;
    min-width: 20px;
  }
</style>
{% endblock %}

{% block menu %}
{% include "menu_restauration.html" %}
{% endblock %}

{% block content %}

<div class="content">
    <!-- Messages (style maintenance) -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% elif message.tags == 'info' %}info{% else %}primary{% endif %} alert-dismissible fade show d-flex align-items-center" role="alert">
            <i class="fas fa-{% if message.tags == 'error' %}times-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% elif message.tags == 'info' %}info-circle{% else %}bell{% endif %} me-2 fw-bold"></i>
            <div><strong>{% if message.tags == 'error' %}Erreur :{% elif message.tags == 'success' %}Succès :{% elif message.tags == 'warning' %}Attention :{% elif message.tags == 'info' %}Information :{% else %}Info :{% endif %}</strong> {{ message }}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Barre de recherche et filtres -->
    <div class="card mb-4">
        <div class="card-header text-white" style="background-color: #1e90ff;">
            <i class="fas fa-utensils me-2"></i>
            Liste des Plats
        </div>
        <div class="card-body">
            <form method="get" id="search-form" class="mb-4">
                <div class="row g-2">
                    <!-- Barre de recherche -->
                    <div class="col-12 col-sm-12 col-md-8 col-lg-8 order-1">
                        <div class="input-group">
                            <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="search" name="q" id="platsSearch" class="form-control border-primary" style="border-color: #1e90ff;" placeholder="Recherche plats..." value="{{ query|default:'' }}">
                        </div>
                    </div>
                    <!-- Boutons d'action -->
                    <div class="col-12 col-sm-12 col-md-4 col-lg-4 order-2">
                        <div class="d-flex gap-1">
                            <button type="button" class="btn w-100 text-nowrap px-2 text-white" style="background-color: #1e90ff; border-color: #1e90ff;" onclick="toggleAddForm()">
                                <i class="fas fa-plus"></i>
                                <span class="d-none d-lg-inline ms-1">Nouveau</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Tableau moderne -->
            <div class="table-container">
                <table class="table table-striped table-hover" id="searchableTable">
                    <thead class="table-light borderless">
                        <tr class="main-row">
                            <th class="d-none d-md-table-cell">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>
                                <div class="d-flex align-items-center">
                                    <span>Nom du Plat</span>
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                </div>
                            </th>
                            <th class="d-none d-md-table-cell">
                                <div class="d-flex align-items-center">
                                    <span>Description</span>
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                </div>
                            </th>
                            <th class="d-none d-md-table-cell">Recette</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="plats-table">
                        {% for plat in plats %}
                        <tr class="main-row">
                            <td class="d-none d-md-table-cell">
                                <input type="checkbox" class="row-check">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div>
                                        <h6 class="mb-0 fw-semibold">{{ plat.nom }}</h6>
                                        <small class="text-muted">Ref: PL-{{ plat.id|stringformat:"04d" }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-md-table-cell">
                                <span class="text-muted">Plat disponible</span>
                            </td>
                            <td class="d-none d-md-table-cell">
                                {% if plat.recette and plat.recette.lignes_recette.all %}
                                    <div class="d-flex flex-column">
                                        <span class="badge bg-info">{{ plat.recette.lignes_recette.all|length }} ingrédients</span>
                                        <div class="ingredients-details">
                                            {% for ligne in plat.recette.lignes_recette.all|slice:":3" %}
                                                <div class="d-flex align-items-center mb-1">
                                                    <span class="badge bg-light text-dark me-2">{{ ligne.ingredient.name }}</span>
                                                    <small class="text-primary fw-semibold">{{ ligne.quantite_par_portion }}</small>
                                                    <small class="text-muted ms-1">{% if ligne.ingredient.uom %}{{ ligne.ingredient.uom.symbol }}{% endif %}</small>
                                                </div>
                                            {% endfor %}
                                            {% if plat.recette.lignes_recette.all|length > 3 %}
                                                <small class="text-muted">+{{ plat.recette.lignes_recette.all|length|add:"-3" }} autres...</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% else %}
                                    <span class="text-muted">Aucune recette</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <div class="d-flex gap-1 justify-content-end">
                                    <button class="btn btn-sm btn-light border text-dark" title="Modifier"
                                            data-plat-id="{{ plat.id }}"
                                            data-plat-nom="{{ plat.nom }}"
                                            data-plat-recette='{{ plat.lignes_recette_json|safe }}'
                                            onclick="toggleEditForm(this)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light border text-danger" title="Supprimer" data-bs-toggle="modal" data-bs-target="#modalDeletePlat"
                                            data-plat-id="{{ plat.id }}"
                                            data-plat-nom="{{ plat.nom }}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Aucun plat enregistré</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <!-- Pagination Component -->
                {% if pagination_info and pagination_info.total_pages > 1 %}
                <nav class="mt-3">
                  <ul class="pagination justify-content-center flex-wrap">
                    {% if pagination_info.has_previous %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ pagination_info.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Précédent">
                          <i class="fas fa-chevron-left d-block d-sm-none"></i>
                          <span class="d-none d-sm-block">Préc</span>
                        </a>
                      </li>
                    {% else %}
                      <li class="page-item disabled">
                        <span class="page-link">
                          <i class="fas fa-chevron-left d-block d-sm-none"></i>
                          <span class="d-none d-sm-block">Préc</span>
                        </span>
                      </li>
                    {% endif %}

                    {% for num in pagination_info.page_range %}
                      {% if num == '...' %}
                        <li class="page-item disabled">
                          <span class="page-link">…</span>
                        </li>
                      {% else %}
                        {% if num == pagination_info.current_page %}
                          <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                          </li>
                        {% else %}
                          <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
                          </li>
                        {% endif %}
                      {% endif %}
                    {% endfor %}

                    {% if pagination_info.has_next %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ pagination_info.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" aria-label="Suivant">
                          <i class="fas fa-chevron-right d-block d-sm-none"></i>
                          <span class="d-none d-sm-block">Suiv</span>
                        </a>
                      </li>
                    {% else %}
                      <li class="page-item disabled">
                        <span class="page-link">
                          <i class="fas fa-chevron-right d-block d-sm-none"></i>
                          <span class="d-none d-sm-block">Suiv</span>
                        </span>
                      </li>
                    {% endif %}
                  </ul>
                </nav>
                {% endif %}

            </div>
        </div>
    </div>

    <!-- Espace entre la liste et les formulaires -->
    <div class="mb-4"></div>

    <!-- Formulaire d'ajout de plat (en dehors des cards) -->
    <div class="card mb-4" id="addMenuFormCard" style="display: block;">
        <div class="card-header text-white" style="background-color: #1e90ff;">
            <h5 class="mb-0" style="font-size: inherit; font-weight: 500;">
                <i class="fas fa-plus-circle me-2"></i>Ajouter un nouveau plat
            </h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'restauration_home' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="add">
                
                <div class="mb-3">
                    <label for="id_nom" class="form-label">Nom du Plat <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-utensils"></i></span>
                        <input type="text" class="form-control" id="id_nom" name="nom" placeholder="Nom du plat" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Composition du Plat (Ingrédients)</label>
                    <div id="ingredientsContainer">
                        <div class="ingredient-line">
                            <div class="mb-3">
                                <label class="form-label">Catégorie d'ingrédients</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                    <select class="form-select categorie-select" onchange="filterIngredients(this)">
                                        <option value="">Toutes les catégories</option>
                                        {% for cat in categories %}
                                        <option value="{{ cat.categ_id }}">{{ cat.label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ingrédient <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-carrot"></i></span>
                                    <select name="ingredient[]" required onchange="updateUnite(this)" class="form-select ingredient-select">
                                        <option value="">Sélectionner un ingrédient</option>
                                        {% for ingredient in ingredients %}
                                        <option value="{{ ingredient.product_id }}" data-categorie="{% if ingredient.categ %}{{ ingredient.categ.categ_id }}{% endif %}" data-unite="{% if ingredient.uom %}{{ ingredient.uom.symbol }}{% endif %}">{{ ingredient.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Quantité <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-balance-scale"></i></span>
                                            <input type="number" name="quantite[]" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Unité <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-ruler"></i></span>
                                            <select name="unite[]" class="form-select unite-select" required>
                                                <option value="">Sélectionner une unité</option>
                                                {% for uom in uoms %}
                                                <option value="{{ uom.uom_id }}">{{ uom.name }} ({{ uom.symbol }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-btn" onclick="removeIngredient(this)">
                                        <i class="fas fa-trash-alt me-1"></i>Supprimer
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addIngredient()">
                                        <i class="fas fa-plus me-1"></i>Ajouter un ingrédient
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-secondary" onclick="toggleAddForm()">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="submit" class="btn text-white" style="background-color: #1e90ff; border-color: #1e90ff;">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulaire de modification de plat (en dehors des cards) -->
    <div class="card mb-4" id="editFormSection" style="display: none;">
        <div class="card-header text-white" style="background-color: #1e90ff;">
            <h5 class="mb-0" style="font-size: inherit; font-weight: 500;">
                <i class="fas fa-edit me-2"></i>Modifier le plat
            </h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'restauration_home' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="plat_id" id="edit_plat_id">
                
                <div class="mb-3">
                    <label for="edit_nom" class="form-label">Nom du Plat <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-utensils"></i></span>
                        <input type="text" class="form-control" id="edit_nom" name="nom" placeholder="Nom du plat" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Composition du Plat (Ingrédients)</label>
                    <div id="editIngredientsContainer">
                        {# Les lignes d'ingrédients seront ajoutées ici par JS #}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addIngredientEdit()">
                        <i class="fas fa-plus me-1"></i>Ajouter un ingrédient
                    </button>
                </div>
                
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-secondary" onclick="toggleEditForm()">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="submit" class="btn text-white" style="background-color: #1e90ff; border-color: #1e90ff;">
                        <i class="fas fa-edit me-2"></i>Mettre à jour
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

  <!-- Modal pour ajouter un nouveau plat -->
  <div class="modal fade" id="modalPlat" tabindex="-1" aria-labelledby="modalPlatLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title" id="modalPlatLabel">
                    <i class="fas fa-plus-circle me-2"></i>Ajouter un nouveau plat
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'restauration_home' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="add">
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_nom" class="form-label fw-semibold">Nom du Plat <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-utensils"></i></span>
                                    <input type="text" class="form-control" id="id_nom" name="nom" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4 mt-4">
                        <label class="form-label fw-semibold">Composition du Plat (Ingrédients)</label>
                        <div id="ingredientsContainer">
                            <div class="ingredient-line">
                                <div class="mb-3">
                                    <label class="form-label">Catégorie d'ingrédients</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                        <select class="form-select categorie-select" onchange="filterIngredients(this)">
                                            <option value="">Toutes les catégories</option>
                                            {% for cat in categories %}
                                            <option value="{{ cat.categ_id }}">{{ cat.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ingrédient <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-carrot"></i></span>
                                        <select name="ingredient[]" required onchange="updateUnite(this)" class="form-select ingredient-select">
                                            <option value="">Sélectionner un ingrédient</option>
                                            {% for ingredient in ingredients %}
                                            <option value="{{ ingredient.product_id }}" data-categorie="{% if ingredient.categ %}{{ ingredient.categ.categ_id }}{% endif %}" data-unite="{% if ingredient.uom %}{{ ingredient.uom.symbol }}{% endif %}">{{ ingredient.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Quantité <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-balance-scale"></i></span>
                                                <input type="number" name="quantite[]" class="form-control" placeholder="0.00" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Unité <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="fas fa-ruler"></i></span>
                                                <select name="unite[]" class="form-select unite-select" required>
                                                    <option value="">Sélectionner une unité</option>
                                                    {% for uom in uoms %}
                                                    <option value="{{ uom.uom_id }}">{{ uom.name }} ({{ uom.symbol }})</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-sm btn-light border text-danger remove-btn" onclick="removeIngredient(this)">
                                            <i class="fas fa-trash-alt me-1"></i>Supprimer
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addIngredient()">
                                            <i class="fas fa-plus me-1"></i>Ajouter un ingrédient
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour éditer un plat -->
<div class="modal fade" id="modalEditPlat" tabindex="-1" aria-labelledby="modalEditPlatLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="modalEditPlatLabel">
            <i class="fas fa-edit me-2"></i>Modifier le plat
          </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'restauration_home' %}" class="needs-validation" novalidate>
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="plat_id" id="edit_plat_id">
        <div class="modal-body p-4">
          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <label for="edit_nom" class="form-label fw-semibold">Nom du Plat <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-utensils"></i></span>
                  <input type="text" class="form-control" id="edit_nom" name="nom" required>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Composition du Plat (Ingrédients)</label>
            <div id="editIngredientsContainer">
              {# Les lignes d'ingrédients seront ajoutées ici par JS #}
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addIngredientEdit()">
              <i class="fas fa-plus me-1"></i>Ajouter un ingrédient
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" class="btn btn-warning">
            <i class="fas fa-save me-2"></i>Mettre à jour
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal pour supprimer un plat -->
<div class="modal fade" id="modalDeletePlat" tabindex="-1" aria-labelledby="modalDeletePlatLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalDeletePlatLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirmer la suppression
          </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
        <h5 class="text-danger">Attention!</h5>
        <p>Êtes-vous sûr de vouloir supprimer le plat : <strong id="delete_plat_nom" class="text-primary"></strong> ?</p>
        <p class="text-danger"><small>Cette action est irréversible et supprimera définitivement toutes les données associées.</small></p>
        <form id="deletePlatForm" method="post" action="{% url 'restauration_home' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <input type="hidden" name="plat_id" id="delete_plat_id">
        </form>
      </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Annuler
          </button>
          <button type="submit" form="deletePlatForm" class="btn btn-danger">
            <i class="fas fa-trash-alt me-2"></i>Supprimer
          </button>
        </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Variables de state pour gérer la visibilité des formulaires
  let isAddFormVisible = true;
  let isEditFormVisible = false;

  // Données des catégories pour le JavaScript
  const categoriesData = [
    {% for cat in categories %}
    { id: "{{ cat.categ_id }}", name: "{{ cat.label }}" },
    {% endfor %}
  ];

  // Données des ingrédients pour le JavaScript
  const ingredientsData = [
    {% for ingredient in ingredients %}
    { id: "{{ ingredient.product_id }}", name: "{{ ingredient.name }}", categorie_id: "{{ ingredient.categ.categ_id|default:'' }}", unite_id: "{{ ingredient.uom.uom_id|default:'' }}" },
    {% endfor %}
  ];

  // Données des unités de mesure pour le JavaScript
  const uomsData = [
    {% for uom in uoms %}
    { id: "{{ uom.uom_id }}", name: "{{ uom.name }}", symbol: "{{ uom.symbol }}" },
    {% endfor %}
  ];

  // Fonction pour ajouter une ligne d'ingrédient (pour le formulaire d'ajout)
  function addIngredient() {
    const container = document.getElementById("ingredientsContainer");
    const newLine = document.createElement("div");
    newLine.className = "ingredient-line";
    newLine.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Catégorie d'ingrédients</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-tags"></i></span>
          <select class="form-select categorie-select" onchange="filterIngredients(this)">
            <option value="">Toutes les catégories</option>
            ${categoriesData.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Ingrédient <span class="text-danger">*</span></label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-carrot"></i></span>
          <select name="ingredient[]" required onchange="updateUnite(this)" class="form-select ingredient-select">
            <option value="">Sélectionner un ingrédient</option>
            ${ingredientsData.map(ingredient => `<option value="${ingredient.id}" data-categorie="${ingredient.categorie_id}" data-unite="${ingredient.unite_id}">${ingredient.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Quantité <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-balance-scale"></i></span>
              <input type="number" name="quantite[]" class="form-control" placeholder="0.00" step="0.01" min="0" required>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Unité <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-ruler"></i></span>
              <select name="unite[]" class="form-select unite-select" required>
                <option value="">Sélectionner une unité</option>
                ${uomsData.map(uom => `<option value="${uom.id}">${uom.name} (${uom.symbol})</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <button type="button" class="btn btn-sm btn-light border text-danger remove-btn" onclick="removeIngredient(this)">
            <i class="fas fa-trash-alt me-1"></i>Supprimer
          </button>
        </div>
        <div class="col-md-6">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addIngredient()">
            <i class="fas fa-plus me-1"></i>Ajouter un ingrédient
          </button>
        </div>
      </div>
    `;
    container.appendChild(newLine);
  }

  // Fonction pour ajouter une ligne d'ingrédient (pour le formulaire d'édition)
  function addIngredientEdit(ingredientId = '', quantite = '', categorieId = '') {
    const container = document.getElementById("editIngredientsContainer");
    const newLine = document.createElement("div");
    newLine.className = "ingredient-line";
    newLine.innerHTML = `
      <div class="mb-3">
        <label class="form-label">Catégorie d'ingrédients</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-tags"></i></span>
          <select class="form-select categorie-select" onchange="filterIngredients(this)">
            <option value="">Toutes les catégories</option>
            ${categoriesData.map(cat => `<option value="${cat.id}" ${cat.id == categorieId ? 'selected' : ''}>${cat.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Ingrédient <span class="text-danger">*</span></label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-carrot"></i></span>
          <select name="ingredient[]" required onchange="updateUnite(this)" class="form-select ingredient-select">
            <option value="">Sélectionner un ingrédient</option>
            ${ingredientsData.map(ingredient => `<option value="${ingredient.id}" data-categorie="${ingredient.categorie_id}" data-unite="${ingredient.unite_id}" ${ingredient.id == ingredientId ? 'selected' : ''}>${ingredient.name}</option>`).join('')}
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Quantité <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-balance-scale"></i></span>
              <input type="number" name="quantite[]" class="form-control" placeholder="0.00" step="0.01" min="0" value="${quantite}" required>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Unité <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-ruler"></i></span>
              <select name="unite[]" class="form-select unite-select" required>
                <option value="">Sélectionner une unité</option>
                ${uomsData.map(uom => `<option value="${uom.id}">${uom.name} (${uom.symbol})</option>`).join('')}
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <button type="button" class="btn btn-sm btn-light border text-danger remove-btn" onclick="removeIngredient(this)">
            <i class="fas fa-trash-alt me-1"></i>Supprimer
          </button>
        </div>
        <div class="col-md-6">
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="addIngredientEdit()">
            <i class="fas fa-plus me-1"></i>Ajouter un ingrédient
          </button>
        </div>
      </div>
    `;
    container.appendChild(newLine);
    // Mettre à jour l'unité après l'ajout si un ingrédient est présélectionné
    if (ingredientId) {
      updateUnite(newLine.querySelector('.ingredient-select'));
    }
  }

  // Fonction pour supprimer une ligne d'ingrédient
  function removeIngredient(button) {
    const ingredientLine = button.closest('.ingredient-line');
    const container = ingredientLine.parentElement;
    const lines = container.querySelectorAll('.ingredient-line');
    if (lines.length > 1) {
      ingredientLine.remove();
    } else {
      alert('Il faut au moins un ingrédient pour le plat.');
    }
  }

  // Fonction pour filtrer les ingrédients selon la catégorie sélectionnée
  function filterIngredients(categorieSelect) {
    const ingredientLine = categorieSelect.closest('.ingredient-line');
    const ingredientSelect = ingredientLine.querySelector('.ingredient-select');
    const selectedCategorie = categorieSelect.value;
    
    // Réinitialiser la sélection d'ingrédient
    ingredientSelect.value = '';
    updateUnite(ingredientSelect);
    
    // Filtrer les options d'ingrédients
    for (let option of ingredientSelect.options) {
      if (!option.value) continue; // Ignorer l'option placeholder
      
      const ingredientCategorie = option.getAttribute('data-categorie');
      if (!selectedCategorie || ingredientCategorie === selectedCategorie) {
        option.style.display = '';
      } else {
        option.style.display = 'none';
      }
    }
  }

  // Fonction pour mettre à jour l'unité affichée
  function updateUnite(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const uniteSelect = selectElement.closest('.ingredient-line').querySelector('.unite-select');
    if (selectedOption && uniteSelect) {
      const unite = selectedOption.getAttribute('data-unite');
      if (unite) {
        uniteSelect.value = unite;
      }
    }
  }

  // Initialiser les unités pour les lignes existantes (si rechargement de page)
  document.querySelectorAll('.ingredient-line select').forEach(select => {
    updateUnite(select);
  });

  // Fonction pour afficher/masquer le formulaire d'ajout
  function toggleAddForm() {
    const addFormSection = document.getElementById('addMenuFormCard');
    const editFormSection = document.getElementById('editFormSection');
    
    if (isAddFormVisible) {
      // Masquer le formulaire d'ajout
      addFormSection.style.display = 'none';
      isAddFormVisible = false;
      clearAddForm();
    } else {
      // Masquer le formulaire d'édition s'il est visible
      if (isEditFormVisible) {
        document.getElementById('editFormSection').style.display = 'none';
        isEditFormVisible = false;
        clearEditForm();
      }
      // S'assurer que le formulaire d'ajout est au même emplacement
      if (addFormSection && editFormSection && addFormSection.previousElementSibling !== editFormSection.previousElementSibling) {
        addFormSection.parentNode.insertBefore(addFormSection, editFormSection);
      }
      // Afficher le formulaire d'ajout
      addFormSection.style.display = 'block';
      isAddFormVisible = true;
      // Faire défiler vers le formulaire d'ajout
      window.scrollTo({ top: addFormSection.offsetTop - 80, behavior: 'smooth' });
    }
  }

  // Fonction pour afficher/masquer le formulaire d'édition
  function toggleEditForm(button) {
    const editFormSection = document.getElementById('editFormSection');
    const addFormSection = document.getElementById('addMenuFormCard');
    
    if (isEditFormVisible) {
      // Masquer le formulaire de modification
      editFormSection.style.display = 'none';
      isEditFormVisible = false;
      clearEditForm();
    } else {
      // Masquer le formulaire d'ajout s'il est visible
      if (isAddFormVisible) {
        document.getElementById('addMenuFormCard').style.display = 'none';
        isAddFormVisible = false;
        clearAddForm();
      }
      // Placer le formulaire d'édition exactement à l'emplacement de celui d'ajout
      if (addFormSection && editFormSection) {
        addFormSection.parentNode.insertBefore(editFormSection, addFormSection);
      }
      // Afficher le formulaire de modification avec les données
      editFormSection.style.display = 'block';
      isEditFormVisible = true;
      // Remplir le formulaire avec les données du plat
      editPlatFromButton(button);
      // Faire défiler vers le formulaire de modification
      window.scrollTo({ top: editFormSection.offsetTop - 80, behavior: 'smooth' });
    }
  }

  // Fonction pour éditer un plat depuis un bouton
  function editPlatFromButton(button) {
    const platId = button.getAttribute('data-plat-id');
    const platNom = button.getAttribute('data-plat-nom');
    const platRecetteJson = button.getAttribute('data-plat-recette');
    
    // Remplir le formulaire avec les données existantes
    document.getElementById('edit_plat_id').value = platId;
    document.getElementById('edit_nom').value = platNom;

    // Vider le conteneur d'ingrédients d'édition avant de le remplir
    const editIngredientsContainer = document.getElementById('editIngredientsContainer');
    editIngredientsContainer.innerHTML = '';

    // Ajouter les lignes d'ingrédients existantes
    if (platRecetteJson) {
      const platRecette = JSON.parse(platRecetteJson);
      if (platRecette.length > 0) {
        platRecette.forEach(ligne => {
          addIngredientEdit(ligne.ingredient_id, ligne.quantite_par_portion, ligne.categorie_id);
        });
      } else {
        addIngredientEdit(); // Ajouter une ligne vide si pas de recette
      }
    } else {
      addIngredientEdit(); // Ajouter une ligne vide si pas de recette
    }
  }

  // Fonction pour effacer le formulaire d'ajout
  function clearAddForm() {
    document.getElementById('addMenuFormCard').querySelector('form').reset();
  }

  // Fonction pour effacer le formulaire de modification
  function clearEditForm() {
    document.getElementById('editFormSection').querySelector('form').reset();
  }

  // Gestion des modals et des checkboxes
  document.addEventListener('DOMContentLoaded', function() {
    // Afficher le formulaire d'ajout par défaut
    const addForm = document.getElementById('addMenuFormCard');
    const editForm = document.getElementById('editFormSection');
    if (addForm) {
      addForm.style.display = 'block';
      isAddFormVisible = true;
    }
    if (editForm) {
      editForm.style.display = 'none';
      isEditFormVisible = false;
    }
    // Gestion de la checkbox "Sélectionner tout"
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function() {
        const rowCheckboxes = document.querySelectorAll('.row-check');
        rowCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });
    }

    // Gestion des checkboxes individuelles
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('row-check')) {
        const rowCheckboxes = document.querySelectorAll('.row-check');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (selectAllCheckbox) {
          const checkedCount = Array.from(rowCheckboxes).filter(cb => cb.checked).length;
          const totalCount = rowCheckboxes.length;
          
          if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
          } else if (checkedCount === totalCount) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
          } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
          }
        }
      }
    });

    
    // Modal de suppression
    const modalDeletePlat = document.getElementById('modalDeletePlat');
    if (modalDeletePlat) {
      modalDeletePlat.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const platId = button.getAttribute('data-plat-id');
        const platNom = button.getAttribute('data-plat-nom');
        
        document.getElementById('delete_plat_id').value = platId;
        document.getElementById('delete_plat_nom').textContent = platNom;
      });
    }
    

  });

  // Pour la recherche AJAX (à adapter avec les vues Django)
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('platsSearch');
    const platsTable = document.getElementById('plats-table');
    let searchTimeout = null;
    let lastQuery = searchInput.value;
    let controller = null;

    if (searchInput && platsTable) {
      function performSearch(query) {
        if (controller) {
          controller.abort();
        }
        controller = new AbortController();
        
        // Afficher un indicateur de chargement
        platsTable.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Recherche en cours...</td></tr>';
        
        // Construire l'URL de recherche
        const searchUrl = window.location.pathname + '?q=' + encodeURIComponent(query);
                                
        fetch(searchUrl, {
          headers: { 
            'X-Requested-With': 'XMLHttpRequest',
            'Cache-Control': 'no-cache'
          },
          signal: controller.signal
        })
        .then(response => {
          if (!response.ok) {
            if (response.status === 500) {
              throw new Error('Erreur serveur: Problème interne du serveur');
            } else {
              throw new Error('Erreur réseau: ' + response.status);
            }
          }
          return response.text();
        })
        .then(html => {
          platsTable.innerHTML = html;
        })
        .catch(error => {
          if (error.name !== 'AbortError') {
            console.error('Erreur de recherche:', error);
            platsTable.innerHTML = '<tr><td colspan="6" class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Erreur lors de la recherche: ' + error.message + '</td></tr>';
          }
        });
      }

      searchInput.addEventListener('input', function() {
        const query = searchInput.value.trim();
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // Si la recherche est vide et qu'il y avait une recherche précédente, recharger les données
        if (!query && lastQuery) {
          lastQuery = '';
          // Au lieu de recharger la page, recharger les données
          performSearch('');
          return;
        }
        
        if (query === lastQuery) return;
        lastQuery = query;
        
        if (query) {
          searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 300);
        } else {
          // Si la recherche est vide, recharger les données initiales
          performSearch('');
        }
      });

      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }
          const query = searchInput.value.trim();
          if (query) {
            performSearch(query);
          }
        }
      });
    }
  });

  // Initialiser les filtres de catégorie pour les lignes existantes
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.categorie-select').forEach(select => {
      if (select.value) {
        filterIngredients(select);
      }
    });
  });

  // Optional: trigger search immediately if field has initial value
  if (document.getElementById('platsSearch') && document.getElementById('platsSearch').value.trim()) {
    const evt = new Event('input');
    document.getElementById('platsSearch').dispatchEvent(evt);
  }
</script>
{% endblock %}