{% extends "base.html" %}

{% block title %}Gestion des Entretiens{% endblock %}

{% block menu %}
  {% include "menu_parcauto.html" %}
{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<div class="content">
<style>
  /* Calendar styling */
  #compact-calendar {
    max-width: 100%;
    margin: 0 auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    background: #ffffff;
  }
  
  /* Calendar header styling */
  .fc-header-toolbar {
    background: #1c86ee;
    color: white;
    padding: 15px 20px;
    margin-bottom: 0 !important;
  }
  
  .fc-toolbar-title {
    font-size: 1.4em;
    font-weight: 600;
    color: white !important;
  }
  
  .fc-button-primary {
    background: rgba(255,255,255,0.2) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    color: white !important;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .fc-button-primary:hover,
  .fc-button-primary:not(:disabled):active {
    background: rgba(255,255,255,0.3) !important;
    border-color: rgba(255,255,255,0.4) !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .fc-button-primary:disabled {
    opacity: 0.5;
    background: rgba(255,255,255,0.1) !important;
  }
  
  /* Calendar body styling */
  .fc-theme-standard .fc-scrollgrid {
    border: none;
  }
  
  .fc-theme-standard td, 
  .fc-theme-standard th {
    border-color: #e9ecef;
  }
  
  .fc-col-header {
    background: #f8f9fa;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
    color: #495057;
  }
  
  .fc-col-header-cell {
    padding: 12px 8px;
  }
  
  .fc-daygrid-day {
    transition: background-color 0.2s ease;
  }
  
  .fc-daygrid-day:hover {
    background-color: #f8f9fa;
  }
  
  .fc-day-today {
    background-color: rgba(102, 126, 234, 0.1) !important;
  }
  
  .fc-daygrid-day-number {
    font-weight: 500;
    color: #495057;
    padding: 8px;
  }
  
  /* Event styling */
  .fc-daygrid-event {
    font-size: 0.8em;
    padding: 4px 8px;
    margin: 2px 4px;
    border-radius: 6px;
    border: none !important;
    font-weight: 500;
    white-space: normal;
    word-break: break-word;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .fc-daygrid-event:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  .fc-event-title {
    font-weight: 500;
  }
  
  /* Event colors */
  .fc-event[data-status="planifié"] {
    background: linear-gradient(135deg, #3498db, #2980b9) !important;
    color: white;
  }
  
  .fc-event[data-status="effectué"] {
    background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
    color: white;
  }
  
  .fc-event[data-status="en_retard"] {
    background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
    color: white;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
  
  /* Status badges */
  .badge {
    padding: 0.3em 0.6em;
    font-size: 0.75em;
    border-radius: 6px;
    font-weight: 500;
  }
  
  .bg-planned { 
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
  }
  
  .bg-completed { 
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
  }
  
  .bg-late { 
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
  }
  

  
  /* Calendar legend */
  .calendar-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 0.85em;
    font-weight: 500;
  }
  
  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .legend-color.planned {
    background: linear-gradient(135deg, #3498db, #2980b9);
  }
  
  .legend-color.completed {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
  }
  
  .legend-color.late {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
  }
  
  /* Responsive adjustments for calendar */
  @media (max-width: 768px) {
    .fc-toolbar {
      flex-direction: column;
      gap: 10px;
    }
    
    .fc-toolbar-chunk {
      display: flex;
      justify-content: center;
    }
    
    .calendar-legend {
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
  }
</style>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
        <i class="fas fa-{% if message.tags == 'error' %}times-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} me-2 fw-bold"></i>
        <div><strong>{% if message.tags == 'error' %}Erreur :{% elif message.tags == 'success' %}Succès :{% elif message.tags == 'warning' %}Attention :{% else %}Information :{% endif %}</strong> {{ message }}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
      </div>
    {% endfor %}
  {% endif %}

  <ul class="nav nav-tabs mb-3" id="entretienTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar-tab-pane" type="button">
        <i class="fas fa-calendar-alt"></i> Calendrier
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-tab-pane" type="button">
        <i class="fas fa-list"></i> Liste
      </button>
    </li>
  </ul>

  <div class="tab-content" id="entretienTabsContent">
    <!-- Calendar Tab -->
    <div class="tab-pane fade" id="calendar-tab-pane" role="tabpanel">
      <!-- Calendar Legend -->
      <div class="calendar-legend">
        <div class="legend-item">
          <div class="legend-color planned"></div>
          <span>Planifié</span>
        </div>
        <div class="legend-item">
          <div class="legend-color completed"></div>
          <span>Effectué</span>
        </div>
        <div class="legend-item">
          <div class="legend-color late"></div>
          <span>En retard</span>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Calendrier des Entretiens</h5>
        </div>
        <div class="card-body">
          <div id="compact-calendar"></div>
        </div>
      </div>
    </div>

    <!-- Table Tab -->
    <div class="tab-pane fade show active" id="table-tab-pane" role="tabpanel">
      <!-- Table Header Component -->
      <div class="card mb-4">
        <div class="card-header text-white" style="background-color: #1e90ff;">
          <i class="fas fa-wrench me-2"></i>
          Liste des Entretiens
        </div>
        <div class="card-body">
          <form method="get" id="search-form">
            <div class="row g-2 mb-3">
              <!-- Barre de recherche -->
              <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
                <div class="input-group">
                  <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="search" name="q" id="searchMatricule" class="form-control border-primary" 
                         placeholder="Rechercher par véhicule..." value="{{ request.GET.q }}">
                </div>
              </div>
              <!-- Filtre type -->
              <div class="col-8 col-sm-8 col-md-3 col-lg-3 order-2">
                <select name="type" id="filterType" class="form-select" title="Filtrer par type">
                  <option value="">Tous les types</option>
                  {% for type in types_entretien %}
                    <option value="{{ type.id }}" {% if request.GET.type == type.id|stringformat:"s" %}selected{% endif %}>{{ type.nom }}</option>
                  {% endfor %}
                </select>
              </div>
              <!-- Filtre statut -->
              <div class="col-4 col-sm-4 col-md-2 col-lg-2 order-3">
                <select name="status" id="filterStatus" class="form-select" title="Filtrer par statut">
                  <option value="">Tous statuts</option>
                  {% for statut in statuts_entretien %}
                    <option value="{{ statut.0 }}" {% if request.GET.status == statut.0 %}selected{% endif %}>{{ statut.1 }}</option>
                  {% endfor %}
                </select>
              </div>
              <!-- Boutons d'action -->
              <div class="col-12 col-sm-12 col-md-2 col-lg-2 order-4">
                <div class="d-flex gap-1">
                  <button type="button" class="btn w-100 text-nowrap px-2 text-white" style="background-color: #1e90ff;" id="toggleFormBtn">
                    <i class="fas fa-plus"></i>
                    <span class="d-none d-lg-inline ms-1">Nouveau</span>
                  </button>
                </div>
              </div>
            </div>
          </form>



        <!-- Table Component -->
        <div class="table-container">
          <table class="table table-striped table-hover" id="searchableTable">
            <thead class="table-light borderless">
              <tr class="main-row">
                <th class="d-none d-md-table-cell">
                  <input type="checkbox" id="selectAll">
                </th>
                <th>
                  <div class="d-flex align-items-center">
                    <span>Véhicule</span>
                    <i class="fas fa-sort ms-1 text-muted"></i>
                  </div>
                </th>
                <th class="d-none d-md-table-cell">Type</th>
                <th class="d-none d-md-table-cell">Date planifiée</th>
                <th class="d-none d-md-table-cell">Statut</th>
                <th class="d-none d-md-table-cell">Remarque</th>
                <th class="d-none d-md-table-cell">Pièce jointe</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for entretien in entretiens %}
              <tr class="main-row" data-type-id="{{ entretien.type_entretien.id }}" data-status="{{ entretien.StatutEntretien }}">
                <td class="d-none d-md-table-cell">
                  <input type="checkbox" class="row-check">
                </td>
                <td>{{ entretien.vehicle.immatriculation }}</td>
                <td class="d-none d-md-table-cell">{{ entretien.type_entretien.nom }}</td>
                <td class="d-none d-md-table-cell">{{ entretien.date_planifiee|date:"d/m/Y" }}</td>
                <td class="d-none d-md-table-cell">
                  <span class="badge bg-{% if entretien.StatutEntretien == 'planifié' %}primary{% elif entretien.StatutEntretien == 'effectué' %}success{% elif entretien.StatutEntretien == 'en_retard' %}danger{% endif %}">
                    {{ entretien.StatutEntretien }}
                  </span>
                </td>
                <td class="d-none d-md-table-cell">{{ entretien.remarque|truncatechars:20|default:"-" }}</td>
                <td class="d-none d-md-table-cell">
                  {% if entretien.piece_jointe %}
                    <a href="{{ entretien.piece_jointe.url }}" class="btn btn-sm btn-light border text-info" target="_blank" title="Télécharger">
                      <i class="fas fa-file-download"></i>
                    </a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <button class="btn btn-sm btn-primary d-md-none" data-bs-toggle="collapse" data-bs-target="#details-{{ entretien.id }}">
                    Voir détails
                  </button>
                  <div class="d-none d-md-flex gap-1 justify-content-end">
                    <button class="btn btn-sm btn-light border text-dark" title="Modifier"
                            data-id="{{ entretien.id }}"
                            data-vehicule="{{ entretien.vehicle.id }}"
                            data-type="{{ entretien.type_entretien.id }}"
                            data-date-planifiee="{{ entretien.date_planifiee|date:'Y-m-d' }}"
                            data-statut="{{ entretien.StatutEntretien }}"
                            data-remarque="{{ entretien.remarque }}"
                            onclick="openEditForm(this)">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-light border text-danger" title="Supprimer"
                            data-bs-toggle="modal" 
                            data-bs-target="#modalDeleteEntretien"
                            data-id="{{ entretien.id }}">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr class="collapse bg-light" id="details-{{ entretien.id }}">
                <td colspan="8" class="p-3">
                  <div class="row">
                    <div class="col-6">
                      <p class="mb-2"><strong>Type:</strong> {{ entretien.type_entretien.nom }}</p>
                      <p class="mb-2"><strong>Date planifiée:</strong> {{ entretien.date_planifiee|date:"d/m/Y" }}</p>
                      <p class="mb-2"><strong>Statut:</strong> 
                        <span class="badge bg-{% if entretien.StatutEntretien == 'planifié' %}primary{% elif entretien.StatutEntretien == 'effectué' %}success{% elif entretien.StatutEntretien == 'en_retard' %}danger{% endif %}">
                          {{ entretien.StatutEntretien }}
                        </span>
                      </p>
                    </div>
                    <div class="col-6">
                      <p class="mb-2"><strong>Remarque:</strong> {{ entretien.remarque|default:"-" }}</p>
                      <p class="mb-2"><strong>Pièce jointe:</strong> 
                        {% if entretien.piece_jointe %}
                          <a href="{{ entretien.piece_jointe.url }}" class="btn btn-sm btn-info text-white" target="_blank">
                            <i class="fas fa-file-download me-1"></i> Télécharger
                          </a>
                        {% else %}
                          <span class="text-muted">Aucun fichier</span>
                        {% endif %}
                      </p>
                    </div>
                    <div class="col-12 mt-3">
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-dark" title="Modifier"
                                data-id="{{ entretien.id }}"
                                data-vehicule="{{ entretien.vehicle.id }}"
                                data-type="{{ entretien.type_entretien.id }}"
                                data-date-planifiee="{{ entretien.date_planifiee|date:'Y-m-d' }}"
                                data-statut="{{ entretien.StatutEntretien }}"
                                data-remarque="{{ entretien.remarque }}"
                                onclick="openEditForm(this)">
                          <i class="fas fa-edit me-1"></i> Modifier
                        </button>
                        <button class="btn btn-sm btn-danger" title="Supprimer"
                                data-bs-toggle="modal" 
                                data-bs-target="#modalDeleteEntretien"
                                data-id="{{ entretien.id }}">
                          <i class="fas fa-trash-alt me-1"></i> Supprimer
                        </button>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center py-4">
                  <i class="fas fa-wrench fa-3x text-muted mb-3"></i>
                  <p class="text-muted">Aucun entretien enregistré</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination Component -->
        {% if entretiens.has_other_pages %}
        <nav class="mt-3">
          <ul class="pagination justify-content-center flex-wrap">
            {% if entretiens.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ entretiens.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.items_per_page %}&items_per_page={{ request.GET.items_per_page }}{% endif %}" aria-label="Précédent">
                  <i class="fas fa-chevron-left d-block d-sm-none"></i>
                  <span class="d-none d-sm-block">&laquo; Préc</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">
                  <i class="fas fa-chevron-left d-block d-sm-none"></i>
                  <span class="d-none d-sm-block">&laquo; Préc</span>
                </span>
              </li>
            {% endif %}

            {% for num in entretiens.paginator.page_range %}
              {% if entretiens.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > entretiens.number|add:'-3' and num < entretiens.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.items_per_page %}&items_per_page={{ request.GET.items_per_page }}{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if entretiens.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ entretiens.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.items_per_page %}&items_per_page={{ request.GET.items_per_page }}{% endif %}" aria-label="Suivant">
                  <i class="fas fa-chevron-right d-block d-sm-none"></i>
                  <span class="d-none d-sm-block">Suiv &raquo;</span>
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">
                  <i class="fas fa-chevron-right d-block d-sm-none"></i>
                  <span class="d-none d-sm-block">Suiv &raquo;</span>
                </span>
              </li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Formulaire d'ajout inline - Card séparée -->
  <div class="card mt-4" id="addFormCard">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-plus-circle me-2"></i>
      Ajouter un Entretien
    </div>
    <div class="card-body">
      <form id="addEntretienForm" method="post" action="{% url 'entretien' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_entretien">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Véhicule <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-car"></i></span>
                <select class="form-select" name="vehicule" required>
                  <option value="" selected disabled>-- Sélectionner un véhicule --</option>
                  {% for v in vehicules %}
                  <option value="{{ v.id }}">{{ v.immatriculation }} ({{ v.marque.nom }} {{ v.modele.nom }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Type d'Entretien <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-wrench"></i></span>
                <select class="form-select" name="type_entretien" required>
                  <option value="" selected disabled>-- Sélectionner un type --</option>
                  {% for type in types_entretien %}
                  <option value="{{ type.id }}">{{ type.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Pièce jointe</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-paperclip"></i></span>
                <input type="file" class="form-control" name="piece_jointe" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Date Planifiée <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <input type="date" class="form-control" name="date_planifiee" required>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Statut <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                <select name="statut" class="form-select" required>
                  {% for statut in statuts_entretien %}
                  <option value="{{ statut.0 }}" {% if statut.0 == 'planifié' %}selected{% endif %}>{{ statut.1 }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Remarque</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-comment"></i></span>
                <textarea class="form-control" name="remarque" rows="3" placeholder="Remarques sur l'entretien..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-secondary" id="cancelFormBtn">
                <i class="fas fa-times me-2"></i>Annuler
              </button>
              <button type="submit" class="btn text-white" style="background-color: #1e90ff;">
                <i class="fas fa-save me-2"></i>Enregistrer
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Formulaire de modification inline - Card séparée -->
  <div class="card mt-4" id="editFormCard" style="display: none;">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-edit me-2"></i>
      Modifier l'Entretien
    </div>
    <div class="card-body">
      <form id="editEntretienForm" method="post" action="{% url 'entretien' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit_entretien">
        <input type="hidden" name="entretien_id" id="edit_entretien_inline_id">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Véhicule <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-car"></i></span>
                <select class="form-select" id="edit_inline_vehicule" name="vehicule" required>
                  <option value="" disabled>-- Sélectionner un véhicule --</option>
                  {% for v in vehicules %}
                  <option value="{{ v.id }}">{{ v.immatriculation }} ({{ v.marque.nom }} {{ v.modele.nom }})</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Type d'Entretien <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-wrench"></i></span>
                <select class="form-select" id="edit_inline_type" name="type_entretien" required>
                  <option value="" disabled>-- Sélectionner un type --</option>
                  {% for t in types_entretien %}
                  <option value="{{ t.id }}">{{ t.nom }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Date Planifiée <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                <input type="date" class="form-control" id="edit_inline_date" name="date_planifiee" required>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-semibold">Statut <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-info-circle"></i></span>
                <select id="edit_inline_statut" name="statut" class="form-select" required>
                  {% for statut in statuts_entretien %}
                  <option value="{{ statut.0 }}">{{ statut.1 }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Remarque</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-comment"></i></span>
                <textarea class="form-control" id="edit_inline_remarque" name="remarque" rows="3" placeholder="Remarques sur l'entretien..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12">
            <div class="mb-3">
              <label class="form-label fw-semibold">Pièce jointe</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-paperclip"></i></span>
                <input type="file" class="form-control" name="piece_jointe" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="d-flex gap-2 justify-content-end">
              <button type="button" class="btn btn-secondary" onclick="hideEditForm()">
                <i class="fas fa-times me-2"></i>Annuler
              </button>
              <button type="submit" class="btn text-white" style="background-color: #1e90ff;">
                <i class="fas fa-save me-2"></i>Modifier
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
    </div>



<!-- Edit Modal removed: replaced by inline edit card -->

<!-- Delete Modal -->
<div class="modal fade" id="modalDeleteEntretien" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'entretien' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_entretien">
        <input type="hidden" name="entretien_id" id="delete_entretien_id">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle me-2"></i>Confirmer la suppression
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fas fa-exclamation-triangle me-2 fw-bold"></i>
            <div>
              <strong>Attention :</strong> Êtes-vous sûr de vouloir supprimer cet entretien ?
            </div>
          </div>
          <p class="text-danger mb-0"><i class="fas fa-times-circle me-1"></i>Cette action est irréversible.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Annuler
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt me-1"></i>Supprimer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Gestion du formulaire inline
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const addFormCard = document.getElementById('addFormCard');
  const editFormCard = document.getElementById('editFormCard');
  const cancelFormBtn = document.getElementById('cancelFormBtn');
  const addEntretienForm = document.getElementById('addEntretienForm');

  if (toggleFormBtn && addFormCard) {
    toggleFormBtn.addEventListener('click', function() {
      if (addFormCard.style.display === 'none') {
        addFormCard.style.display = 'block';
        addFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        toggleFormBtn.innerHTML = '<i class="fas fa-times"></i><span class="d-none d-lg-inline ms-1">Annuler</span>';
        toggleFormBtn.classList.remove('btn-secondary');
        toggleFormBtn.classList.add('btn-secondary');
      } else {
        addFormCard.style.display = 'none';
        toggleFormBtn.innerHTML = '<i class="fas fa-plus"></i><span class="d-none d-lg-inline ms-1">Nouveau</span>';
        toggleFormBtn.classList.remove('btn-secondary');
        toggleFormBtn.classList.add('btn-secondary');
        toggleFormBtn.style.backgroundColor = '#1e90ff';
        toggleFormBtn.style.color = 'white';
        addEntretienForm.reset();
      }
    });
  }
  // Inline edit handlers
  window.openEditForm = function(btn) {
    if (addFormCard) addFormCard.style.display = 'none';
    if (editFormCard) {
      // Populate fields
      document.getElementById('edit_entretien_inline_id').value = btn.getAttribute('data-id');
      document.getElementById('edit_inline_vehicule').value = btn.getAttribute('data-vehicule');
      document.getElementById('edit_inline_type').value = btn.getAttribute('data-type');
      document.getElementById('edit_inline_date').value = btn.getAttribute('data-date-planifiee');
      document.getElementById('edit_inline_statut').value = btn.getAttribute('data-statut');
      document.getElementById('edit_inline_remarque').value = btn.getAttribute('data-remarque') || '';

      // Min date for planned date
      const minDate = new Date().toISOString().split('T')[0];
      document.getElementById('edit_inline_date').setAttribute('min', minDate);

      editFormCard.style.display = 'block';
      editFormCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  window.hideEditForm = function() {
    if (editFormCard) {
      editFormCard.style.display = 'none';
    }
    if (addFormCard) addFormCard.style.display = 'block';
  }

  if (cancelFormBtn && addFormCard && toggleFormBtn) {
    cancelFormBtn.addEventListener('click', function() {
      addFormCard.style.display = 'none';
      toggleFormBtn.innerHTML = '<i class="fas fa-plus"></i><span class="d-none d-lg-inline ms-1">Nouveau</span>';
      toggleFormBtn.classList.remove('btn-secondary');
      toggleFormBtn.classList.add('btn-secondary');
      toggleFormBtn.style.backgroundColor = '#1e90ff';
      toggleFormBtn.style.color = 'white';
      addEntretienForm.reset();
    });
  }

  // Enhanced Calendar initialization with dynamic dates
  const calendarEl = document.getElementById('compact-calendar');
  
  // Prepare events data
  const eventsData = [
    {% for entretien in entretiens.paginator.object_list %}
    {
      id: '{{ entretien.id|escapejs }}',
      title: '{{ entretien.vehicle.immatriculation|escapejs }} - {{ entretien.type_entretien.nom|truncatechars:15|escapejs }}',
      start: '{{ entretien.date_planifiee|date:"Y-m-d" }}',
      allDay: true,
      backgroundColor: '{% if entretien.StatutEntretien == "planifié" %}#3498db{% elif entretien.StatutEntretien == "effectué" %}#2ecc71{% else %}#e74c3c{% endif %}',
      borderColor: '{% if entretien.StatutEntretien == "planifié" %}#2980b9{% elif entretien.StatutEntretien == "effectué" %}#27ae60{% else %}#c0392b{% endif %}',
      textColor: '#ffffff',
      extendedProps: {
        status: '{{ entretien.StatutEntretien|escapejs }}',
        statusKey: '{{ entretien.StatutEntretien|escapejs }}',
        type: '{{ entretien.type_entretien.nom|escapejs }}',
        vehicule: '{{ entretien.vehicle.immatriculation|escapejs }}',
        remarque: '{{ entretien.remarque|default:""|escapejs }}',
        isOverdue: {% if entretien.StatutEntretien == 'en_retard' %}true{% else %}false{% endif %}
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'fr',
    height: 'auto',
    aspectRatio: 1.8,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listMonth'
    },
    buttonText: {
      today: 'Aujourd\'hui',
      month: 'Mois',
      week: 'Semaine',
      list: 'Liste'
    },
    events: eventsData,
    eventDidMount: function(info) {
      info.el.setAttribute('data-status', info.event.extendedProps.statusKey);
      
      if (info.event.extendedProps.isOverdue) {
        info.el.classList.add('overdue-event');
      }
      
      info.el.title = `${info.event.extendedProps.vehicule} - ${info.event.extendedProps.type}\nStatut: ${info.event.extendedProps.status}`;
    },
    eventClick: function(info) {
      const event = info.event;
      const props = event.extendedProps;
      
      let statusIcon = '';
      let statusColor = '';
      
      switch(props.statusKey) {
        case 'planifié':
          statusIcon = 'fas fa-clock';
          statusColor = '#3498db';
          break;
        case 'effectué':
          statusIcon = 'fas fa-check-circle';
          statusColor = '#2ecc71';
          break;
        case 'en_retard':
          statusIcon = 'fas fa-exclamation-triangle';
          statusColor = '#e74c3c';
          break;
      }
      
      let html = `
        <div class="event-details" style="text-align: left;">
          <div class="mb-3">
            <h6 style="color: #495057; margin-bottom: 8px;"><i class="fas fa-car me-2"></i>Véhicule</h6>
            <p style="font-weight: 600; margin: 0; color: #212529;">${props.vehicule}</p>
          </div>
          
          <div class="mb-3">
            <h6 style="color: #495057; margin-bottom: 8px;"><i class="fas fa-wrench me-2"></i>Type d'entretien</h6>
            <p style="font-weight: 500; margin: 0; color: #212529;">${props.type}</p>
          </div>
          
          <div class="mb-3">
            <h6 style="color: #495057; margin-bottom: 8px;"><i class="fas fa-calendar me-2"></i>Date planifiée</h6>
            <p style="font-weight: 500; margin: 0; color: #212529;">${event.start.toLocaleDateString('fr-FR', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}</p>
          </div>
          
          <div class="mb-3">
            <h6 style="color: #495057; margin-bottom: 8px;"><i class="${statusIcon} me-2"></i>Statut</h6>
            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 6px; font-weight: 500; font-size: 0.9em;">
              ${props.status}
            </span>
          </div>
      `;
      
      if (props.remarque && props.remarque.trim() !== '') {
        html += `
          <div class="mb-3">
            <h6 style="color: #495057; margin-bottom: 8px;"><i class="fas fa-comment me-2"></i>Remarque</h6>
            <p style="font-style: italic; margin: 0; color: #6c757d;">${props.remarque}</p>
          </div>`;
      }
      
      html += `</div>`;
      
      Swal.fire({
        title: '<i class="fas fa-info-circle me-2"></i>Détails de l\'entretien',
        html: html,
        confirmButtonText: 'Fermer',
        confirmButtonColor: '#667eea',
        width: '500px',
        customClass: {
          popup: 'event-details-popup'
        }
      });
    },
    dayMaxEvents: 3,
    moreLinkClick: 'popover',
    eventDisplay: 'block',
    eventTimeFormat: { 
      hour: '2-digit',
      minute: '2-digit',
      meridiem: false
    },
    dayCellDidMount: function(info) {
      const today = new Date();
      const cellDate = info.date;
      
      if (cellDate.toDateString() === today.toDateString()) {
        info.el.classList.add('fc-day-today');
      }
      
      const events = calendar.getEvents();
      const hasOverdueEvent = events.some(event => 
        event.start && 
        event.start.toDateString() === cellDate.toDateString() && 
        event.extendedProps.isOverdue
      );
      
      if (hasOverdueEvent) {
        info.el.style.backgroundColor = 'rgba(231, 76, 60, 0.05)';
      }
    },
    datesSet: function(info) {
      console.log('Calendar view changed:', info.start, 'to', info.end);
    }
  });
  
  calendar.render();

  // Edit modal population removed (now inline)

  // Delete modal population
  const deleteModal = document.getElementById('modalDeleteEntretien');
  if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      document.getElementById('delete_entretien_id').value = button.getAttribute('data-id');
    });
  }

  // Table filtering
  const searchInput = document.getElementById('searchMatricule');
  const filterType = document.getElementById('filterType');
  const filterStatus = document.getElementById('filterStatus');
  const tableRows = document.querySelectorAll('#searchableTable tbody tr.main-row');

  function filterTable() {
    const searchText = searchInput.value.trim().toLowerCase();
    const selectedType = filterType.value;
    const selectedStatus = filterStatus.value;

    tableRows.forEach(row => {
      const vehicleText = row.cells[1]?.textContent.toLowerCase() || '';
      const typeId = row.getAttribute('data-type-id');
      const status = row.getAttribute('data-status');
      
      const matchesSearch = vehicleText.includes(searchText);
      const matchesType = selectedType === '' || typeId === selectedType;
      const matchesStatus = selectedStatus === '' || status === selectedStatus;
      
      if (matchesSearch && matchesType && matchesStatus) {
        row.style.display = '';
        // Afficher aussi la ligne de détails si elle existe
        const detailsRow = row.nextElementSibling;
        if (detailsRow && detailsRow.classList.contains('collapse')) {
          detailsRow.style.display = '';
        }
      } else {
        row.style.display = 'none';
        // Masquer aussi la ligne de détails si elle existe
        const detailsRow = row.nextElementSibling;
        if (detailsRow && detailsRow.classList.contains('collapse')) {
          detailsRow.style.display = 'none';
        }
      }
    });
  }

  if (searchInput) {
    searchInput.addEventListener('input', filterTable);
  }
  if (filterType) {
    filterType.addEventListener('change', filterTable);
  }
  if (filterStatus) {
    filterStatus.addEventListener('change', filterTable);
  }

  // Gestion du select all
  const selectAllCheckbox = document.getElementById('selectAll');
  const rowCheckboxes = document.querySelectorAll('.row-check');

  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      rowCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });
  }

  // Mise à jour du select all quand les checkboxes individuelles changent
  rowCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
      const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
      
      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    });
  });

  // Tab switching with calendar re-render
  const calendarTab = document.getElementById('calendar-tab');
  const listTab = document.getElementById('table-tab');
  if (calendarTab) {
    calendarTab.addEventListener('shown.bs.tab', function() {
      // Masquer les formulaires quand on passe sur l'onglet Calendrier
      const addCard = document.getElementById('addFormCard');
      const editCard = document.getElementById('editFormCard');
      if (addCard) addCard.style.display = 'none';
      if (editCard) editCard.style.display = 'none';

      setTimeout(() => {
        calendar.updateSize();
        calendar.render();
      }, 100);
    });
  }

  if (listTab) {
    listTab.addEventListener('shown.bs.tab', function() {
      // Ne rien afficher automatiquement. Les formulaires restent cachés
      // jusqu'à ce que l'utilisateur clique sur Nouveau/Modifier.
      const addCard = document.getElementById('addFormCard');
      const editCard = document.getElementById('editFormCard');
      if (addCard && addCard.dataset.forceShow === 'true') addCard.style.display = 'block';
      if (editCard && editCard.dataset.forceShow === 'true') editCard.style.display = 'block';
    });
  }

  // Set minimum date for date inputs to today
  const today = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[name="date_planifiee"]').forEach(input => {
    input.setAttribute('min', today);
  });

  // Form validation enhancement
  document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
      const dateInput = form.querySelector('input[name="date_planifiee"]');
      if (dateInput && dateInput.value) {
        const selectedDate = new Date(dateInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
          e.preventDefault();
          Swal.fire({
            title: 'Date invalide',
            text: 'La date planifiée ne peut pas être antérieure à aujourd\'hui.',
            icon: 'warning',
            confirmButtonText: 'Compris',
            confirmButtonColor: '#f39c12'
          });
        }
      }
    });
  });

  // Items per page selector
  const itemsPerPageSelect = document.getElementById('items-per-page');
  if (itemsPerPageSelect) {
    itemsPerPageSelect.addEventListener('change', function() {
      const urlParams = new URLSearchParams(window.location.search);
      urlParams.set('items_per_page', this.value);
      urlParams.set('page', '1'); // Reset to first page
      window.location.search = urlParams.toString();
    });
  }
});

// Additional CSS for enhanced styling
const additionalStyles = `
  .overdue-event {
    animation: pulse 2s infinite;
  }
  
  .event-details-popup {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  .swal2-popup {
    border-radius: 15px;
  }
  
  .fc-more-link {
    color: #667eea !important;
    font-weight: 500;
  }
  
  .fc-popover {
    border-radius: 10px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border: none;
  }
  
  .fc-popover-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
  }
`;

const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);
</script>

{% endblock %}