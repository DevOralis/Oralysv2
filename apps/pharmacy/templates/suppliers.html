{% extends 'base.html' %}

{% load static %}

{% block menu %}
  {% include 'pharmacy_menu.html' %}
{% endblock %}

{% block content %}
<div class="content">
  <h3 class="border-bottom pb-2">
    <i class="fas fa-truck-fast text-primary me-2"></i>
    Gestion des fournisseurs - Pharmacie
  </h3>
  <!-- Liste des fournisseurs -->
  <div class="card mb-4">
    <div class="card-header card-header-primary" style="background-color: #1e90ff; color: white;">
      <i class="fas fa-solid fa-store me-2"></i>
      Liste des fournisseurs
    </div>
    <div class="card-body">
      <!-- Alert Container -->
      <div id="alert-container" class="mb-3"></div>

      <!-- Search and Filter Form -->
      <form id="filter-form" method="get" class="mb-3">
        <div class="row g-2 mb-3">
          <!-- Barre de recherche -->
          <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
            <div class="input-group">
              <span class="input-group-text input-group-text-primary" style="background-color: #1e90ff; border: 1px solid #1e90ff;">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" name="q" id="searchInput" class="form-control search-input-primary" style="border: 1px solid #1e90ff;" placeholder="Recherche par nom, email, téléphone, adresse, ville..." value="{{ request.GET.q }}">
            </div>
          </div>
          <!-- Filtre par ville -->
          <div class="col-12 col-sm-6 col-md-3 col-lg-3 order-2">
            <select id="cityFilter" name="city" class="form-select" title="Ville">
              <option value="">Toutes les villes</option>
              {% for city in cities %}
              <option value="{{ city.name }}" {% if request.GET.city == city.name %}selected{% endif %}>{{ city.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Boutons d'action -->
          <div class="col-12 col-sm-6 col-md-4 col-lg-4 order-3">
            <div class="d-flex justify-content-end gap-2">
              <button type="button" id="import-export-btn" class="btn btn-light border w-100 text-nowrap px-2">
                <i class="fas fa-file-import"></i>
                <span class="d-none d-lg-inline ms-1">Importer</span>
              </button>
              {% if request.session.user.permissions.pharmacy.write %}
              <button type="button" id="scrollToForm" class="btn btn-primary w-100">
                <i class="fas fa-plus me-1"></i>
                <span class="d-none d-lg-inline">Nouveau</span>
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </form>

      <!-- Table -->
      <table class="table table-responsive table-striped table-hover" id="searchableTable">
        <thead class="table-light borderless">
          <tr class="main-row">
            <th style="width: 1%;"><input type="checkbox" id="select-all-checkbox" title="Sélectionner tout"></th>
            <th>
              <div class="d-flex align-items-center">
                <span>Logo</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th>
              <div class="d-flex align-items-center">
                <span>Nom</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th>
              <div class="d-flex align-items-center">
                <span>Email</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th>
              <div class="d-flex align-items-center">
                <span>Téléphone</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell">
              <div class="d-flex align-items-center">
                <span>Adresse</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell">
              <div class="d-flex align-items-center">
                <span>Ville</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="supplierTable">
          {% include '_suppliers_table.html' %}
        </tbody>
      </table>

      <!-- Pagination Component -->
      <nav class="mt-3" aria-label="Supplier navigation">
        <ul id="supplierPagination" class="pagination justify-content-center flex-wrap">
          <!-- Pagination items will be generated by JavaScript -->
        </ul>
      </nav>
    </div>
  </div>

  <!-- Formulaire Fournisseur -->
  {% if request.session.user.permissions.pharmacy.write %}
  <div id="formulaire-fournisseur" class="card mb-4">
    <div class="card-header card-header-primary" style="background-color: #1e90ff; color: white;">
      <i class="fas fa-edit me-2"></i>
      {% if supplier %}Modifier un {% else %}Ajouter un {% endif %} fournisseur
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="supplier-form" class="mt-3" action="{% if supplier %}{% url 'pharmacy_supplier_update' pk=supplier.pk %}{% else %}{% url 'pharmacy_supplier_create' %}{% endif %}">
        {% csrf_token %}
        <div class="row g-3">
          <!-- Nom -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_name" class="form-label">Nom</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                {{ form.name }}
              </div>
            </div>
          </div>
          <!-- Logo -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_logo" class="form-label">Logo</label>
              {% if supplier and supplier.logo %}
              <div class="mb-2">
                <img src="{{ supplier.logo.url }}" width="100" alt="Logo actuel">
              </div>
              {% endif %}
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-image"></i></span>
                {{ form.logo }}
              </div>
            </div>
          </div>
          <!-- Société -->
          <div class="col-12 col-sm-6 col-md-4">
            <label class="form-label d-block">Société ?</label>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="is_company" id="companyYes" value="True"
                {% if supplier and supplier.is_company %}checked{% endif %}>
              <label class="form-check-label" for="companyYes">Oui</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="is_company" id="companyNo" value="False"
                {% if supplier and not supplier.is_company %}checked{% endif %}>
              <label class="form-check-label" for="companyNo">Non</label>
            </div>
          </div>
          <!-- Adresse -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_street" class="form-label">Adresse</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                {{ form.street }}
              </div>
            </div>
          </div>
          <!-- Complément d'adresse -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_street2" class="form-label">Complément d'adresse</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map"></i></span>
                {{ form.street2 }}
              </div>
            </div>
          </div>
          <!-- Code Postal -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_zip_code" class="form-label">Code Postal</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-mail-bulk"></i></span>
                <input type="text" name="zip_code" class="form-control" id="id_zip_code" value="{{ form.zip_code.value|default:'' }}">
              </div>
            </div>
          </div>
          <!-- Ville -->
          <div class="col-12 col-sm-6 col-md-4">
            <label class="form-label">Ville :</label>
            <select name="city" class="form-select" title="Ville">
              <option value="">Choisir</option>
              {% for c in cities %}
              <option value="{{ c.id }}" {% if supplier and supplier.city and supplier.city.id == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Pays -->
          <div class="col-12 col-sm-6 col-md-4">
            <label class="form-label">Pays :</label>
            <select name="country" class="form-select" title="Pays">
              <option value="">Choisir</option>
              {% for c in countries %}
              <option value="{{ c.id }}" {% if supplier and supplier.country and supplier.country.id == c.id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Email -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_email" class="form-label">Email</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                {{ form.email }}
              </div>
            </div>
          </div>
          <!-- Téléphone -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_phone" class="form-label">Téléphone</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                {{ form.phone }}
              </div>
            </div>
          </div>
          <!-- Mobile -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_mobile" class="form-label">Mobile</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                {{ form.mobile }}
              </div>
            </div>
          </div>
          <!-- ICE -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_ICE" class="form-label">ICE</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                {{ form.ICE }}
              </div>
            </div>
          </div>
          <!-- RC -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_RC" class="form-label">RC</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                {{ form.RC }}
              </div>
            </div>
          </div>
          <!-- IF -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_IF" class="form-label">IF</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                {{ form.IF }}
              </div>
            </div>
          </div>
          <!-- Langue -->
          <div class="col-12 col-sm-6 col-md-4">
            <label class="form-label">Langue :</label>
            <select name="lang" class="form-select" title="Langue">
              <option value="">Choisir</option>
              {% for l in languages %}
              <option value="{{ l.id }}" {% if supplier and supplier.lang and supplier.lang.id == l.id %}selected{% endif %}>{{ l.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- VAT -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_vat" class="form-label">VAT</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                {{ form.vat }}
              </div>
            </div>
          </div>
          <!-- RIB -->
          <div class="col-12 col-sm-6 col-md-4">
            <div class="mb-3">
              <label for="id_RIB" class="form-label">RIB</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                {{ form.RIB }}
              </div>
            </div>
          </div>
          <!-- Commentaire -->
          <div class="col-12">
            <div class="mb-3">
              <label for="id_comment" class="form-label">Commentaire</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-comment"></i></span>
                {{ form.comment }}
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-2 justify-content-end mt-4">
          <button type="button" class="btn btn-secondary btn-sm" id="resetForm">
            <i class="fas fa-times"></i>
            <span class="d-none d-sm-inline ms-1">Annuler</span>
          </button>
          <button type="submit" class="btn btn-primary btn-sm" id="submitForm">
            <i class="fas fa-save"></i>
            <span class="d-none d-sm-inline ms-1">{% if supplier %}Mettre à jour{% else %}Sauvegarder{% endif %}</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Order History Modal -->
  <div class="modal fade" id="pharmacyOrderHistoryModal" tabindex="-1" aria-labelledby="pharmacyOrderHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pharmacyOrderHistoryModalLabel">Historique des commandes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Total Orders Card -->
          <div class="order-history-card">
            <h5 id="pharmacyTotalOrders">0</h5>
            <p>Commandes totales</p>
          </div>
          <!-- Turnover Card -->
          <div class="order-history-card">
            <h5 id="pharmacyTurnover">0.00 MAD</h5>
            <p>Chiffre d'affaires</p>
          </div>
          <!-- Chart -->
          <div class="chart-container">
            <canvas id="pharmacyOrdersByStateChart"></canvas>
          </div>
          <!-- Orders Table -->
          <div class="table-responsive">
            <table class="table table-bordered order-history-table">
              <thead>
                <tr>
                  <th>Nom</th>
                  <th>Date</th>
                  <th>Montant Total</th>
                  <th>État</th>
                  <th>Devise</th>
                </tr>
              </thead>
              <tbody id="pharmacyOrderHistoryTable"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
          <button type="button" class="btn btn-primary btn-print-pharmacy-supplier" data-id="">
            <i class="fas fa-file-pdf"></i> Télécharger PDF
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Bootstrap CSS (should be in base.html head, but included here for completeness) -->
<link href="{% static 'vendor/css/bootstrap.min.css' %}" rel="stylesheet">
<!-- Font Awesome for icons -->
<link href="{% static 'vendor/css/all.min.css' %}" rel="stylesheet">
<!-- Bootstrap JS -->
<script src="{% static 'vendor/js/bootstrap.bundle.min.js' %}"></script>
<!-- SweetAlert2 JS -->
<script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script>
<!-- Chart.js for order history chart -->
<script src="{% static 'vendor/js/chart.min.js' %}"></script>
<!-- Custom JS (assumed to handle search and pagination) -->
<script src="{% static 'js/pharmacy_suppliers_crud.js' %}"></script>
<script src="{% static 'js/supplier_search.js' %}"></script>
<script src="{% static 'js/suppliers.js' %}"></script>

<script>
// Pass pagination data to JavaScript
window.paginationData = {% if pagination %}{{ pagination|safe }}{% else %}null{% endif %};

document.addEventListener('DOMContentLoaded', function() {
  // Add form-control class to form inputs
  const formInputs = document.querySelectorAll('#supplier-form input, #supplier-form select, #supplier-form textarea');
  formInputs.forEach(input => {
    if (!input.matches('[type=file]') && !input.matches('[type=checkbox]') && !input.matches('[type=radio]')) {
      input.classList.add('form-control');
    }
  });

  // Scroll to form when clicking "Nouveau"
  document.getElementById('scrollToForm')?.addEventListener('click', () => {
    document.getElementById('formulaire-fournisseur')?.scrollIntoView({ behavior: 'smooth' });
  });

  // Handle import/export button (placeholder, implement as needed)
  document.getElementById('import-export-btn')?.addEventListener('click', () => {
    Swal.fire({
      icon: 'info',
      title: 'Fonctionnalité non implémentée',
      text: 'La fonctionnalité d\'import/export sera ajoutée ultérieurement.'
    });
  });
});

// Show alert function
function showAlert(type, message) {
  const alertContainer = document.getElementById('alert-container');
  if (!alertContainer) return;

  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show d-flex align-items-center`;
  alert.role = 'alert';
  alert.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'times-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2 fw-bold"></i>
    <div><strong>${type === 'success' ? 'Succès' : type === 'danger' ? 'Erreur' : type === 'warning' ? 'Attention' : 'Info'} :</strong> ${message}</div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  `;
  alertContainer.innerHTML = '';
  alertContainer.appendChild(alert);

  setTimeout(() => {
    alert.classList.remove('show');
    setTimeout(() => alert.remove(), 150);
  }, 5000);
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text.toString().replace(/[&<>"']/g, m => map[m]);
}

// Handle details button click to fetch and display order history
document.querySelectorAll('.btn-details-pharmacy-supplier').forEach(button => {
  button.addEventListener('click', function() {
    const supplierId = this.getAttribute('data-id');
    document.querySelector('.btn-print-pharmacy-supplier')?.setAttribute('data-id', supplierId);
    fetch(`/pharmacy/suppliers/${supplierId}/order-history/`)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Update total orders card
          document.getElementById('pharmacyTotalOrders').textContent = data.total_orders || 0;

          // Update turnover card
          document.getElementById('pharmacyTurnover').textContent = `${(data.turnover || 0).toFixed(2)} MAD`;

          // Update chart
          const ctx = document.getElementById('pharmacyOrdersByStateChart')?.getContext('2d');
          if (ctx) {
            if (window.pharmacyOrdersChart) {
              window.pharmacyOrdersChart.destroy();
            }
            window.pharmacyOrdersChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: data.chart_data?.labels || [],
                datasets: [{
                  label: 'Nombre de commandes par état',
                  data: data.chart_data?.data || [],
                  backgroundColor: 'rgba(54, 162, 235, 0.6)',
                  borderColor: 'rgba(54, 162, 235, 1)',
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      stepSize: 1
                    }
                  }
                },
                plugins: {
                  legend: {
                    display: false
                  }
                }
              }
            });
          }

          // Update orders table
          const tableBody = document.getElementById('pharmacyOrderHistoryTable');
          if (tableBody) {
            tableBody.innerHTML = '';
            (data.orders || []).forEach(order => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${escapeHtml(order.name || 'N/A')}</td>
                <td>${escapeHtml(order.date_order || 'N/A')}</td>
                <td>${(order.amount_total || 0).toFixed(2)}</td>
                <td>${escapeHtml(order.state || 'N/A')}</td>
                <td>${escapeHtml(order.currency || 'MAD')}</td>
              `;
              tableBody.appendChild(row);
            });
          }

          // Update modal title
          document.getElementById('pharmacyOrderHistoryModalLabel').textContent = 
            `Historique des commandes pour ${escapeHtml(data.supplier_name || 'Fournisseur')}`;
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: data.error || 'Impossible de charger l\'historique des commandes.',
          });
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Erreur',
          text: 'Une erreur s\'est produite lors du chargement des données.',
        });
        console.error('Error:', error);
      });
  });
});

// Handle print button click with SweetAlert confirmation
document.querySelector('.btn-print-pharmacy-supplier')?.addEventListener('click', function() {
  const supplierId = this.getAttribute('data-id');
  Swal.fire({
    title: 'Confirmer le téléchargement',
    text: 'Voulez-vous télécharger l\'historique des commandes en PDF ?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'Oui, télécharger',
    cancelButtonText: 'Annuler'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = `/pharmacy/suppliers/${supplierId}/order-history/pdf/`;
    }
  });
});

// Handle delete button click with SweetAlert confirmation
document.querySelectorAll('.btn-delete').forEach(button => {
  button.addEventListener('click', function() {
    const supplierId = this.getAttribute('data-id');
    Swal.fire({
      title: 'Confirmer la suppression',
      text: 'Êtes-vous sûr de vouloir supprimer ce fournisseur ? Cette action est irréversible.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Oui, supprimer',
      cancelButtonText: 'Annuler'
    }).then((result) => {
      if (result.isConfirmed) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
          Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Token CSRF non trouvé.',
          });
          return;
        }
        fetch(`/pharmacy/suppliers/${supplierId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
          },
        })
        .then(response => {
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        })
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Supprimé',
              text: 'Le fournisseur a été supprimé avec succès.',
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Erreur',
              text: data.error || 'Impossible de supprimer le fournisseur.',
            });
          }
        })
        .catch(error => {
          Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Une erreur s\'est produite lors de la suppression.',
          });
          console.error('Error:', error);
        });
      }
    });
  });
});

// Handle form reset with SweetAlert confirmation
document.getElementById('resetForm')?.addEventListener('click', function() {
  Swal.fire({
    title: 'Confirmer la réinitialisation',
    text: 'Voulez-vous réinitialiser le formulaire ? Toutes les modifications non enregistrées seront perdues.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Oui, réinitialiser',
    cancelButtonText: 'Annuler'
  }).then((result) => {
    if (result.isConfirmed) {
      document.getElementById('supplier-form')?.reset();
      Swal.fire({
        icon: 'success',
        title: 'Réinitialisé',
        text: 'Le formulaire a été réinitialisé.',
      });
    }
  });
});

// Handle form submit with SweetAlert confirmation and AJAX
document.getElementById('supplier-form')?.addEventListener('submit', function(event) {
  event.preventDefault();
  const form = this;
  const isUpdate = form.action.includes('/edit/');
  const actionText = isUpdate ? 'mettre à jour' : 'enregistrer';
  Swal.fire({
    title: `Confirmer l'enregistrement`,
    text: `Voulez-vous ${actionText} ce fournisseur ?`,
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: `Oui, ${actionText}`,
    cancelButtonText: 'Annuler'
  }).then((result) => {
    if (result.isConfirmed) {
      const formData = new FormData(form);
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
      if (!csrfToken) {
        Swal.fire({
          icon: 'error',
          title: 'Erreur',
          text: 'Token CSRF non trouvé.',
        });
        return;
      }
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': csrfToken,
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          Swal.fire({
            icon: 'success',
            title: 'Succès',
            text: data.message,
          }).then(() => {
            // Clear form inputs
            form.reset();
            // Reload page to return to supplier list
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: data.message || `Impossible de ${actionText} le fournisseur.`,
          });
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Erreur',
          text: `Une erreur s'est produite lors de l'envoi des données.`,
        });
        console.error('Error:', error);
      });
    }
  });
});
</script>
{% endblock %}