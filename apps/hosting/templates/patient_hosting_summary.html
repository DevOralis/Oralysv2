{% extends 'base.html' %}
{% load static %}
{% block title %}Oralys - Résumé Hébergement Patient{% endblock %}
{% block menu %}
  {% include 'hosting_menu.html' %}
{% endblock %}
{% block extra_scripts %}
<script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="card mb-4">
    <div class="card-header card-header-primary">
      <i class="fas fa-bed me-2"></i>
      Résumé Hébergement Patient
    </div>
    <div class="card-body">
      
      <!-- Sélection Patient -->
      <div class="row mb-4">
        <div class="col-md-6">
          <form method="get" id="patient-form">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-user"></i></span>
              <select name="patient_id" class="form-select" onchange="this.form.submit()">
                <option value="">Sélectionner un patient</option>
                {% for patient in patients %}
                  <option value="{{ patient.id }}" {% if patient.id|stringformat:"s" == selected_patient_id %}selected{% endif %}>
                    {{ patient.last_name }} {{ patient.first_name }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </form>
        </div>
      </div>

      {% if selected_patient %}
      <!-- Informations Patient -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i>{{ selected_patient.last_name }} {{ selected_patient.first_name }}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>CIN:</strong> {{ selected_patient.cin|default:"Non renseigné" }}</p>
              <p><strong>Téléphone:</strong> {{ selected_patient.phone|default:"Non renseigné" }}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Email:</strong> {{ selected_patient.email|default:"Non renseigné" }}</p>
              <p><strong>Date naissance:</strong> {{ selected_patient.birth_date|default:"Non renseigné" }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Admissions du Patient -->
      {% if admissions %}
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Séjours d'Hébergement ({{ admissions.count }})</h5>
        </div>
        <div class="card-body">
          {% for admission in admissions %}
          <div class="border rounded p-3 mb-3">
            <div class="row">
              <div class="col-md-3">
                <h6 class="text-primary">Séjour {{ forloop.counter }}</h6>
                <p><strong>Du:</strong> {{ admission.admission_date|date:"d/m/Y" }}</p>
                <p><strong>Au:</strong> {{ admission.discharge_date|date:"d/m/Y"|default:"En cours" }}</p>
                {% if admission.nb_jours %}
                  <p><strong>Durée:</strong> <span class="badge bg-info">{{ admission.nb_jours }} jour{{ admission.nb_jours|pluralize }}</span></p>
                {% endif %}
              </div>
              <div class="col-md-3">
                <h6 class="text-success">Chambre</h6>
                <p><strong>Nom:</strong> {{ admission.room.room_name }}</p>
                <p><strong>Type:</strong> <span class="badge bg-secondary">{{ admission.room_type_display }}</span></p>
                <p><strong>Mode:</strong> {{ admission.get_assignment_mode_display }}</p>
              </div>
              <div class="col-md-3">
                <h6 class="text-warning">Coût Hébergement</h6>
                {% if admission.acte_hebergement %}
                  <p><strong>Tarif:</strong> {{ admission.acte_hebergement.price }} DH/jour</p>
                  <p><strong>Total:</strong> <span class="badge bg-success">{{ admission.cout_total }} DH</span></p>
                {% else %}
                  <p class="text-muted">Tarif non défini</p>
                {% endif %}
              </div>
              <div class="col-md-3">
                <h6 class="text-info">Statut</h6>
                <p><strong>Lit:</strong> {{ admission.bed.bed_number|default:"Non assigné" }}</p>
                {% if admission.discharge_date %}
                  <span class="badge bg-success">Terminé</span>
                {% else %}
                  <span class="badge bg-primary">En cours</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Accompagnants -->
      {% if companions %}
      <div class="card mb-4">
        <div class="card-header bg-warning text-white">
          <h5 class="mb-0"><i class="fas fa-users me-2"></i>Accompagnants ({{ companions.count }})</h5>
        </div>
        <div class="card-body">
          {% for companion in companions %}
          <div class="border rounded p-3 mb-3">
            <div class="row">
              <div class="col-md-3">
                <h6 class="text-primary">{{ companion.companion_name }}</h6>
                <p><strong>Lien:</strong> {{ companion.relationship }}</p>
                {% if companion.accommodation_start_date and companion.accommodation_end_date %}
                  <p><strong>Du:</strong> {{ companion.accommodation_start_date|date:"d/m/Y" }}</p>
                  <p><strong>Au:</strong> {{ companion.accommodation_end_date|date:"d/m/Y" }}</p>
                  <p><strong>Durée:</strong> <span class="badge bg-info">{{ companion.nb_jours_acc }} jour{{ companion.nb_jours_acc|pluralize }}</span></p>
                {% endif %}
              </div>
              <div class="col-md-3">
                <h6 class="text-success">Hébergement</h6>
                {% if companion.room %}
                  <p><strong>Chambre:</strong> {{ companion.room.room_name }}</p>
                  <p><strong>Type:</strong> {{ companion.room.room_type }}</p>
                {% else %}
                  <p class="text-muted">Pas d'hébergement</p>
                {% endif %}
              </div>
              <div class="col-md-3">
                <h6 class="text-warning">Coût Accompagnant</h6>
                {% if companion.acte_accompagnant and companion.nb_jours_acc %}
                  <p><strong>Tarif:</strong> {{ companion.acte_accompagnant.price }} DH/jour</p>
                  <p><strong>Total:</strong> <span class="badge bg-success">{{ companion.cout_total }} DH</span></p>
                {% else %}
                  <p class="text-muted">Tarif non défini</p>
                {% endif %}
              </div>
              <div class="col-md-3">
                <h6 class="text-info">Statut</h6>
                {% if companion.accommodation_end_date %}
                  <span class="badge bg-success">Terminé</span>
                {% else %}
                  <span class="badge bg-primary">En cours</span>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Résumé Total -->
      {% if total_cout %}
      <div class="card mb-4">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Résumé Financier</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-4">
              <div class="border-end">
                <h3 class="text-primary">{{ total_cout.hebergement }} DH</h3>
                <p class="text-muted">Coût Hébergement</p>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border-end">
                <h3 class="text-warning">{{ total_cout.accompagnant }} DH</h3>
                <p class="text-muted">Coût Accompagnant</p>
              </div>
            </div>
            <div class="col-md-4">
              <h3 class="text-success">{{ total_cout.total }} DH</h3>
              <p class="text-muted">Total Hébergement</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-primary" onclick="generateInvoice()">
          <i class="fas fa-file-invoice"></i>
          Créer Facture
        </button>
        <button type="button" class="btn btn-secondary" onclick="exportPDF()">
          <i class="fas fa-file-pdf"></i>
          Export PDF
        </button>
      </div>
      {% endif %}

      {% if not admissions and not companions and selected_patient %}
      <div class="alert alert-info text-center">
        <i class="fas fa-info-circle me-2"></i>
        Aucun séjour d'hébergement trouvé pour ce patient.
      </div>
      {% endif %}

      {% endif %}
    </div>
  </div>
</div>

<script>
function generateInvoice() {
    const patientId = '{{ selected_patient.id }}';
    if (patientId) {
        Swal.fire({
            title: 'Créer une facture d\'hébergement?',
            text: 'Une nouvelle facture sera générée avec les coûts d\'hébergement calculés automatiquement.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Oui, créer',
            cancelButtonText: 'Annuler'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/hosting/patient/${patientId}/create-invoice/`;
            }
        });
    }
}

function exportPDF() {
    const patientId = '{{ selected_patient.id }}';
    if (patientId) {
        window.open(`/hosting/patient/${patientId}/summary-pdf/`, '_blank');
    }
}
</script>
{% endblock %}
