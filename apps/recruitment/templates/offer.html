{% extends "base.html" %}

{% block menu %}
{% include "menu_recruitment.html" %}
{% endblock %}

{% block content %}
<div class="content">
  <!-- Alerts Section -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% elif message.tags == 'info' %}info{% else %}primary{% endif %} alert-dismissible fade show d-flex align-items-center" role="alert">
        <i class="fas fa-{% if message.tags == 'error' %}times-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% elif message.tags == 'info' %}info-circle{% else %}bell{% endif %} me-2 fw-bold"></i>
        <div><strong>{% if message.tags == 'error' %}Erreur :{% elif message.tags == 'success' %}Succès :{% elif message.tags == 'warning' %}Attention :{% elif message.tags == 'info' %}Information :{% else %}Info :{% endif %}</strong> {{ message }}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Main Content Card -->
  <div class="card mb-4">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-clipboard-list me-2"></i>
      Liste des Offres d'Emploi
    </div>
    <div class="card-body">
      <!-- Search Bar Component -->
      <form method="get" id="search-form" class="mb-4">
        <div class="row g-2">
          <!-- Barre de recherche -->
          <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
            <div class="input-group">
              <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" 
                     name="q" 
                     id="search-title" 
                     class="form-control border-primary" 
                     placeholder="Rechercher par titre..." 
                     value="{{ query|default:'' }}">
            </div>
          </div>
          <!-- Filtre départements -->
          <div class="col-8 col-sm-8 col-md-3 col-lg-3 order-2">
            <select name="department" class="form-select" id="search-department" title="Filtrer par département">
              <option value="">Tous les départements</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}" {% if dept.id|stringformat:'s' == request.GET.department %}selected{% endif %}>{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Boutons d'action -->
          <div class="col-4 col-sm-4 col-md-4 col-lg-4 order-3">
            <div class="d-flex gap-1">
              <button type="button" class="btn btn-light border w-100 text-nowrap px-2" id="show-archived-offers-btn" onclick="toggleArchivedOffers()" title="Offres archivées">
                <i class="fas fa-archive"></i>
                <span class="d-none d-lg-inline ms-1">Archives</span>
              </button>
              <button type="button" class="btn btn-primary w-100 text-nowrap px-2" onclick="showAddOfferForm()">
                <i class="fas fa-plus"></i>
                <span class="d-none d-lg-inline ms-1">Nouveau</span>
              </button>
            </div>
          </div>
        </div>
      </form>
        <!-- Table Component -->
        <div class="table-container">
          <table class="table table-striped table-hover" id="searchableTable">
            <thead class="table-light borderless">
              <tr class="main-row">
                <th class="d-none d-md-table-cell">
                  <input type="checkbox" id="selectAll">
                </th>
                <th>
                  <div class="d-flex align-items-center">
                    <span>Titre</span>
                    <i class="fas fa-sort ms-1 text-muted"></i>
                  </div>
                </th>
                <th class="d-none d-md-table-cell">Date de publication</th>
                <th class="d-none d-md-table-cell">Date de fin</th>
                <th class="d-none d-md-table-cell">Département</th>
                <th class="d-none d-md-table-cell">Postes</th>
                <th class="d-none d-md-table-cell">Candidatures</th>
                <th class="d-none d-md-table-cell">Statut</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="offers-table">
              {% for offer in page_obj %}
              <tr class="main-row">
                <td class="d-none d-md-table-cell">
                  <input type="checkbox" class="row-check">
                </td>
                <td>{{ offer.title }}</td>
                <td class="d-none d-md-table-cell">{{ offer.publication_date|date:"d/m/Y" }}</td>
                <td class="d-none d-md-table-cell">{{ offer.end_date|date:"d/m/Y" }}</td>
                <td class="d-none d-md-table-cell">{% if offer.department %}{{ offer.department.name }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                <td class="d-none d-md-table-cell text-center">{{ offer.positions_available }}</td>
                <td class="d-none d-md-table-cell text-center">{{ offer.num_applications }}</td>
                <td class="d-none d-md-table-cell text-center">
                  {% if offer.end_date < today %}
                    <span class="badge bg-danger">Expirée</span>
                  {% else %}
                    <span class="badge bg-success">Active</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <button class="btn btn-sm btn-primary d-md-none" data-bs-toggle="collapse" data-bs-target="#details-{{ offer.id }}">
                    Voir détails
                  </button>
                  <div class="d-none d-md-flex gap-1 justify-content-end">
                    <button class="btn btn-sm btn-light border text-dark" 
                            onclick="showEditOfferForm(this)"
                            data-offer-id="{{ offer.id }}" 
                            data-offer-title="{{ offer.title }}"
                            data-offer-description="{{ offer.description|default:'' }}"
                            data-offer-publication-date="{{ offer.publication_date|date:'Y-m-d' }}"
                            data-offer-end-date="{{ offer.end_date|date:'Y-m-d' }}"
                            data-offer-skills="{{ offer.skills|default:'' }}"
                            data-offer-profile="{{ offer.profile|default:'' }}"
                            data-offer-department="{% if offer.department %}{{ offer.department.id }}{% endif %}"
                            data-offer-positions-available="{{ offer.positions_available }}"
                            title="Modifier cette offre">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-light border text-danger" 
                            data-bs-toggle="modal" 
                            data-bs-target="#modalDeleteOffer"
                            data-offer-id="{{ offer.id }}" 
                            data-offer-title="{{ offer.title }}"
                            title="Supprimer cette offre">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <tr class="collapse bg-light" id="details-{{ offer.id }}">
                <td colspan="10" class="p-3">
                  <div class="row">
                    <div class="col-md-6">
                      <p class="mb-2"><strong>Description:</strong> {{ offer.description|truncatechars:100 }}</p>
                      <p class="mb-2"><strong>Date de publication:</strong> {{ offer.publication_date|date:"d/m/Y" }}</p>
                      <p class="mb-2"><strong>Date de fin:</strong> {{ offer.end_date|date:"d/m/Y" }}</p>
                      <p class="mb-2"><strong>Compétences:</strong> {{ offer.skills|truncatechars:50 }}</p>
                      <p class="mb-2"><strong>Profil recherché:</strong> {{ offer.profile|truncatechars:50 }}</p>
                    </div>
                    <div class="col-md-6">
                      <p class="mb-2"><strong>Département:</strong> {% if offer.department %}{{ offer.department.name }}{% else %}<span class="text-muted">-</span>{% endif %}</p>
                      <p class="mb-2"><strong>Postes disponibles:</strong> {{ offer.positions_available }}</p>
                      <p class="mb-2"><strong>Candidatures:</strong> {{ offer.num_applications }}</p>
                      <p class="mb-2"><strong>Statut:</strong> 
                        {% if offer.end_date < today %}
                          <span class="badge bg-danger">Expirée</span>
                        {% else %}
                          <span class="badge bg-success">Active</span>
                        {% endif %}
                      </p>
                    </div>
                    <div class="col-12 mt-3">
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-dark" 
                                onclick="showEditOfferForm(this)"
                                data-offer-id="{{ offer.id }}" 
                                data-offer-title="{{ offer.title }}"
                                data-offer-description="{{ offer.description|default:'' }}"
                                data-offer-publication-date="{{ offer.publication_date|date:'Y-m-d' }}"
                                data-offer-end-date="{{ offer.end_date|date:'Y-m-d' }}"
                                data-offer-skills="{{ offer.skills|default:'' }}"
                                data-offer-profile="{{ offer.profile|default:'' }}"
                                data-offer-department="{% if offer.department %}{{ offer.department.id }}{% endif %}"
                                data-offer-positions-available="{{ offer.positions_available }}"
                                title="Modifier cette offre">
                          <i class="fas fa-edit me-1"></i> Modifier
                        </button>
                        <button class="btn btn-sm btn-danger" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalDeleteOffer"
                                data-offer-id="{{ offer.id }}" 
                                data-offer-title="{{ offer.title }}"
                                title="Supprimer cette offre">
                          <i class="fas fa-trash-alt me-1"></i> Supprimer
                        </button>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-muted">Aucune offre disponible</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      <!-- Pagination Component -->
      {% if page_obj.has_other_pages %}
      <nav class="mt-3">
        <ul class="pagination justify-content-center flex-wrap">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" aria-label="Précédent">
              <i class="fas fa-chevron-left d-block d-sm-none"></i>
              <span class="d-none d-sm-block">&laquo; Préc</span>
            </a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <a class="page-link" href="#">{{ num }}</a>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.department %}&department={{ request.GET.department }}{% endif %}" aria-label="Suivant">
              <i class="fas fa-chevron-right d-block d-sm-none"></i>
              <span class="d-none d-sm-block">Suiv &raquo;</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

    </div>
  </div>
  
  <!-- Formulaire d'ajout d'offre -->
  <div class="card mb-4" id="add-offer-form">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-plus me-2"></i>
      Nouvelle Offre d'Emploi
    </div>
    <div class="card-body">
      <form id="offerFormBottom" method="post" action="{% url 'recruitment_home' %}">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-12">
            <label class="form-label" for="id_title_bottom">Titre du poste <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="id_title_bottom" name="title" required>
          </div>
          <div class="col-md-12">
            <label class="form-label" for="id_description_bottom">Description du poste</label>
            <textarea class="form-control" id="id_description_bottom" name="description" rows="4" placeholder="Décrivez le poste et les responsabilités..."></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_publication_date_bottom">Date de publication <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-calendar"></i></span>
              <input type="date" class="form-control" id="id_publication_date_bottom" name="publication_date" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_end_date_bottom">Date de fin <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-calendar"></i></span>
              <input type="date" class="form-control" id="id_end_date_bottom" name="end_date" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_positions_bottom">Nombre de postes <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-users"></i></span>
              <input type="number" min="1" class="form-control" id="id_positions_bottom" name="positions_available" value="1" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_department_bottom">Département</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-building"></i></span>
              <select class="form-select" id="id_department_bottom" name="department">
                <option value="">Choisir un département</option>
                {% for dept in departments %}
                  <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-12">
            <label class="form-label" for="id_skills_bottom">Compétences requises</label>
            <textarea class="form-control" id="id_skills_bottom" name="skills" rows="3" placeholder="Listez les compétences requises pour ce poste"></textarea>
          </div>
          <div class="col-md-12">
            <label class="form-label" for="id_profile_bottom">Profil recherché</label>
            <textarea class="form-control" id="id_profile_bottom" name="profile" rows="3" placeholder="Décrivez le profil recherché pour ce poste"></textarea>
          </div>
        </div>
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Formulaire de modification d'offre -->
  <div class="card mb-4" id="edit-offer-form" style="display: none;">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-edit me-2"></i>
      Modifier l'Offre d'Emploi
    </div>
    <div class="card-body">
      <form id="editOfferFormBottom" method="post" action="{% url 'recruitment_home' %}">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" name="offer_id" id="edit_offer_id_bottom">
        <div class="row g-3">
          <div class="col-md-12">
            <label class="form-label" for="edit_title_bottom">Titre du poste <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="edit_title_bottom" name="title" required>
          </div>
          <div class="col-md-12">
            <label class="form-label" for="edit_description_bottom">Description du poste</label>
            <textarea class="form-control" id="edit_description_bottom" name="description" rows="4" placeholder="Décrivez le poste et les responsabilités..."></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_publication_date_bottom">Date de publication <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-calendar"></i></span>
              <input type="date" class="form-control" id="edit_publication_date_bottom" name="publication_date" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_end_date_bottom">Date de fin <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-calendar"></i></span>
              <input type="date" class="form-control" id="edit_end_date_bottom" name="end_date" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_positions_bottom">Nombre de postes <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-users"></i></span>
              <input type="number" min="1" class="form-control" id="edit_positions_bottom" name="positions_available" required>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="edit_department_bottom">Département</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-building"></i></span>
              <select class="form-select" id="edit_department_bottom" name="department">
                <option value="">Choisir un département</option>
                {% for dept in departments %}
                  <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-12">
            <label class="form-label" for="edit_skills_bottom">Compétences requises</label>
            <textarea class="form-control" id="edit_skills_bottom" name="skills" rows="3" placeholder="Listez les compétences requises pour ce poste"></textarea>
          </div>
          <div class="col-md-12">
            <label class="form-label" for="edit_profile_bottom">Profil recherché</label>
            <textarea class="form-control" id="edit_profile_bottom" name="profile" rows="3" placeholder="Décrivez le profil recherché pour ce poste"></textarea>
          </div>
        </div>
        <div class="mt-4 text-end">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Modifier
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tableau des offres archivées -->
  <div class="card mb-4" id="archived-offers-section" style="display: none;">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-archive me-2"></i>
      Offres archivées
    </div>
    <div class="card-body">
      <!-- Search Bar Component pour les offres archivées -->
      <form method="get" id="archived-search-form" class="mb-4">
        <div class="row g-2">
          <!-- Barre de recherche -->
          <div class="col-12 col-sm-12 col-md-6 col-lg-6 order-1">
            <div class="input-group">
              <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" 
                     name="archived_q" 
                     id="archived-search-title" 
                     class="form-control border-primary" 
                     placeholder="Rechercher par titre..." 
                     value="{{ archived_query|default:'' }}">
            </div>
          </div>
          <!-- Filtre départements -->
          <div class="col-8 col-sm-8 col-md-3 col-lg-3 order-2">
            <select name="archived_department" class="form-select" id="archived-search-department" title="Filtrer par département">
              <option value="">Tous les départements</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}" {% if dept.id|stringformat:'s' == request.GET.archived_department %}selected{% endif %}>{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Boutons d'action -->
          <div class="col-4 col-sm-4 col-md-3 col-lg-3 order-3">
            <div class="d-flex gap-1">
              <button type="button" class="btn btn-light border w-100 text-nowrap px-2" onclick="toggleArchivedOffers()">
                <i class="fas fa-times"></i>
                <span class="d-none d-lg-inline ms-1">Fermer</span>
              </button>
            </div>
          </div>
        </div>
      </form>

      <!-- Table Component pour les offres archivées -->
      <div class="table-container">
        <table class="table table-striped table-hover">
          <thead class="table-light borderless">
            <tr class="main-row">
              <th>
                <div class="d-flex align-items-center">
                  <span>Titre</span>
                  <i class="fas fa-sort ms-1 text-muted"></i>
                </div>
              </th>
              <th class="d-none d-md-table-cell">Description</th>
              <th class="d-none d-md-table-cell">Date de publication</th>
              <th class="d-none d-md-table-cell">Date de fin</th>
              <th class="d-none d-md-table-cell">Compétences</th>
              <th class="d-none d-md-table-cell">Département</th>
              <th class="d-none d-md-table-cell">Postes</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody id="archived-offers-table">
            {% for offer in archived_offers %}
            <tr class="main-row">
              <td>{{ offer.title }}</td>
              <td class="d-none d-md-table-cell">{{ offer.description|truncatechars:50 }}</td>
              <td class="d-none d-md-table-cell">{{ offer.publication_date|date:"d/m/Y" }}</td>
              <td class="d-none d-md-table-cell">{{ offer.end_date|date:"d/m/Y" }}</td>
              <td class="d-none d-md-table-cell">{{ offer.skills|truncatechars:30 }}</td>
              <td class="d-none d-md-table-cell">{% if offer.department %}{{ offer.department.name }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
              <td class="d-none d-md-table-cell text-center">{{ offer.positions_available }}</td>
              <td class="text-end">
                <form method="post" action="{% url 'recruitment_home' %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="unarchive">
                  <input type="hidden" name="offer_id" value="{{ offer.id }}">
                  <button type="submit" class="btn btn-success btn-sm" title="Réactiver cette offre">
                    <i class="fas fa-redo me-1"></i> Réactiver
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="8" class="text-center text-muted">Aucune offre archivée.</td></tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
  </div>
</div>

<!-- Modal pour supprimer une offre -->
<div class="modal fade" id="modalDeleteOffer" tabindex="-1" aria-labelledby="modalDeleteOfferLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalDeleteOfferLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Confirmer la suppression
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning d-flex align-items-center" role="alert">
          <i class="fas fa-exclamation-triangle me-2 fw-bold"></i>
          <div><strong>Attention :</strong> Êtes-vous sûr de vouloir supprimer l'offre : <strong id="delete_offer_title"></strong> ?</div>
        </div>
        <p class="text-danger"><i class="fas fa-info-circle me-1"></i> Cette action est irréversible.</p>
        <form id="deleteOfferForm" method="post" action="{% url 'recruitment_home' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <input type="hidden" name="offer_id" id="delete_offer_id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Annuler
        </button>
        <button type="submit" form="deleteOfferForm" class="btn btn-danger">
          <i class="fas fa-trash-alt me-1"></i> Supprimer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript pour gérer les formulaires -->
<script>
// Fonctions pour gérer l'affichage des formulaires
function showAddOfferForm() {
  // Masquer le formulaire d'édition et le tableau des archives s'ils sont ouverts
  var editForm = document.getElementById('edit-offer-form');
  if (editForm) editForm.style.display = 'none';
  var archivedSection = document.getElementById('archived-offers-section');
  if (archivedSection) archivedSection.style.display = 'none';
  // Afficher le formulaire d'ajout
  var addForm = document.getElementById('add-offer-form');
  if (addForm) addForm.style.display = 'block';
  // Faire défiler vers le formulaire
  if (addForm) window.scrollTo({ top: addForm.offsetTop - 80, behavior: 'smooth' });
}

function hideAddOfferForm() {
  var addForm = document.getElementById('add-offer-form');
  if (addForm) addForm.style.display = 'none';
  // Réinitialiser le formulaire
  var offerFormBottom = document.getElementById('offerFormBottom');
  if (offerFormBottom && typeof offerFormBottom.reset === 'function') offerFormBottom.reset();
}

function showEditOfferForm(button) {
  // Masquer le formulaire d'ajout et le tableau des archives s'ils sont ouverts
  var addForm = document.getElementById('add-offer-form');
  if (addForm) addForm.style.display = 'none';
  var archivedSection = document.getElementById('archived-offers-section');
  if (archivedSection) archivedSection.style.display = 'none';
  
  // Récupérer les données depuis les data attributes
  const offerId = button.getAttribute('data-offer-id');
  const title = button.getAttribute('data-offer-title');
  const description = button.getAttribute('data-offer-description');
  const publicationDate = button.getAttribute('data-offer-publication-date');
  const endDate = button.getAttribute('data-offer-end-date');
  const skills = button.getAttribute('data-offer-skills');
  const profile = button.getAttribute('data-offer-profile');
  const department = button.getAttribute('data-offer-department');
  const positions = button.getAttribute('data-offer-positions-available');
  
  // Remplir le formulaire d'édition avec les données
  var f;
  if ((f = document.getElementById('edit_offer_id_bottom'))) f.value = offerId;
  if ((f = document.getElementById('edit_title_bottom'))) f.value = title;
  if ((f = document.getElementById('edit_description_bottom'))) f.value = description;
  if ((f = document.getElementById('edit_publication_date_bottom'))) f.value = publicationDate;
  if ((f = document.getElementById('edit_end_date_bottom'))) f.value = endDate;
  if ((f = document.getElementById('edit_skills_bottom'))) f.value = skills;
  if ((f = document.getElementById('edit_profile_bottom'))) f.value = profile;
  if ((f = document.getElementById('edit_department_bottom'))) f.value = department;
  if ((f = document.getElementById('edit_positions_bottom'))) f.value = positions;
  
  // Afficher le formulaire d'édition
  var editForm = document.getElementById('edit-offer-form');
  if (editForm) editForm.style.display = 'block';
  // Faire défiler vers le formulaire
  if (editForm) window.scrollTo({ top: editForm.offsetTop - 80, behavior: 'smooth' });
}

function hideEditOfferForm() {
  var editForm = document.getElementById('edit-offer-form');
  if (editForm) editForm.style.display = 'none';
  // Réinitialiser le formulaire
  var editOfferFormBottom = document.getElementById('editOfferFormBottom');
  if (editOfferFormBottom && typeof editOfferFormBottom.reset === 'function') editOfferFormBottom.reset();
}

// Fonction pour afficher/masquer le tableau des offres archivées
function toggleArchivedOffers() {
  const archivedSection = document.getElementById('archived-offers-section');
  const addFormSection = document.getElementById('add-offer-form');
  const editFormSection = document.getElementById('edit-offer-form');
  const button = document.getElementById('show-archived-offers-btn');
  
  if (archivedSection && addFormSection && editFormSection && button) {
  if (archivedSection.style.display === 'none') {
    // Masquer les formulaires
    addFormSection.style.display = 'none';
    editFormSection.style.display = 'none';
    // Afficher le tableau des archives
    archivedSection.style.display = 'block';
    button.innerHTML = '<i class="fas fa-times"></i><span class="d-none d-lg-inline ms-1">Fermer</span>';
    button.title = 'Fermer les archives';
    // Scroll vers le tableau d'archives
    window.scrollTo({ top: archivedSection.offsetTop - 80, behavior: 'smooth' });
  } else {
    // Masquer le tableau des archives
    archivedSection.style.display = 'none';
    // Réafficher le formulaire d'ajout par défaut
    addFormSection.style.display = 'block';
    button.innerHTML = '<i class="fas fa-archive"></i><span class="d-none d-lg-inline ms-1">Archives</span>';
    button.title = 'Offres archivées';
    }
  }
}

// JavaScript pour gérer les modals
// Gestion de la sélection multiple
const selectAllCheckbox = document.getElementById('selectAll');
const rowCheckboxes = document.querySelectorAll('.row-check');

if (selectAllCheckbox) {
  selectAllCheckbox.addEventListener('change', function() {
    rowCheckboxes.forEach(checkbox => {
      checkbox.checked = this.checked;
    });
  });
}

rowCheckboxes.forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const checkedBoxes = document.querySelectorAll('.row-check:checked');
    const totalBoxes = rowCheckboxes.length;

    if (checkedBoxes.length === totalBoxes) {
      selectAllCheckbox.checked = true;
    } else {
      selectAllCheckbox.checked = false;
    }
  });
});

// Modal édition/suppression 
document.addEventListener('DOMContentLoaded', function() {
  // Modal de suppression
  const modalDeleteOffer = document.getElementById('modalDeleteOffer');
  if (modalDeleteOffer) {
    modalDeleteOffer.addEventListener('show.bs.modal', function(event) {
      const button = event.relatedTarget;
      const offerId = button.getAttribute('data-offer-id');
      const offerTitle = button.getAttribute('data-offer-title');

      var f;
      if ((f = document.getElementById('delete_offer_id'))) f.value = offerId;
      if ((f = document.getElementById('delete_offer_title'))) f.textContent = offerTitle;
    });
  }
});

// Recherche instantanée AJAX pour le titre
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-title');
  const searchDepartmentSelect = document.getElementById('search-department');
  const offersTable = document.getElementById('offers-table');
  let searchTimeout = null;
  let lastQuery = searchInput ? searchInput.value : '';
  let lastDepartment = searchDepartmentSelect ? searchDepartmentSelect.value : '';
  let controller = null;

  if (searchInput && offersTable) {
    // Fonction pour effectuer la recherche
    function performSearch(query, department) {
      // Annule la requête précédente si elle existe
      if (controller) {
        controller.abort();
      }

      controller = new AbortController();

      // Afficher un indicateur de chargement
      offersTable.innerHTML = '<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Recherche en cours...</td></tr>';

      const searchUrl = '/rc/?q=' + encodeURIComponent(query) + '&department=' + encodeURIComponent(department);

      fetch(searchUrl, {
        headers: { 
          'X-Requested-With': 'XMLHttpRequest',
          'Cache-Control': 'no-cache'
        },
        signal: controller.signal
      })
      .then(response => {

        if (!response.ok) throw new Error('Erreur réseau: ' + response.status);
        return response.text();
      })
      .then(html => {
        offersTable.innerHTML = html;
      })
      .catch(error => {
        if (error.name !== 'AbortError') {
          offersTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erreur lors de la recherche: ' + error.message + '</td></tr>';
        }
      });
    }

    searchInput.addEventListener('input', function() {
      const query = searchInput.value.trim();
      const department = searchDepartmentSelect ? searchDepartmentSelect.value : '';

      // Annuler le timeout précédent
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }

      // Si la requête est la même, ne rien faire
      if (query === lastQuery && department === lastDepartment) return;

      lastQuery = query;
      lastDepartment = department;

      // Attendre 300ms après que l'utilisateur arrête de taper
      searchTimeout = setTimeout(() => {
        performSearch(query, department);
      }, 300);
    });

    // Écouter la touche Entrée pour une recherche immédiate
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        performSearch(searchInput.value.trim(), searchDepartmentSelect ? searchDepartmentSelect.value : '');
      }
    });

    // Écouter le changement de département
    if (searchDepartmentSelect) {
    searchDepartmentSelect.addEventListener('change', function() {
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      lastDepartment = this.value;
      performSearch(searchInput.value.trim(), this.value);
      });
    }
    
  }
});

// Recherche pour les offres archivées
document.addEventListener('DOMContentLoaded', function() {
  const archivedSearchInput = document.getElementById('archived-search-title');
  const archivedDepartmentSelect = document.getElementById('archived-search-department');
  const archivedOffersTable = document.getElementById('archived-offers-table');
  let archivedSearchTimeout = null;
  let lastArchivedQuery = archivedSearchInput ? archivedSearchInput.value : '';
  let lastArchivedDepartment = archivedDepartmentSelect ? archivedDepartmentSelect.value : '';
  let archivedController = null;

  if (archivedOffersTable) {
    function performArchivedSearch(query, department) {
      if (archivedController) {
        archivedController.abort();
      }
      archivedController = new AbortController();
      archivedOffersTable.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Recherche en cours...</td></tr>';
      // Utiliser l'URL courante
      const searchUrl = window.location.pathname + '?archived_q=' + encodeURIComponent(query) + '&archived_department=' + encodeURIComponent(department);
      fetch(searchUrl, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'Cache-Control': 'no-cache'
        },
        signal: archivedController.signal
      })
      .then(response => {
        if (!response.ok) throw new Error('Erreur réseau: ' + response.status);
        return response.text();
      })
      .then(html => {
        // On reçoit directement le contenu du tbody
        archivedOffersTable.innerHTML = html;
      })
      .catch(error => {
        if (error.name !== 'AbortError') {
          archivedOffersTable.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erreur lors de la recherche: ' + error.message + '</td></tr>';
        }
      });
    }

    if (archivedSearchInput) {
      archivedSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        const department = archivedDepartmentSelect ? archivedDepartmentSelect.value : '';
        if (archivedSearchTimeout) {
          clearTimeout(archivedSearchTimeout);
        }
        if (query === lastArchivedQuery && department === lastArchivedDepartment) return;
        lastArchivedQuery = query;
        lastArchivedDepartment = department;
        archivedSearchTimeout = setTimeout(() => {
          performArchivedSearch(query, department);
        }, 300);
      });
      archivedSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (archivedSearchTimeout) {
            clearTimeout(archivedSearchTimeout);
          }
          performArchivedSearch(this.value.trim(), archivedDepartmentSelect ? archivedDepartmentSelect.value : '');
        }
      });
    }
    if (archivedDepartmentSelect) {
      archivedDepartmentSelect.addEventListener('change', function() {
        if (archivedSearchTimeout) {
          clearTimeout(archivedSearchTimeout);
        }
        lastArchivedDepartment = this.value;
        performArchivedSearch(archivedSearchInput ? archivedSearchInput.value.trim() : '', this.value);
      });
    }
  }
});
</script>

</div>

{% endblock %}