{% extends "base.html" %}

{% block title %}Pointage{% endblock %}
{% block menu %}
{% include "menu_recruitment.html" %}
{% endblock %}
{% block content %}
<div class="content">

  <!-- Bloc d'affichage des messages de feedback utilisateur (succès, erreur, etc.) -->
  {% if messages %}
  {% for message in messages %}
    <div class="alert alert-{% if message.tags == 'error' %}danger{% elif message.tags == 'success' %}success{% elif message.tags == 'warning' %}warning{% elif message.tags == 'info' %}info{% else %}primary{% endif %} alert-dismissible fade show d-flex align-items-center" role="alert">
      <i class="fas fa-{% if message.tags == 'error' %}times-circle{% elif message.tags == 'success' %}check-circle{% elif message.tags == 'warning' %}exclamation-triangle{% elif message.tags == 'info' %}info-circle{% else %}bell{% endif %} me-2 fw-bold"></i>
      <div><strong>{% if message.tags == 'error' %}Erreur :{% elif message.tags == 'success' %}Succès :{% elif message.tags == 'warning' %}Attention :{% elif message.tags == 'info' %}Information :{% else %}Message :{% endif %}</strong> {{ message }}</div>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
  {% endif %}

  <!-- Table Header Component -->
  <div class="card mb-4">
    <div class="card-header text-white" style="background-color: #1e90ff;">
      <i class="fas fa-clipboard-list me-2"></i>
      Liste des Pointages
    </div>
    <div class="card-body">
      <div class="row g-2 mb-3">
        <div class="d-flex justify-content-end gap-1">
          <form method="post" enctype="multipart/form-data" style="display: inline;">
            {% csrf_token %}
            <input type="file" class="form-control" name="csv_file" accept=".csv" id="csvFile" style="display: none;">
            <label for="csvFile" class="btn w-100 text-nowrap px-2 text-white" title="Importer un fichier CSV" style="background-color: #1e90ff; border-color: #1e90ff;">
              <i class="fas fa-file-export"></i>
              <span class="d-none d-lg-inline ms-1">Importer CSV</span>
            </label>
          </form>
        </div>
      </div>

      <!-- Table Component -->
      <div class="table-container">
        <table class="table table-striped table-hover" id="pointageTable">
          <thead class="table-light borderless">
            <tr class="main-row">
              <th class="d-none d-md-table-cell">
                <input type="checkbox" id="selectAll">
              </th>
              <th>
                <div class="d-flex align-items-center">
                  <span>Code Employé</span>
                  <i class="fas fa-sort ms-1 text-muted"></i>
                </div>
              </th>
              <th class="d-none d-md-table-cell">Nom complet</th>
              <th class="d-none d-md-table-cell">Date</th>
              <th class="d-none d-md-table-cell">Jour</th>
              <th class="d-none d-md-table-cell">Heure d'arrivée</th>
              <th class="d-none d-md-table-cell">Heure départ</th>
              <th class="d-none d-md-table-cell">Heure travaillée</th>
            </tr>
          </thead>
          <tbody>
            {% for p in page_obj %}
            <tr class="main-row">
              <td class="d-none d-md-table-cell">
                <input type="checkbox" class="row-check">
              </td>
              <td>{{ p.employee.employee_id }}</td>
              <td class="d-none d-md-table-cell">{{ p.employee.full_name }}</td>
              <td class="d-none d-md-table-cell">{{ p.date|date:"d/m/Y" }}</td>
              <td class="d-none d-md-table-cell">{{ p.jour }}</td>
              <td class="d-none d-md-table-cell">{{ p.heure_arrivee|time:"H:i" }}</td>
              <td class="d-none d-md-table-cell">{{ p.heure_depart|time:"H:i" }}</td>
              <td class="d-none d-md-table-cell">{{ p.heure_travaillee }}</td>
            </tr>
            <tr class="collapse bg-light" id="details-{{ p.id }}">
              <td colspan="9" class="p-3">
                <div class="row">
                  <div class="col-6">
                    <p class="mb-2"><strong>Nom complet:</strong> {{ p.employee.full_name }}</p>
                    <p class="mb-2"><strong>Date:</strong> {{ p.date|date:"d/m/Y" }}</p>
                    <p class="mb-2"><strong>Jour:</strong> {{ p.jour }}</p>
                  </div>
                  <div class="col-6">
                    <p class="mb-2"><strong>Heure d'arrivée:</strong> {{ p.heure_arrivee|time:"H:i" }}</p>
                    <p class="mb-2"><strong>Heure départ:</strong> {{ p.heure_depart|time:"H:i" }}</p>
                    <p class="mb-2"><strong>Heure travaillée:</strong> {{ p.heure_travaillee }}</p>
                  </div>
                  <div class="col-12 mt-3">
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm text-white" title="Imprimer" style="background-color: #1e90ff; border-color: #1e90ff;">
                        <i class="fas fa-print me-1"></i> Imprimer
                      </button>
                      <button class="btn btn-sm btn-info text-white" title="Voir">
                        <i class="fas fa-eye me-1"></i> Voir
                      </button>
                      <button class="btn btn-sm btn-dark" title="Modifier">
                        <i class="fas fa-edit me-1"></i> Modifier
                      </button>
                      <button class="btn btn-sm btn-danger" title="Supprimer">
                        <i class="fas fa-trash-alt me-1"></i> Supprimer
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center">Aucun pointage trouvé.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination Component -->
      {% if page_obj.has_other_pages %}
      <nav class="mt-3">
        <ul class="pagination justify-content-center flex-wrap">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.date_filter %}&date_filter={{ request.GET.date_filter }}{% endif %}" aria-label="Précédent">
              <i class="fas fa-chevron-left d-block d-sm-none"></i>
              <span class="d-none d-sm-block">&laquo; Préc</span>
            </a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active">
                <a class="page-link" href="#">{{ num }}</a>
              </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.date_filter %}&date_filter={{ request.GET.date_filter }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.date_filter %}&date_filter={{ request.GET.date_filter }}{% endif %}" aria-label="Suivant">
              <i class="fas fa-chevron-right d-block d-sm-none"></i>
              <span class="d-none d-sm-block">Suiv &raquo;</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.getElementById('csvFile').addEventListener('change', function() {
    // Soumettre automatiquement le formulaire quand un fichier est sélectionné
    if (this.files.length > 0) {
        this.closest('form').submit();
    }
});

// Fonctionnalité de sélection multiple
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-check');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
});
</script>
{% endblock %}