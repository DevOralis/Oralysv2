{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pharmacy_css/product.css' %}">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<style>
  #audit-log-table { width: 100%; }
  .audit-log-row { display: table-row; }
  .audit-log-row td { vertical-align: middle; padding: 8px; }
  .card-header-primary {
    background: #007bff;
    color: white;
    font-weight: 500;
    padding: 15px;
    border-radius: 8px 8px 0 0;
  }
  .input-group-text-primary {
    background: #007bff;
    color: white;
    border: none;
  }
  .search-input-primary:focus {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0,123,255,0.3);
  }
  .badge {
    font-size: 0.9em;
    padding: 6px 12px;
    border-radius: 12px;
    color: white;
  }
  .badge-creation { background-color: #28a745; }
  .badge-modification { background-color: #17a2b8; }
  .badge-suppression { background-color: #dc3545; }
  .badge-impression { background-color: #ffc107; color: #212529; }
  .table-responsive { overflow-x: auto; }
  .actions-cell { text-align: right; }
  @media (max-width: 991px) {
    .d-none.d-lg-table-cell { display: none !important; }
  }
</style>
{% endblock %}

{% block menu %}
  {% include 'home_menu.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Liste des journaux d'audit -->
  <div class="card mb-4">
    <div class="card-header card-header-primary">
      <i class="fas fa-user me-2"></i>
      Journaux d'Audit
    </div>
    <div class="card-body">
      <form method="get" id="search-form">
        <div class="row g-2 mb-3">
          <!-- Première ligne: Barre de recherche, filtre d'action, bouton exporter -->
          <div class="col-12 col-sm-12 col-md-5 col-lg-5">
            <div class="input-group">
              <span class="input-group-text input-group-text-primary">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" id="audit-log-search" class="form-control search-input-primary" placeholder="Rechercher dans les journaux..." value="">
            </div>
          </div>
          <div class="col-8 col-sm-8 col-md-3 col-lg-3">
            <select id="action-filter" class="form-select" title="Filtrer par action">
              <option value="">Toutes les actions</option>
              {% for action, label in action_choices %}
                <option value="{{ action }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-4 col-sm-4 col-md-4 col-lg-4">
            <button type="button" class="btn btn-light border w-100 text-nowrap px-2" id="exportBtn">
              <i class="fas fa-file-export"></i>
              <span class="d-none d-lg-inline ms-1">Exporter</span>
            </button>
          </div>
          <!-- Deuxième ligne: Filtres de date -->
          <div class="col-12 col-sm-12 col-md-6 col-lg-6">
            <div class="d-flex gap-1">
              <input type="datetime-local" class="form-control" id="start-datetime" placeholder="Date de début">
              <input type="datetime-local" class="form-control" id="end-datetime" placeholder="Date de fin">
            </div>
          </div>
        </div>
      </form>
      <div class="table-responsive">
        <table class="table table-responsive table-striped table-hover" id="audit-log-table">
          <thead class="table-light borderless">
            <tr class="main-row">
              <th><input type="checkbox" id="selectAll"></th>
              <th><div class="d-flex align-items-center"><span>ID</span><i class="fas fa-sort ms-1 text-muted"></i></div></th>
              <th><div class="d-flex align-items-center"><span>Entité</span><i class="fas fa-sort ms-1 text-muted"></i></div></th>
              <th><div class="d-flex align-items-center"><span>ID de l'objet</span><i class="fas fa-sort ms-1 text-muted"></i></div></th>
              <th><div class="d-flex align-items-center"><span>Action</span><i class="fas fa-sort ms-1 text-muted"></i></div></th>
              <th class="d-none d-lg-table-cell"><div class="d-flex align-items-center"><span>Effectué par</span><i class="fas fa-sort ms-1 text-muted"></i></div></th>
              <th class="d-none d-lg-table-cell"><div class="d-flex align-items-center"><span>Date et heure</span><i class="fas fa-sort ms-1 text-muted"></i></div></th>
            </tr>
          </thead>
          <tbody>
            {% include 'audit_log_table_body.html' %}
          </tbody>
        </table>
      </div>
      <!-- Pagination -->
      <nav class="mt-3">
        <ul class="pagination justify-content-center flex-wrap">
          <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
            <button class="page-link" id="prev-page" aria-label="Précédent" {% if not page_obj.has_previous %}disabled{% endif %}>
              <i class="fas fa-chevron-left d-block d-sm-none"></i>
              <span class="d-none d-sm-block">&laquo; Préc</span>
            </button>
          </li>
          <li class="page-item active">
            <span class="page-link" id="page-info">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
          </li>
          <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
            <button class="page-link" id="next-page" aria-label="Suivant" {% if not page_obj.has_next %}disabled{% endif %}>
              <i class="fas fa-chevron-right d-block d-sm-none"></i>
              <span class="d-none d-sm-block">Suiv &raquo;</span>
            </button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('audit-log-search');
  const actionFilter = document.getElementById('action-filter');
  const startDatetimeInput = document.getElementById('start-datetime');
  const endDatetimeInput = document.getElementById('end-datetime');
  const exportPdfBtn = document.getElementById('exportBtn');
  const tableBody = document.querySelector('#audit-log-table tbody');
  const prevPageBtn = document.getElementById('prev-page');
  const nextPageBtn = document.getElementById('next-page');
  const pageInfo = document.getElementById('page-info');
  const selectAllCheckbox = document.getElementById('selectAll');
  let currentPage = {{ page_obj.number }};

  function refreshTable(page = currentPage) {
    const q = searchInput.value;
    const action = actionFilter.value;
    let startDate = '';
    let startTime = '';
    let endDate = '';
    let endTime = '';
    
    if (startDatetimeInput.value) {
      const start = new Date(startDatetimeInput.value);
      startDate = start.toISOString().split('T')[0];
      startTime = start.toTimeString().slice(0, 5);
    }
    
    if (endDatetimeInput.value) {
      const end = new Date(endDatetimeInput.value);
      endDate = end.toISOString().split('T')[0];
      endTime = end.toTimeString().slice(0, 5);
    }
    
    let url = "{% url 'audit_log_table_body' %}?q=" + encodeURIComponent(q) +
              "&action=" + encodeURIComponent(action) +
              "&page=" + page;
    if (startDate) url += "&start_date=" + encodeURIComponent(startDate);
    if (startTime) url += "&start_time=" + encodeURIComponent(startTime);
    if (endDate) url += "&end_date=" + encodeURIComponent(endDate);
    if (endTime) url += "&end_time=" + encodeURIComponent(endTime);
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.text();
      })
      .then(html => {
        tableBody.innerHTML = html;
        currentPage = page;
        pageInfo.textContent = `${currentPage} / {{ page_obj.paginator.num_pages }}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === {{ page_obj.paginator.num_pages }};
        prevPageBtn.parentElement.classList.toggle('disabled', currentPage === 1);
        nextPageBtn.parentElement.classList.toggle('disabled', currentPage === {{ page_obj.paginator.num_pages }});
      })
      .catch(error => {
        console.error('Error refreshing audit log table:', error);
        Swal.fire({
          title: 'Erreur',
          text: 'Une erreur est survenue lors du chargement des journaux.',
          icon: 'error'
        });
      });
  }

  let searchTimer = null;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => refreshTable(1), 300);
  });

  actionFilter.addEventListener('change', () => refreshTable(1));
  startDatetimeInput.addEventListener('change', () => refreshTable(1));
  endDatetimeInput.addEventListener('change', () => refreshTable(1));

  prevPageBtn.addEventListener('click', function() {
    if (currentPage > 1) {
      refreshTable(currentPage - 1);
    }
  });

  nextPageBtn.addEventListener('click', function() {
    if (currentPage < {{ page_obj.paginator.num_pages }}) {
      refreshTable(currentPage + 1);
    }
  });

  exportPdfBtn.addEventListener('click', function(e) {
    e.preventDefault();
    const q = searchInput.value;
    const action = actionFilter.value;
    let startDate = '';
    let startTime = '';
    let endDate = '';
    let endTime = '';
    
    if (startDatetimeInput.value) {
      const start = new Date(startDatetimeInput.value);
      startDate = start.toISOString().split('T')[0];
      startTime = start.toTimeString().slice(0, 5);
    }
    
    if (endDatetimeInput.value) {
      const end = new Date(endDatetimeInput.value);
      endDate = end.toISOString().split('T')[0];
      endTime = end.toTimeString().slice(0, 5);
    }
    
    let url = "{% url 'audit_log_export_pdf' %}?q=" + encodeURIComponent(q) + "&action=" + encodeURIComponent(action);
    if (startDate) url += "&start_date=" + encodeURIComponent(startDate);
    if (startTime) url += "&start_time=" + encodeURIComponent(startTime);
    if (endDate) url += "&end_date=" + encodeURIComponent(endDate);
    if (endTime) url += "&end_time=" + encodeURIComponent(endTime);
    window.location.href = url;
  });

  selectAllCheckbox.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-check');
    checkboxes.forEach(checkbox => checkbox.checked = selectAllCheckbox.checked);
  });
});
</script>
{% endblock %}