
{% extends 'base.html' %}
{% load static %}
{% block title %}Oralys - Calendrier des Congés{% endblock %}
{% block menu %}
  {% include 'hr_menu.html' %}
{% endblock %}


{% block content %}
        <div class="content hr-capitalize">
            <div class="card mb-4">
              <div class="card-header text-white" style="background-color: #1e90ff;">
                <i class="fas fa-calendar-alt me-2"></i>
                Calendrier des Congés
              </div>
              <div class="card-body">
                <!-- Légende -->
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color legend-holiday"></div>
                        <span>Jour férié</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-leave"></div>
                        <span>Congé(s)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-weekend"></div>
                        <span>Weekend</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-today"></div>
                        <span>Aujourd'hui</span>
                    </div>
                </div>
                
                <div class="calendar-container">
                    <div id="calendar"></div>
                </div>
              </div>
            </div>

            <!-- Historique des demandes de congés -->
            <div class="card mb-4">
              <div class="card-header text-white" style="background-color: #1e90ff;">
                <i class="fas fa-history me-2"></i>
                Historique des Demandes de Congés
              </div>
              <div class="card-body">
                <!-- Search Bar Component -->
                <form method="get" id="history-search-form">
                  <div class="row g-2 mb-3">
                    <!-- Barre de recherche -->
                    <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
                      <div class="input-group">
                        <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                          <i class="fas fa-search"></i>
                        </span>
                        <input type="search" id="searchCalendarHistory" name="q" class="form-control border-primary" placeholder="Rechercher dans l'historique..." value="">
                      </div>
                    </div>
                    <!-- Filtre statut -->
                    <div class="col-8 col-sm-8 col-md-3 col-lg-3 order-2">
                      <select class="form-select" id="historyStatusFilter" title="Filtrer par statut">
                        <option value="">Tous les statuts</option>
                        <option value="approved" {% if selected_status == 'approved' %}selected{% endif %}>Approuvé</option>
                        <option value="submitted" {% if selected_status == 'submitted' %}selected{% endif %}>Soumis</option>
                        <option value="refused" {% if selected_status == 'refused' %}selected{% endif %}>Refusé</option>
                        <option value="canceled" {% if selected_status == 'canceled' %}selected{% endif %}>Annulé</option>
                      </select>
                    </div>
                    <!-- Boutons d'action -->
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 order-3">
                      <div class="d-flex gap-1">
                        <button type="button" class="btn btn-light border w-100 text-nowrap px-2" id="export-import-btn">
                          <i class="fas fa-file-import" id="export-import-icon"></i>
                          <span class="d-none d-lg-inline ms-1" id="export-import-text">Importer</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="calendarHistoryTable">
                            <thead class="table-light borderless">
                                <tr class="main-row">
                                    <th class="d-none d-md-table-cell">
                                        <input type="checkbox" id="selectAllHistory">
                                    </th>
                                    <th class="sortable" data-sortable="1" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Employé</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-md-table-cell sortable" data-sortable="2" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Type</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="3" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Date début</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="4" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Date fin</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="5" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Durée</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="6" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Enfants</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-xl-table-cell sortable" data-sortable="7" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Situation</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="8" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Statut</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in leave_requests %}
                                <tr>
                                    <td data-label="Sélection" class="d-none d-md-table-cell">
                                        <input type="checkbox" class="row-check">
                                    </td>
                                    <td data-label="Employé">{{ request.employee.full_name }}</td>
                                    <td data-label="Type" class="d-none d-md-table-cell">
                                        <span class="badge bg-info">{{ request.leave_type.name }}</span>
                                    </td>
                                    <td data-label="Date début" class="d-none d-lg-table-cell">
                                        
                                        {{ request.start_date|date:"d/m/Y" }}
                                    </td>
                                    <td data-label="Date fin" class="d-none d-lg-table-cell">
                                        
                                        {{ request.end_date|date:"d/m/Y" }}
                                    </td>
                                    <td data-label="Durée" class="d-none d-lg-table-cell text-center">
                                        <span class="badge bg-warning text-dark">{{ request.duration }} jour{{ request.duration|pluralize }}</span>
                                    </td>
                                    <td data-label="Enfants" class="d-none d-lg-table-cell text-center">
                                        <span class="badge bg-info">{{ request.employee.children.count }}</span>
                                    </td>
                                    <td data-label="Situation" class="d-none d-xl-table-cell">
                                        {% if request.employee.marital_status == 'S' %}
                                            <span class="badge bg-secondary">Célibataire</span>
                                        {% elif request.employee.marital_status == 'M' %}
                                            <span class="badge bg-success">Marié(e)</span>
                                        {% elif request.employee.marital_status == 'D' %}
                                            <span class="badge bg-warning text-dark">Divorcé(e)</span>
                                        {% elif request.employee.marital_status == 'W' %}
                                            <span class="badge bg-dark">Veuf(ve)</span>
                                        {% else %}
                                            <span class="text-muted">Non défini</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Statut" class="d-none d-lg-table-cell">
                                        {% if request.status == 'approved' %}
                                        <span class="badge bg-success">Approuvé</span>
                                        {% elif request.status == 'submitted' %}
                                        <span class="badge bg-info">Soumis</span>
                                        {% elif request.status == 'refused' %}
                                        <span class="badge bg-danger">Refusé</span>
                                        {% elif request.status == 'canceled' %}
                                        <span class="badge bg-warning">Annulé</span>
                                        {% else %}
                                        <span class="badge bg-secondary">En attente</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Actions" class="actions-cell">
                                        <div class="d-flex gap-1 justify-content-end">
                                            <button class="btn btn-sm btn-light border text-info viewLeaveDetails" data-id="{{ request.request_id }}" title="Voir détails">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-3">Aucune demande de congé trouvée</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                <!-- Pagination Component -->
                <nav class="mt-3">
                  <ul class="pagination justify-content-center flex-wrap" id="calendarHistoryPagination">
                    <li class="page-item disabled">
                      <a class="page-link" href="#" aria-label="Précédent" id="prevPageHistory">
                        <i class="fas fa-chevron-left d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">&laquo; Préc</span>
                      </a>
                    </li>
                    <!-- Les numéros de page seront générés dynamiquement -->
                    <li class="page-item">
                      <a class="page-link" href="#" aria-label="Suivant" id="nextPageHistory">
                        <i class="fas fa-chevron-right d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">Suiv &raquo;</span>
                      </a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
        </div>
    


    <!-- Modal de détails de congé -->
    <div class="modal fade" id="leaveDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Détails de la demande de congé</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header text-white" style="background-color: #1e90ff;">
                                    <h5 class="card-title mb-0">Informations sur l'employé</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Nom:</strong> <span id="employeeName"></span></p>
                                    <p><strong>Département:</strong> <span id="employeeDepartment"></span></p>
                                    <p><strong>Position:</strong> <span id="employeePosition"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">Informations sur le congé</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Type:</strong> <span id="leaveType"></span></p>
                                    <p><strong>Période:</strong> <span id="leavePeriod"></span></p>
                                    <p><strong>Durée:</strong> <span id="leaveDuration"></span> jour(s)</p>
                                    <p><strong>Statut:</strong> <span id="leaveStatus" class="badge"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="card-title mb-0">Informations sur l'approbation</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Décision:</strong> <span id="approvalDecision" class="badge"></span></p>
                                    <p><strong>Traité par:</strong> <span id="approvedBy"></span></p>
                                    <p><strong>Date de décision:</strong> <span id="approvalDate"></span></p>
                                    <p><strong>Commentaires:</strong></p>
                                    <div class="p-2 border rounded bg-light" id="approvalComments"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h5 class="card-title mb-0">Notes de l'employé</h5>
                                </div>
                                <div class="card-body">
                                    <div class="p-2 border rounded bg-light" id="employeeNotes"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">Certificat médical</h5>
                                </div>
                                <div class="card-body">
                                    <div id="certificateContainer">
                                        <div class="text-center">
                                            <a href="#" id="certificateLink" target="_blank" class="btn btn-primary d-none">
                                                <i class="fas fa-file-medical"></i> Voir le certificat
                                            </a>
                                            <div id="certificatePreview" class="mt-3 d-none">
                                                <img id="certificateImage" class="img-fluid border rounded" alt="Aperçu du certificat" />
                                                <small class="d-block text-center text-muted mt-1">
                                                    <i class="fas fa-search-plus"></i> Cliquez sur l'image pour agrandir
                                                </small>
                                            </div>
                                            <p id="noCertificate" class="text-muted">Aucun certificat fourni</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All JavaScript code has been moved to the external file leave_calendar.js -->

{% endblock %}
{% block extra_scripts %}
<link rel="stylesheet" href="{% static 'css/hr-capitalize.css' %}">
<script src="{% static 'vendor/js/bootstrap.bundle.min.js' %}"></script> 
<script src="{% static 'vendor\fullcalendar-5.11.3\lib\main.min.js' %}"></script> 
<script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script> 
<script src="{% static 'js/leave_calendar.js' %}"></script>
{% endblock %}
