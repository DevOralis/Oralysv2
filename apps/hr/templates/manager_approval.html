{% extends "base.html" %}
{% load static %}

{% block title %}Avis Chef Département{% endblock %}

{% block menu %}
  {% include 'hr_menu.html' %}
{% endblock %}

{% block content %}
<div class="content">
  <div class="card mb-4">
    <div class="card-header text-white" style="background-color:#1e90ff;">
      <i class="fas fa-user-tie me-2"></i>Avis du Chef de Département
    </div>
    <div class="card-body">
      <div id="managerApprovalForm">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <!-- Barre de recherche et filtre -->
        <div class="row g-2 mb-3">
          <!-- Recherche -->
          <div class="col-12 col-sm-12 col-md-6 col-lg-6">
            <div class="input-group">
              <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" id="searchApproval" class="form-control border-primary" placeholder="Rechercher une demande...">
            </div>
          </div>
          <!-- Filtre type -->
          <div class="col-12 col-sm-6 col-md-3 col-lg-3">
            <select class="form-select" id="filterType" title="Filtrer par type">
              <option value="">Tous les types</option>
              {% for type in leave_types %}
              <option value="{{ type.name }}">{{ type.name }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Filtre statut -->
          <div class="col-12 col-sm-6 col-md-3 col-lg-3">
            <select class="form-select" id="filterStatus" title="Filtrer par statut">
              <option value="">Tous statuts</option>
              <option value="submitted">Soumis</option>
              <option value="approved">Approuvé</option>
              <option value="refused">Refusé</option>
              <option value="canceled">Annulé</option>
              <option value="draft">Brouillon</option>
            </select>
          </div>
        </div>

        <!-- Tableau des demandes -->
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="approvalTable">
            <thead class="table-light borderless">
              <tr class="main-row">
                <th class="d-none d-md-table-cell">
                  <input type="checkbox" id="selectAll">
                </th>
                <th class="sortable" data-sortable="1" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Employé</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="d-none d-md-table-cell sortable" data-sortable="2" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Type</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="d-none d-lg-table-cell sortable" data-sortable="3" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Date début</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="d-none d-lg-table-cell sortable" data-sortable="4" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Date fin</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="d-none d-lg-table-cell sortable" data-sortable="5" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Durée</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="d-none d-lg-table-cell sortable" data-sortable="6" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Enfants</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="d-none d-xl-table-cell sortable" data-sortable="7" style="cursor: pointer;">
                  <div class="d-flex align-items-center justify-content-between">
                    <span>Situation</span>
                    <i class="fas fa-sort sort-icon ms-1"></i>
                  </div>
                </th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for request in leave_requests %}
              <tr data-status="{{ request.status }}">
                <td data-label="Sélection" class="d-none d-md-table-cell">
                  <input type="checkbox" class="row-check">
                </td>
                <td data-label="Employé">{{ request.employee.full_name }}</td>
                <td data-label="Type" class="d-none d-md-table-cell">
                  <span class="badge bg-info">{{ request.leave_type.name }}</span>
                </td>
                <td data-label="Date début" class="d-none d-lg-table-cell">{{ request.start_date|date:"d/m/Y" }}</td>
                <td data-label="Date fin" class="d-none d-lg-table-cell">{{ request.end_date|date:"d/m/Y" }}</td>
                <td data-label="Durée" class="d-none d-lg-table-cell text-center">
                  <span class="badge bg-warning text-dark">{{ request.duration }} jour{{ request.duration|pluralize }}</span>
                </td>
                <td data-label="Enfants" class="d-none d-lg-table-cell text-center">
                  <span class="badge bg-info">{{ request.employee.children.count }}</span>
                </td>
                <td data-label="Situation" class="d-none d-xl-table-cell">
                  {% if request.employee.marital_status == 'S' %}
                    <span class="badge bg-secondary">Célibataire</span>
                  {% elif request.employee.marital_status == 'M' %}
                    <span class="badge bg-success">Marié(e)</span>
                  {% elif request.employee.marital_status == 'D' %}
                    <span class="badge bg-warning text-dark">Divorcé(e)</span>
                  {% elif request.employee.marital_status == 'W' %}
                    <span class="badge bg-dark">Veuf(ve)</span>
                  {% else %}
                    <span class="text-muted">Non défini</span>
                  {% endif %}
                </td>
<!-- Avis Chef column removed -->
                  
                <td data-label="Actions">
                  <div class="d-flex gap-1 justify-content-end">
                    {% if request.status == 'submitted' %}
                      <button class="btn btn-sm btn-light border text-success managerDecision" data-id="{{ request.request_id }}" data-decision="approved" title="Avis favorable">
                        <i class="fas fa-check"></i>
                      </button>
                      <button class="btn btn-sm btn-light border text-danger managerDecision" data-id="{{ request.request_id }}" data-decision="refused" title="Avis défavorable">
                        <i class="fas fa-times"></i>
                      </button>
                    {% endif %}
                    <button class="btn btn-sm btn-light border text-info viewDetails" data-id="{{ request.request_id }}" title="Voir détails">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center py-4">
                  <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                  <p class="text-muted mb-0">Aucune demande de congé en attente</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav class="mt-3">
          <ul class="pagination justify-content-center flex-wrap" id="approvalPagination">
            <li class="page-item disabled">
              <a class="page-link" href="#" id="prevPageApproval" aria-label="Précédent">
                <i class="fas fa-chevron-left d-block d-sm-none"></i>
                <span class="d-none d-sm-block">&laquo; Préc</span>
              </a>
            </li>
            <!-- Page numbers generated by JS -->
            <li class="page-item">
              <a class="page-link" href="#" id="nextPageApproval" aria-label="Suivant">
                <i class="fas fa-chevron-right d-block d-sm-none"></i>
                <span class="d-none d-sm-block">Suiv &raquo;</span>
              </a>
            </li>
          </ul>
        </nav>

        <!-- Modal décision Chef -->
        <div class="modal fade" id="managerApprovalDecisionModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>Êtes-vous sûr de vouloir <span id="managerApprovalActionType"></span> cette demande de congé ?</p>
                <div class="mb-3">
                  <label for="managerApprovalComments" class="form-label">Commentaire (optionnel)</label>
                  <textarea class="form-control" id="managerApprovalComments" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmManagerApprovalAction">Confirmer</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modal de détails sophistiqué -->
<div class="modal fade" id="managerApprovalDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-xl" style="max-width: 1400px;">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-gradient-primary text-white border-0">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-info-circle me-2"></i>
          Détails de la demande de congé
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-4">
        <!-- Section Employé -->
        <div class="card mb-4 border-0 bg-light">
          <div class="card-body">
            <h6 class="card-title text-primary mb-3">
              <i class="fas fa-user me-2"></i>Informations Employé
            </h6>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-id-badge text-muted me-3"></i>
              <strong>Nom :</strong>
              <span class="ms-2" id="managerDetailEmployee"></span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-building text-muted me-3"></i>
              <strong>Département :</strong>
              <span class="ms-2" id="managerDetailDepartment"></span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-heart text-muted me-3"></i>
              <strong>Situation familiale :</strong>
              <span class="ms-2" id="managerDetailMaritalStatus"></span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-child text-muted me-3"></i>
              <strong>Nombre d'enfants :</strong>
              <span class="ms-2" id="managerDetailChildrenCount"></span>
            </div>
          </div>
        </div>

        <!-- Section Congé -->
        <div class="card mb-4 border-0 bg-light">
          <div class="card-body">
            <h6 class="card-title text-success mb-3">
              <i class="fas fa-calendar-alt me-2"></i>Détails du Congé
            </h6>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-tag text-muted me-3"></i>
              <strong>Type :</strong>
              <span class="ms-2" id="managerDetailType"></span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-clock text-muted me-3"></i>
              <strong>Durée :</strong>
              <span class="ms-2" id="managerDetailDuration"></span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-calendar-check text-muted me-3"></i>
              <strong>Période :</strong>
              <span class="ms-2" id="managerDetailDates"></span>
            </div>
            <div class="d-flex align-items-center mb-3">
              <i class="fas fa-calendar-plus text-muted me-3"></i>
              <strong>Date de demande :</strong>
              <span class="ms-2" id="managerDetailRequestDate"></span>
            </div>
          </div>
        </div>

        <!-- Section Notes et Document -->
        <div class="card border-0 bg-light">
          <div class="card-body">
            <h6 class="card-title text-info mb-3">
              <i class="fas fa-file-alt me-2"></i>Informations Complémentaires
            </h6>
            <div class="mb-3">
              <div class="d-flex align-items-start">
                <i class="fas fa-comment text-muted me-2 mt-1"></i>
                <div>
                  <strong>Notes :</strong>
                  <div class="mt-1 text-muted" id="managerDetailNotes"></div>
                </div>
              </div>
            </div>
            <div id="managerCertificateContainer">
              <div class="d-flex align-items-center">
                <i class="fas fa-paperclip text-muted me-2"></i>
                <strong>Document joint :</strong>
                <a href="#" id="managerDetailCertificate" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                  <i class="fas fa-eye me-1"></i>Voir le document
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0">
        <button type="button" class="btn btn-success d-flex align-items-center" id="managerDetailApprove">
          <i class="fas fa-check me-2"></i>Approuver
        </button>
        <button type="button" class="btn btn-danger d-flex align-items-center" id="managerDetailRefuse">
          <i class="fas fa-times me-2"></i>Refuser
        </button>
        <button type="button" class="btn btn-secondary d-flex align-items-center" data-bs-dismiss="modal">
          <i class="fas fa-arrow-left me-2"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/manager_approval.js' %}"></script>
{% endblock %}