{% extends "base.html" %}
{% load static %}

{% block title %}Gestion des Congés{% endblock %}
{% block menu %}
  {% include 'hr_menu.html' %}
{% endblock %}
{% block content %}
<div class="content">
<div class="card mb-4">
              <div class="card-header text-white" style="background-color: #1e90ff;">
                <i class="fas fa-cogs me-2"></i>
                Types de congés configurés
              </div>
              <div class="card-body">
                <form method="get" id="search-form-leave-types">
                  <div class="row g-2 mb-3">
                    <!-- Barre de recherche -->
                    <div class="col-12 col-sm-12 col-md-9 col-lg-9 order-1">
                      <div class="input-group">
                        <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                          <i class="fas fa-search"></i>
                        </span>
                        <input type="search" id="searchLeaveTypeConfig" name="q" class="form-control border-primary" placeholder="Rechercher un type de congé..." value="">
                      </div>
                    </div>
                    <!-- Bouton exporter -->
                    <div class="col-12 col-sm-12 col-md-3 col-lg-3 order-2">
                      <button type="button" class="btn btn-light border w-100" id="export-import-btn-types">
                        <i class="fas fa-file-import" id="export-import-icon-types"></i>
                        <span class="ms-1" id="export-import-text-types">Importer</span>
                      </button>
                    </div>
                  </div>
                </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="leaveTypeConfigTable">
                            <thead class="table-light borderless">
                                <tr class="main-row">
                                    <th class="d-none d-md-table-cell">
                                        <input type="checkbox" id="selectAllLeaveTypes">
                                    </th>
                                    <th class="sortable" data-sort="leave_type" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Type de congé</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-md-table-cell sortable" data-sort="default_days" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Droits initiaux (jours/an)</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sort="status" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Statut</span>
                                            <i class="fas fa-sort sort-icon text-muted"></i>
                                        </div>
                                     </th>
                                     <th class="d-lg-none text-center">Actions</th>
                                 </tr>
                             </thead>
                            <tbody>
                                {% for type in leave_types %}
                                    {% if type.default_days and type.default_days > 0 %}
                                    <tr>
                                        <td data-label="Sélection" class="d-none d-md-table-cell">
                                            <input type="checkbox" class="row-check">
                                        </td>
                                        <td data-label="Type de congé">
                                            <div class="d-flex align-items-center">
                                                <div class="leave-type-indicator bg-primary me-2"></div>
                                                <strong>{{ type.name }}</strong>
                                            </div>
                                        </td>
                                        <td data-label="Droits initiaux" class="d-none d-md-table-cell">
                                            <span class="badge bg-light text-dark border">
                                                <i class="fas fa-calendar-days me-1"></i>{{ type.default_days }} jours
                                            </span>
                                        </td>
                                        <td data-label="Statut" class="d-none d-lg-table-cell">
                                            {% if type.active %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Actif
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times me-1"></i>Inactif
                                                </span>
                                             {% endif %}
                                         </td>
                                         <td class="d-lg-none text-center" data-label="Actions">
                                             <button type="button" class="btn btn-sm btn-light border text-info" 
                                                     data-bs-toggle="modal" 
                                                     data-bs-target="#leaveTypeDetailsModal"
                                                     data-leave-name="{{ type.name }}"
                                                     data-leave-days="{{ type.default_days }}"
                                                     data-leave-status="{% if type.active %}Actif{% else %}Inactif{% endif %}"
                                                     title="Voir détails">
                                                 <i class="fas fa-eye"></i>
                                             </button>
                                         </td>
                                     </tr>
                                    {% endif %}
                                {% empty %}
                                <tr><td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-info-circle me-2"></i>Aucun type de congé configuré.
                                </td></tr>
                                {% endfor %}
                            </tbody>
                         </table>
                     </div>
                     
                     <script>
                     document.addEventListener('DOMContentLoaded', function() {
                         // Pagination pour types de congés - 5 éléments par page
                         const itemsPerPage = 5;
                         const table = document.getElementById('leaveTypeConfigTable');
                         const tbody = table.querySelector('tbody');
                         const rows = Array.from(tbody.querySelectorAll('tr'));
                         const pagination = document.getElementById('leaveTypePagination');
                                                  let currentPage = 1;
                          const totalPages = Math.ceil(rows.length / itemsPerPage);
                          
                          // Fonction de tri pour les types de congés
                          function setupLeaveTypeConfigSorting() {
                              const sortableHeaders = document.querySelectorAll('#leaveTypeConfigTable .sortable');
                              
                              sortableHeaders.forEach(header => {
                                  header.addEventListener('click', function() {
                                      const sortField = this.dataset.sort;
                                      const currentDirection = this.dataset.direction || 'asc';
                                      const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
                                      
                                      // Mettre à jour l'icône de tri
                                      updateLeaveTypeConfigSortIcons(this, newDirection);
                                      
                                      // Trier le tableau
                                      sortLeaveTypeConfigTable(sortField, newDirection);
                                      
                                      // Réappliquer la pagination
                                      showPage(1);
                                      currentPage = 1;
                                      
                                      // Sauvegarder la direction
                                      this.dataset.direction = newDirection;
                                  });
                              });
                          }

                          function sortLeaveTypeConfigTable(sortField, direction) {
                              rows.sort((a, b) => {
                                  let aValue, bValue;
                                  
                                  switch(sortField) {
                                      case 'leave_type':
                                          aValue = a.querySelector('td:nth-child(2) strong')?.textContent.trim() || '';
                                          bValue = b.querySelector('td:nth-child(2) strong')?.textContent.trim() || '';
                                          break;
                                      case 'default_days':
                                          aValue = a.querySelector('td:nth-child(3) .badge')?.textContent.replace(/[^\d]/g, '') || '0';
                                          bValue = b.querySelector('td:nth-child(3) .badge')?.textContent.replace(/[^\d]/g, '') || '0';
                                          aValue = parseInt(aValue);
                                          bValue = parseInt(bValue);
                                          return direction === 'asc' ? aValue - bValue : bValue - aValue;
                                      case 'status':
                                          aValue = a.querySelector('td:nth-child(4) .badge')?.textContent.trim() || '';
                                          bValue = b.querySelector('td:nth-child(4) .badge')?.textContent.trim() || '';
                                          break;
                                      default:
                                          return 0;
                                  }
                                  
                                  if (typeof aValue === 'string') {
                                      const comparison = aValue.localeCompare(bValue, 'fr', { numeric: true });
                                      return direction === 'asc' ? comparison : -comparison;
                                  }
                                  return 0;
                              });
                          }

                          function updateLeaveTypeConfigSortIcons(activeHeader, direction) {
                              // Réinitialiser toutes les icônes
                              document.querySelectorAll('#leaveTypeConfigTable .sort-icon').forEach(icon => {
                                  icon.className = 'fas fa-sort sort-icon text-muted';
                              });
                              
                              // Mettre à jour l'icône active
                              const activeIcon = activeHeader.querySelector('.sort-icon');
                              if (activeIcon) {
                                  if (direction === 'asc') {
                                      activeIcon.className = 'fas fa-sort-up sort-icon text-primary';
                                  } else {
                                      activeIcon.className = 'fas fa-sort-down sort-icon text-primary';
                                  }
                              }
                          }

                          // Initialiser le tri
                          setupLeaveTypeConfigSorting();
                          
                          function showPage(page) {
                             const start = (page - 1) * itemsPerPage;
                             const end = start + itemsPerPage;
                             
                             rows.forEach((row, index) => {
                                 row.style.display = (index >= start && index < end) ? '' : 'none';
                             });
                             
                             updatePagination(page);
                         }
                         
                         function updatePagination(page) {
                             const prevBtn = document.getElementById('prevPageLeaveType');
                             const nextBtn = document.getElementById('nextPageLeaveType');
                             
                             prevBtn.parentElement.classList.toggle('disabled', page === 1);
                             nextBtn.parentElement.classList.toggle('disabled', page === totalPages);
                             
                             // Nettoyer les anciens numéros de page
                             const pageNumbers = pagination.querySelectorAll('.page-number');
                             pageNumbers.forEach(num => num.remove());
                             
                             // Ajouter les numéros de page
                             for (let i = 1; i <= totalPages; i++) {
                                 const pageItem = document.createElement('li');
                                 pageItem.className = 'page-item page-number';
                                 if (i === page) pageItem.classList.add('active');
                                 
                                 const pageLink = document.createElement('a');
                                 pageLink.className = 'page-link';
                                 pageLink.href = '#';
                                 pageLink.textContent = i;
                                 pageLink.addEventListener('click', (e) => {
                                     e.preventDefault();
                                     showPage(i);
                                 });
                                 
                                 pageItem.appendChild(pageLink);
                                 pagination.insertBefore(pageItem, pagination.querySelector('#nextPageLeaveType').parentElement);
                             }
                         }
                         
                         // Event listeners
                         document.getElementById('prevPageLeaveType').addEventListener('click', (e) => {
                             e.preventDefault();
                             if (currentPage > 1) {
                                 currentPage--;
                                 showPage(currentPage);
                             }
                         });
                         
                         document.getElementById('nextPageLeaveType').addEventListener('click', (e) => {
                             e.preventDefault();
                             if (currentPage < totalPages) {
                                 currentPage++;
                                 showPage(currentPage);
                             }
                         });
                         
                         // Afficher la première page
                         if (rows.length > 0) {
                             showPage(1);
                         } else {
                             // Masquer la pagination si pas de données
                             pagination.style.display = 'none';
                         }
                     });
                     </script>
                     
                     <!-- Pagination Component -->
                     <nav class="mt-3">
                       <ul class="pagination justify-content-center flex-wrap" id="leaveTypePagination">
                         <li class="page-item disabled">
                           <a class="page-link" href="#" aria-label="Précédent" id="prevPageLeaveType">
                             <i class="fas fa-chevron-left d-block d-sm-none"></i>
                             <span class="d-none d-sm-block">&laquo; Préc</span>
                           </a>
                         </li>
                         <!-- Les numéros de page seront générés dynamiquement -->
                         <li class="page-item">
                           <a class="page-link" href="#" aria-label="Suivant" id="nextPageLeaveType">
                             <i class="fas fa-chevron-right d-block d-sm-none"></i>
                             <span class="d-none d-sm-block">Suiv &raquo;</span>
                           </a>
                         </li>
                       </ul>
                     </nav>
                 </div>
             </div>
            
            <!-- Statut des demandes de congés -->
            <div class="card mb-4">
              <div class="card-header text-white" style="background-color: #1e90ff;">
                <i class="fas fa-clipboard-list me-2"></i>
                Statut de mes demandes
              </div>
                <div class="card-body">
                <form method="get" id="search-form-leave-requests">
                  <div class="row g-2 mb-3">
                    <!-- Barre de recherche -->
                    <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
                      <div class="input-group">
                        <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                          <i class="fas fa-search"></i>
                        </span>
                        <input type="search" id="searchLeaveRequest" name="q" class="form-control border-primary" placeholder="Rechercher une demande..." value="">
                      </div>
                    </div>
                    <!-- Filtre statut -->
                    <div class="col-8 col-sm-8 col-md-3 col-lg-3 order-2">
                      <select class="form-select" id="filterLeaveStatus" name="status" title="Filtrer par statut">
                        <option value="">Tous statuts</option>
                        <option value="pending">En attente</option>
                        <option value="approved">Approuvé</option>
                        <option value="rejected">Rejeté</option>
                        <option value="cancelled">Annulé</option>
                      </select>
                    </div>
                    <!-- Boutons d'action -->
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 order-3">
                      <div class="d-flex gap-1">
                        <button type="button" class="btn btn-light border w-100 text-nowrap px-2" id="export-import-btn-requests">
                          <i class="fas fa-file-import" id="export-import-icon-requests"></i>
                          <span class="d-none d-lg-inline ms-1" id="export-import-text-requests">Importer</span>
                        </button>
                        <button type="button" class="btn btn-primary w-100 text-nowrap px-2" data-bs-toggle="modal" data-bs-target="#newLeaveRequestModal">
                          <i class="fas fa-plus"></i>
                          <span class="d-none d-lg-inline ms-1">Nouvelle demande</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </form>
                    <div id="leaveRequestTableBlock">
                        {% include 'leave_request_table_partial.html' %}
                    </div>
                    <!-- Pagination Component -->
                    <nav class="mt-3">
                      <ul class="pagination justify-content-center flex-wrap" id="leaveRequestPagination">
                        <li class="page-item disabled">
                          <a class="page-link" href="#" aria-label="Précédent" id="prevPageLeaveRequest">
                            <i class="fas fa-chevron-left d-block d-sm-none"></i>
                            <span class="d-none d-sm-block">&laquo; Préc</span>
                          </a>
                        </li>
                        <!-- Les numéros de page seront générés dynamiquement -->
                        <li class="page-item">
                          <a class="page-link" href="#" aria-label="Suivant" id="nextPageLeaveRequest">
                            <i class="fas fa-chevron-right d-block d-sm-none"></i>
                            <span class="d-none d-sm-block">Suiv &raquo;</span>
                          </a>
                        </li>
                      </ul>
                    </nav>
                    

                </div>
            </div>

<!-- Modal pour la nouvelle demande de congé -->
<div class="modal fade" id="newLeaveRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nouvelle demande de congé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="leaveRequestForm" method="post" enctype="multipart/form-data" action="javascript:void(0);">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="leaveType" class="form-label">Type de congé *</label>
                                <select class="form-select" id="leaveType" name="leave_type" required>
                                    <option value="">Sélectionnez un type de congé</option>
                                    {% for type in leave_types %}
                                    <option value="{{ type.type_id }}">{{ type.name }}</option>
                                    {% empty %}
                                    <option value="" disabled>Aucun type de congé disponible</option>
                                    {% endfor %}
                                </select>
                                {% if leave_types.count == 0 %}
                                <div class="alert alert-warning mt-2">
                                    <small>Aucun type de congé n'est configuré. Veuillez contacter les RH.</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="startDate" class="form-label">Date de début *</label>
                                <input type="date" class="form-control" id="startDate" name="start_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="endDate" class="form-label">Date de fin</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="endDate" name="end_date">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Commentaires</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="certificate" class="form-label">Certificat médical</label>
                        <input type="file" class="form-control" id="certificate" name="certificate" accept=".pdf,.jpg,.jpeg,.png">
                        <div class="form-text">Format PDF, JPG ou PNG. Maximum 5 MB.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Soumettre</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour modifier une demande de congé -->
<div class="modal fade" id="editLeaveRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier la demande de congé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editLeaveRequestForm" method="post" enctype="multipart/form-data" action="javascript:void(0);">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" id="editRequestId" name="request_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLeaveType" class="form-label">Type de congé *</label>
                                <select class="form-select" id="editLeaveType" name="leave_type" required>
                                    <option value="">Sélectionnez un type de congé</option>
                                    {% for type in leave_types %}
                                    <option value="{{ type.type_id }}">{{ type.name }}</option>
                                    {% empty %}
                                    <option value="" disabled>Aucun type de congé disponible</option>
                                    {% endfor %}
                                </select>
                                {% if leave_types.count == 0 %}
                                <div class="alert alert-warning mt-2">
                                    <small>Aucun type de congé n'est configuré. Veuillez contacter les RH.</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editStartDate" class="form-label">Date de début *</label>
                                <input type="date" class="form-control" id="editStartDate" name="start_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEndDate" class="form-label">Date de fin</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="editEndDate" name="end_date">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Commentaires</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editCertificate" class="form-label">Certificat médical</label>
                        <input type="file" class="form-control" id="editCertificate" name="certificate" accept=".pdf,.jpg,.jpeg,.png">
                        <div class="form-text">Format PDF, JPG ou PNG. Maximum 5 MB.</div>
                        <div id="currentCertificate" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour visualiser les détails d'une demande -->
<div class="modal fade" id="viewLeaveRequestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails de la demande de congé</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">Type de congé</dt>
                    <dd class="col-t-8" id="viewLeaveType"></dd>
                    
                    <dt class="col-sm-4">Statut</dt>
                    <dd class="col-sm-8"><span id="viewStatus" class="badge"></span></dd>
                    
                    <dt class="col-sm-4">Date de début</dt>
                    <dd class="col-sm-8" id="viewStartDate"></dd>
                    
                    <dt class="col-sm-4">Date de fin</dt>
                    <dd class="col-sm-8" id="viewEndDate"></dd>
                    
                    <dt class="col-sm-4">Durée</dt>
                    <dd class="col-sm-8"><span id="viewDuration"></span> jour(s)</dd>
                    
                    <dt class="col-sm-4">Date de demande</dt>
                    <dd class="col-sm-8" id="viewRequestDate"></dd>
                    
                    <dt class="col-sm-4">Commentaires</dt>
                    <dd class="col-sm-8" id="viewNotes"></dd>
                    
                    <div id="viewCertificateSection" style="display: none;">
                        <dt class="col-sm-4">Certificat médical</dt>
                        <dd class="col-sm-8">
                            <a href="#" id="viewCertificateLink" target="_blank">Voir le document</a>
                        </dd>
                    </div>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Leave Type Details -->
<div class="modal fade" id="leaveTypeDetailsModal" tabindex="-1" aria-labelledby="leaveTypeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="leaveTypeDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Détails du type de congé
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="fw-bold">Nom du congé :</label>
                        <p id="modalLeaveName" class="mb-0"></p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="fw-bold">Nombre de jours :</label>
                        <p id="modalLeaveDays" class="mb-0"></p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="fw-bold">Statut :</label>
                        <p id="modalLeaveStatus" class="mb-0"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveTypeDetailsModal = document.getElementById('leaveTypeDetailsModal');
    
    leaveTypeDetailsModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const leaveName = button.getAttribute('data-leave-name');
        const leaveDays = button.getAttribute('data-leave-days');
        const leaveStatus = button.getAttribute('data-leave-status');
        
        document.getElementById('modalLeaveName').textContent = leaveName;
        document.getElementById('modalLeaveDays').textContent = leaveDays + ' jours';
        document.getElementById('modalLeaveStatus').innerHTML = 
            '<span class="badge ' + (leaveStatus === 'Actif' ? 'bg-success' : 'bg-danger') + '">' + leaveStatus + '</span>';
    });
});
</script>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/hr.js' %}?v=1.1"></script>
<script src="{% static 'js/script.js' %}?v=1.1"></script>
<script src="{% static 'js/leave_management.js' %}?v=1.0"></script>

{% endblock %}
