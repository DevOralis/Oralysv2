
{% extends 'base.html' %}
{% load static %}
{% block title %}Oralys - Gestion des Départs{% endblock %}
{% block menu %}
  {% include 'hr_menu.html' %}
{% endblock %}

{% block content %}
<div class="content">
  <div class="row">
    <!-- Carte de la liste des sorties -->
    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-header text-white" style="background-color: #1e90ff;">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>Liste des départs</h5>
        </div>
        <div class="card-body">
          <!-- Search Bar Component -->
          <form method="get" id="search-form">
            <div class="row g-2 mb-3">
              <!-- Barre de recherche -->
              <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
                <div class="input-group">
                  <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="search" id="search-input" name="q" class="form-control border-primary" placeholder="Rechercher un départ..." value="">
                </div>
              </div>
              <!-- Filtre type de sortie -->
              <div class="col-8 col-sm-8 col-md-3 col-lg-3 order-2">
                <select class="form-select" id="filter-type-sortie" title="Filtrer par type de sortie">
                  <option value="">Tous les types</option>
                  {% for value, label in sortie_types %}
                    <option value="{{ label }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <!-- Boutons d'action -->
              <div class="col-4 col-sm-4 col-md-4 col-lg-4 order-3">
                <div class="d-flex gap-1">
                  <button type="button" class="btn btn-light border w-100 text-nowrap px-2" id="export-import-btn">
                    <i class="fas fa-file-export" id="export-import-icon"></i>
                    <span class="d-none d-lg-inline ms-1" id="export-import-text">Exporter</span>
                  </button>
                  <button type="button" class="btn btn-primary w-100 text-nowrap px-2" id="new-sortie-btn">
                    <i class="fas fa-plus"></i>
                    <span class="d-none d-lg-inline ms-1">Nouveau départ</span>
                  </button>
                </div>
              </div>
            </div>
          </form>
          
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="sorties-table">
              <thead class="table-light borderless">
                <tr class="main-row">
                  <th class="d-none d-md-table-cell">
                    <input type="checkbox" id="selectAll">
                  </th>
                  <th class="sortable" data-sort="nom" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                      <span>Nom de l'employé</span>
                      <i class="fas fa-sort sort-icon text-muted"></i>
                    </div>
                  </th>
                  <th class="d-none d-md-table-cell sortable" data-sort="type" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                      <span>Type de départ</span>
                      <i class="fas fa-sort sort-icon text-muted"></i>
                    </div>
                  </th>
                  <th class="d-none d-lg-table-cell">Motif</th>
                  <th class="sortable" data-sort="date" style="cursor: pointer;">
                    <div class="d-flex align-items-center justify-content-between">
                      <span>Date de départ</span>
                      <i class="fas fa-sort sort-icon text-muted"></i>
                    </div>
                  </th>
                  <th class="d-none d-lg-table-cell">Document</th>
                  <th class="d-none d-xl-table-cell">Date de création</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="sorties-table-body">
                {% for sortie in sorties %}
                {% if sortie.type_sortie == 'DEMISSION' %}
                <tr class="align-middle">
                {% elif sortie.type_sortie == 'RETRAITE' %}
                <tr class="align-middle">
                {% elif sortie.type_sortie == 'LICENCIEMENT' %}
                <tr class="align-middle">
                {% else %}
                <tr class="align-middle">
                {% endif %}
                  <td data-label="Sélection" class="d-none d-md-table-cell">
                    <input type="checkbox" class="row-check" value="{{ sortie.id }}">
                  </td>
                  <td data-label="Nom">{{ sortie.employe_nom }}</td>
                  <td data-label="Type" class="d-none d-md-table-cell">
                    {% if sortie.type_sortie == 'DEMISSION' %}
                      <span class="badge bg-warning text-dark">{{ sortie.get_type_sortie_display }}</span>
                      {% elif sortie.type_sortie == 'RETRAITE' %}
                      <span class="badge bg-success">{{ sortie.get_type_sortie_display }}</span>
                      {% elif sortie.type_sortie == 'LICENCIEMENT' %}
                      <span class="badge bg-danger">{{ sortie.get_type_sortie_display }}</span>
                      {% else %}
                      <span class="badge bg-secondary">{{ sortie.get_type_sortie_display }}</span>
                      {% endif %}
                  </td>
                  <td data-label="Motif" class="d-none d-lg-table-cell">{{ sortie.motif|truncatechars:30 }}</td>
                  <td data-label="Date de départ">{{ sortie.date_sortie|date:"d/m/Y" }}</td>
                  <td data-label="Document" class="d-none d-lg-table-cell">
                    {% if sortie.fichier %}
                      <a href="{{ sortie.fichier.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-file-download"></i> <span class="d-none d-xl-inline">Voir</span>
                      </a>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td data-label="Créé le" class="d-none d-xl-table-cell">{{ sortie.cree_le|date:"d/m/Y" }}</td>
                  <td data-label="Actions" class="actions-cell">
                    <div class="d-flex gap-1 justify-content-end">
                      <button class="btn btn-sm btn-light border text-primary view-more-btn" data-id="{{ sortie.id }}" title="Voir plus">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-light border text-dark edit-sortie" data-id="{{ sortie.id }}" title="Modifier">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-light border text-danger delete-sortie" data-id="{{ sortie.id }}" title="Supprimer">
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr class="align-middle">
                  <td colspan="8" class="text-center text-muted">Aucun départ enregistré</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <!-- Pagination Component -->
            <nav class="mt-3">
              <ul class="pagination justify-content-center flex-wrap" id="sortiesPagination">
                <li class="page-item disabled">
                  <a class="page-link" href="#" aria-label="Précédent" id="prevPageSortie">
                    <i class="fas fa-chevron-left d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">&laquo; Préc</span>
                  </a>
                </li>
                <!-- Les numéros de page seront générés dynamiquement -->
                <li class="page-item">
                  <a class="page-link" href="#" aria-label="Suivant" id="nextPageSortie">
                    <i class="fas fa-chevron-right d-block d-sm-none"></i>
                    <span class="d-none d-sm-block">Suiv &raquo;</span>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Carte du formulaire d'ajout (cachée par défaut) -->
    <div class="col-12" id="new-sortie-form" style="display: none;">
      <div class="card">
        <div class="card-header text-white" style="background-color: #1e90ff;">
          <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Ajouter un nouveau départ</h5>
        </div>
        <div class="card-body">
          <form id="sortie-form" method="post">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="employe_nom" class="form-label">Employé</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-user"></i></span>
                  <select class="form-select" id="employe_nom" name="employe_nom" required>
                    <option value="">Sélectionner un employé</option>
                    {% for employee in employees %}
                      <option value="{{ employee.full_name }}">{{ employee.full_name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-md-6 mb-3">
              <label for="type_sortie" class="form-label">Type de départ</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-sign-out-alt"></i></span>
                  <select class="form-select" id="type_sortie" name="type_sortie" required>
                    <option value="">Sélectionner un type</option>
                    {% for value, label in sortie_types %}
                      <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="date_sortie" class="form-label">Date de départ</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                  <input type="date" class="form-control" id="date_sortie" name="date_sortie" required>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="motif" class="form-label">Motif</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-comment"></i></span>
                <textarea class="form-control" id="motif" name="motif" rows="3" required></textarea>
              </div>
            </div>
            <div class="mb-3">
              <label for="fichier" class="form-label">Documents à joindre au dossier</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-upload"></i></span>
                <input type="file" class="form-control" id="fichier" name="fichier">
                <div id="current-file-info" class="form-text"></div>
              </div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" id="cancel-sortie-btn">
                <i class="fas fa-times me-1"></i>Annuler
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Enregistrer
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de modification -->
<div class="modal fade" id="editSortieModal" tabindex="-1" aria-labelledby="editSortieModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header text-white" style="background-color: #1e90ff;">
        <h5 class="modal-title" id="editSortieModalLabel">
          <i class="fas fa-edit me-2"></i>Modifier le départ
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-sortie-form" method="post">
          {% csrf_token %}
          <input type="hidden" id="edit-sortie-id" name="sortie_id">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="edit-employe_nom" class="form-label">Employé</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <select class="form-select" id="edit-employe_nom" name="employe_nom" required>
                  <option value="">Sélectionner un employé</option>
                  {% for employee in employees %}
                    <option value="{{ employee.full_name }}">{{ employee.full_name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="edit-type_sortie" class="form-label">Type de départ</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-sign-out-alt"></i></span>
                <select class="form-select" id="edit-type_sortie" name="type_sortie" required>
                  <option value="">Sélectionner un type</option>
                  {% for value, label in sortie_types %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="edit-date_sortie" class="form-label">Date de départ</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                <input type="date" class="form-control" id="edit-date_sortie" name="date_sortie" required>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit-motif" class="form-label">Motif</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-comment"></i></span>
              <textarea class="form-control" id="edit-motif" name="motif" rows="3" required></textarea>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit-fichier" class="form-label">Documents à joindre au dossier</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-file-upload"></i></span>
              <input type="file" class="form-control" id="edit-fichier" name="fichier">
            </div>
            <div id="current-file-info" class="form-text"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Annuler
        </button>
        <button type="button" class="btn btn-primary" id="save-edit-sortie">
          <i class="fas fa-save me-1"></i>Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de détails d'une sortie -->
<div class="modal fade" id="viewSortieModal" tabindex="-1" aria-labelledby="viewSortieModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header text-white" style="background-color: #17a2b8;">
        <h5 class="modal-title" id="viewSortieModalLabel">
          <i class="fas fa-info-circle me-2"></i>Détails du départ
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Employé</label>
            <p class="form-control-plaintext" id="view-employe-nom">-</p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Type de départ</label>
            <p class="form-control-plaintext" id="view-type-sortie">-</p>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Date de départ</label>
            <p class="form-control-plaintext" id="view-date-sortie">-</p>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-bold">Date de création</label>
            <p class="form-control-plaintext" id="view-date-creation">-</p>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Motif</label>
          <p class="form-control-plaintext" id="view-motif">-</p>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">Document</label>
          <div id="view-document">
            <p class="text-muted">Aucun document attaché</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script>
<script src="{% static 'js/gestion_sorties.js' %}"></script>
<script>
/**
 * Script de gestion des sorties
 * 
 * Fonctionnalités principales :
 * 1. Tri des données du tableau par colonne
 * 2. Gestion des cases à cocher (sélection individuelle et "Tout sélectionner")
 * 3. Bouton d'importation/exportation dynamique :
 *    - Mode Importation : Lorsqu'aucune sortie n'est sélectionnée
 *    - Mode Exportation : Lorsqu'au moins une sortie est sélectionnée
 * 4. Gestion des actions (voir, modifier, supprimer) pour chaque sortie
 * 5. Pagination des résultats
 */
document.addEventListener('DOMContentLoaded', function() {
  // CSRF token helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // --- Gestion du formulaire (Affichage/Masquage) ---
  const newSortieBtn = document.getElementById('new-sortie-btn');
  const cancelSortieBtn = document.getElementById('cancel-sortie-btn');
  const newSortieForm = document.getElementById('new-sortie-form');
  
  if (newSortieBtn) {
    newSortieBtn.addEventListener('click', function() {
      newSortieForm.style.display = 'block';
      newSortieForm.scrollIntoView({ behavior: 'smooth' });
    });
  }
  
  if (cancelSortieBtn) {
    cancelSortieBtn.addEventListener('click', function() {
      newSortieForm.style.display = 'none';
    });
  }

  // --- Gestion de la soumission du formulaire (AJAX) ---
  const sortieForm = document.getElementById('sortie-form');
  if (sortieForm) {
    sortieForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const submitBtn = this.querySelector('button[type="submit"]');
      const sortieIdHidden = document.getElementById('edit-sortie-id');
      const isEdit = sortieIdHidden && sortieIdHidden.value;
      const url = isEdit ? `{% url "modifier_sortie" 0 %}`.replace('0', sortieIdHidden.value) : `{% url "ajouter_sortie" %}`;
      const originalBtnContent = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enregistrement...';
      submitBtn.disabled = true;
      
      fetch(url, {
        method: 'POST',
        body: formData,
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          Swal.fire({ icon: 'success', title: 'Succès!', text: data.message, showConfirmButton: false, timer: 2000 })
          .then(() => { window.location.reload(); });
        } else {
          Swal.fire({ icon: 'error', title: 'Erreur!', text: data.message, showConfirmButton: false, timer: 2000 });
        }
      })
      .catch(error => {
        Swal.fire({ icon: 'error', title: 'Erreur!', text: 'Une erreur est survenue.', showConfirmButton: false, timer: 2000 });
      })
      .finally(() => {
        submitBtn.innerHTML = originalBtnContent;
        submitBtn.disabled = false;
        if (isEdit && sortieIdHidden) {
          sortieIdHidden.remove();
          sortieForm.reset();
          newSortieForm.style.display = 'none';
          const fileInfoDiv = document.getElementById('current-file-info');
          if (fileInfoDiv) fileInfoDiv.innerHTML = '';
        }
      });
    });
  }

  // --- Gestion de la suppression (AJAX) ---
  document.querySelectorAll('.delete-sortie').forEach(button => {
    button.addEventListener('click', function() {
      const sortieId = this.getAttribute('data-id');
      Swal.fire({
        title: 'Êtes-vous sûr?',
        text: "Cette action est irréversible!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Oui, supprimer!',
        cancelButtonText: 'Annuler'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`{% url "supprimer_sortie" 0 %}`.replace('0', sortieId), {
            method: 'POST',
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              Swal.fire({ icon: 'success', title: 'Supprimé!', text: data.message, showConfirmButton: false, timer: 2000 })
              .then(() => { window.location.reload(); });
            } else {
              Swal.fire({ icon: 'error', title: 'Erreur!', text: data.message, showConfirmButton: false, timer: 2000 });
            }
          })
          .catch(error => {
            Swal.fire({ icon: 'error', title: 'Erreur!', text: 'Une erreur est survenue.', showConfirmButton: false, timer: 2000 });
          });
        }
      });
    });
  });

  // --- Gestion de la modification (AJAX) ---
  document.querySelectorAll('.edit-sortie').forEach(button => {
    button.addEventListener('click', function() {
      const sortieId = this.getAttribute('data-id');
      fetch(`{% url "modifier_sortie" 0 %}`.replace('0', sortieId), {
        method: 'GET',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          newSortieForm.style.display = 'block';
          newSortieForm.scrollIntoView({ behavior: 'smooth' });
          document.getElementById('employe_nom').value = data.data.employe_nom;
          document.getElementById('type_sortie').value = data.data.type_sortie;
          document.getElementById('motif').value = data.data.motif;
          document.getElementById('date_sortie').value = data.data.date_sortie;
          const fileInfoDiv = document.getElementById('current-file-info');
          if (fileInfoDiv) {
            if (data.data.fichier_url) {
              fileInfoDiv.innerHTML = `<a href="${data.data.fichier_url}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2"><i class="fas fa-file-download me-1"></i>Fichier actuel</a>`;
            } else {
              fileInfoDiv.innerHTML = '<span class="text-muted fst-italic">Aucun fichier</span>';
            }
          }
          let hiddenId = document.getElementById('edit-sortie-id');
          if (!hiddenId) {
            hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.id = 'edit-sortie-id';
            hiddenId.name = 'sortie_id';
            sortieForm.appendChild(hiddenId);
          }
          hiddenId.value = sortieId;
        } else {
          Swal.fire({ icon: 'error', title: 'Erreur!', text: data.message });
        }
      })
      .catch(() => {
        Swal.fire({ icon: 'error', title: 'Erreur!', text: 'Une erreur est survenue.' });
      });
    });
  });

  // --- Pagination ---
  const tableBody = document.getElementById('sorties-table-body');
  const itemsPerPage = 5;
  let currentPage = 1;
  const sortieRows = Array.from(tableBody.querySelectorAll('tr'));
  const pagination = document.getElementById('sortiesPagination');

  function updatePagination() {
    if (!pagination) return;
    const visibleRows = sortieRows.filter(r => r.style.display !== 'none');
    const totalPages = Math.ceil(visibleRows.length / itemsPerPage);
    pagination.querySelectorAll('.page-item').forEach((li, idx) => {
      if (idx !== 0 && idx !== pagination.children.length - 1) li.remove();
    });
    const prev = pagination.firstElementChild;
    const next = pagination.lastElementChild;
    prev.classList.toggle('disabled', currentPage === 1);
    next.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
    prev.querySelector('a').onclick = e => {
      e.preventDefault();
      if (currentPage > 1) {
        currentPage--;
        displayPage();
      }
    };
    next.querySelector('a').onclick = e => {
      e.preventDefault();
      if (currentPage < totalPages) {
        currentPage++;
        displayPage();
      }
    };
    for (let i = 1; i <= totalPages; i++) {
      const li = document.createElement('li');
      li.className = `page-item ${i === currentPage ? 'active' : ''}`;
      li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
      li.onclick = e => {
        e.preventDefault();
        currentPage = i;
        displayPage();
      };
      pagination.insertBefore(li, next);
    }
  }

  function displayPage() {
    const visibleRows = sortieRows.filter(r => r.style.display !== 'none');
    visibleRows.forEach(r => r.style.display = 'none');
    const start = (currentPage - 1) * itemsPerPage;
    const pageRows = visibleRows.slice(start, start + itemsPerPage);
    pageRows.forEach(r => r.style.display = '');
  }

  updatePagination();
  displayPage();

  // --- Recherche et filtrage combinés ---
  const searchInput = document.getElementById('search-input');
  const filterTypeSortie = document.getElementById('filter-type-sortie');
  
  function filterAndSearchTable() {
    const rows = Array.from(tableBody.getElementsByTagName('tr'));
    const searchTerm = searchInput.value.toLowerCase();
    const filterValue = filterTypeSortie.value.toLowerCase();
    rows.forEach(row => {
      const typeCell = row.querySelector('td[data-label="Type"]');
      const typeText = typeCell ? typeCell.textContent.toLowerCase() : '';
      const rowText = row.textContent.toLowerCase();
      const matchesSearch = rowText.includes(searchTerm);
      const matchesFilter = (filterValue === '') || (typeText.includes(filterValue));
      row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
    currentPage = 1;
    updatePagination();
    displayPage();
  }

  if (searchInput) searchInput.addEventListener('keyup', filterAndSearchTable);
  if (filterTypeSortie) filterTypeSortie.addEventListener('change', filterAndSearchTable);

  // --- Gestion du bouton "Voir plus" ---
  document.querySelectorAll('.view-more-btn').forEach(button => {
    button.addEventListener('click', function() {
      const sortieId = this.getAttribute('data-id');
      Swal.fire({
        title: 'Chargement...',
        text: 'Récupération des détails du départ',
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });

      fetch(`{% url "modifier_sortie" 0 %}`.replace('0', sortieId), {
        method: 'GET',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
      })
      .then(response => response.json())
      .then(data => {
        Swal.close();
        if (data.status === 'success') {
          document.getElementById('view-employe-nom').textContent = data.data.employe_nom || '-';
          document.getElementById('view-type-sortie').textContent = data.data.type_sortie_display || data.data.type_sortie || '-';
          document.getElementById('view-date-sortie').textContent = data.data.date_sortie || '-';
          document.getElementById('view-date-creation').textContent = data.data.cree_le || '-';
          document.getElementById('view-motif').textContent = data.data.motif || '-';
          const documentDiv = document.getElementById('view-document');
          if (data.data.fichier_url) {
            documentDiv.innerHTML = `
              <a href="${data.data.fichier_url}" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-file-download me-1"></i>Voir le document
              </a>
            `;
          } else {
            documentDiv.innerHTML = '<p class="text-muted">Aucun document attaché</p>';
          }
          const modal = new bootstrap.Modal(document.getElementById('viewSortieModal'));
          modal.show();
        } else {
          Swal.fire({ 
            icon: 'error', 
            title: 'Erreur!', 
            text: data.message || 'Impossible de récupérer les détails du départ.'
          });
        }
      })
      .catch(error => {
        Swal.close();
        Swal.fire({ 
          icon: 'error', 
          title: 'Erreur!', 
          text: 'Une erreur est survenue lors de la récupération des données.'
        });
      });
    });
  });

  // --- Tri du tableau ---
  function sortTable(columnIndex, sortType, direction) {
    if (!tableBody) return;
    const rowsToSort = Array.from(tableBody.querySelectorAll('tr'));
    rowsToSort.sort((a, b) => {
      const aValue = a.cells[columnIndex].textContent.trim();
      const bValue = b.cells[columnIndex].textContent.trim();
      let comparison = 0;
      if (sortType === 'date') {
        const dateA = aValue.split('/').reverse().join('-') || '0';
        const dateB = bValue.split('/').reverse().join('-') || '0';
        comparison = dateA.localeCompare(dateB);
      } else {
        comparison = aValue.localeCompare(bValue, undefined, {numeric: true, sensitivity: 'base'});
      }
      return direction === 'asc' ? comparison : -comparison;
    });
    rowsToSort.forEach(row => tableBody.appendChild(row));
    updateSortIcons(document.querySelector(`th[data-sort='${sortType}']`), direction);
  }

  function updateSortIcons(activeHeader, direction) {
    document.querySelectorAll('.sort-icon').forEach(icon => {
      icon.className = 'fas fa-sort sort-icon text-muted ms-1';
    });
    if (activeHeader) {
      const icon = activeHeader.querySelector('.sort-icon');
      icon.className = `fas fa-sort-${direction === 'asc' ? 'up' : 'down'} sort-icon text-primary ms-1`;
    }
  }

  document.querySelectorAll('th.sortable').forEach(header => {
    header.addEventListener('click', function() {
      const sortType = this.dataset.sort;
      const isAsc = this.classList.contains('sort-asc');
      document.querySelectorAll('th.sortable').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
      const newDirection = isAsc ? 'desc' : 'asc';
      this.classList.add(`sort-${newDirection}`);
      const columnIndex = Array.from(this.parentNode.children).indexOf(this);
      sortTable(columnIndex, sortType, newDirection);
    });
  });

  // --- Sélection multiple ---
  const selectAllCheckbox = document.getElementById('selectAll');
  const rowCheckboxes = document.querySelectorAll('.row-check');
  const exportImportBtn = document.getElementById('export-import-btn');
  const exportImportIcon = document.getElementById('export-import-icon');
  const exportImportText = document.getElementById('export-import-text');
  
  function updateExportImportButton() {
    const checkedBoxes = document.querySelectorAll('.row-check:checked');
    if (checkedBoxes.length > 0) {
      exportImportIcon.className = 'fas fa-file-export';
      if (exportImportText) exportImportText.textContent = 'Exporter';
    } else {
      exportImportIcon.className = 'fas fa-file-import';
      if (exportImportText) exportImportText.textContent = 'Importer';
    }
  }
  
  updateExportImportButton();
  
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      rowCheckboxes.forEach(checkbox => { checkbox.checked = this.checked; });
      updateExportImportButton();
    });
  }

  rowCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = Array.from(rowCheckboxes).every(cb => cb.checked);
      }
      updateExportImportButton();
    });
  });

  // --- Bouton Export/Import ---
  if (exportImportBtn) {
    exportImportBtn.addEventListener('click', function() {
      const checkedBoxes = document.querySelectorAll('.row-check:checked');
      const isExport = checkedBoxes.length > 0;
      
      if (isExport) {
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
        Swal.fire({
          icon: 'info',
          title: 'Exportation',
          text: `Exportation de ${checkedBoxes.length} départ(s) sélectionné(s).`,
          confirmButtonText: 'Exporter',
          showCancelButton: true,
          cancelButtonText: 'Annuler'
        }).then((result) => {
          if (result.isConfirmed) {
            console.log('IDs des sorties à exporter:', selectedIds);
            // Implement export logic here
          }
        });
      } else {
        Swal.fire({
          icon: 'info',
          title: 'Création de départ',
          html: `
            <p>Remplissez les données pour le nouveau départ :</p>
            <div class="form-group mt-3">
              <label for="export-name">Nom</label>
              <input type="text" id="export-name" class="form-control" placeholder="Nom du départ">
            </div>
            <div class="form-group mt-2">
              <label for="export-type">Type</label>
              <select id="export-type" class="form-control">
                <option value="">Sélectionnez un type</option>
                <option value="Congé">Congé</option>
                <option value="Formation">Formation</option>
                <option value="Mission">Mission</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
            <div class="form-group mt-2">
              <label for="export-date">Date</label>
              <input type="date" id="export-date" class="form-control">
            </div>
          `,
          confirmButtonText: '<i class="fas fa-save"></i> Sauvegarder',
          showCancelButton: true,
          cancelButtonText: '<i class="fas fa-times"></i> Annuler',
          preConfirm: () => {
            const name = document.getElementById('export-name').value;
            const type = document.getElementById('export-type').value;
            const date = document.getElementById('export-date').value;
            
            if (!name) {
              Swal.showValidationMessage('Veuillez saisir un nom');
              return false;
            }
            if (!type) {
              Swal.showValidationMessage('Veuillez sélectionner un type');
              return false;
            }
            if (!date) {
              Swal.showValidationMessage('Veuillez sélectionner une date');
              return false;
            }
            
            return { name, type, date };
          }
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            const { name, type, date } = result.value;
            const dateParts = date.split('-');
            const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            
            const sortieData = {
              name: name,
              type: type,
              date: formattedDate
            };
            
            console.log('Données de la sortie à enregistrer:', sortieData);
            const formData = new FormData();
            formData.append('name', name);
            formData.append('type', type);
            formData.append('date', date);
            fetch('{% url "ajouter_sortie" %}', {
              method: 'POST',
              body: formData,
              headers: { 'X-CSRFToken': getCookie('csrftoken') }
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                Swal.fire({ icon: 'success', title: 'Succès!', text: data.message, showConfirmButton: false, timer: 2000 })
                .then(() => { window.location.reload(); });
              } else {
                Swal.fire({ icon: 'error', title: 'Erreur!', text: data.message });
              }
            })
            .catch(error => {
              Swal.fire({ icon: 'error', title: 'Erreur!', text: 'Une erreur est survenue.' });
            });
          }
        });
      }
    });
  }
});
</script>
{% endblock %}