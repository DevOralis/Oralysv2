{% extends "base.html" %}
{% load static %}

{% block title %}Approbation des Congés{% endblock %}

{% block menu %}
  {% include 'hr_menu.html' %}
{% endblock %}

{% block content %}
<div class="content hr-capitalize">
    {% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% for message in messages %}
                Swal.fire({
                    icon: '{% if message.tags == "success" %}success{% else %}error{% endif %}',
                    title: '{% if message.tags == "success" %}Succès{% else %}Erreur{% endif %}',
                    text: '{{ message }}',
                    {% if message.tags == "success" %}
                    showConfirmButton: false,
                    timer: 1500,
                    willClose: () => {
                        window.location.reload();
                    }
                    {% endif %}
                });
            {% endfor %}
        });
    </script>
    {% endif %}
            <!-- Leave Requests List -->
            <div class="card mb-4">
              <div class="card-header text-white" style="background-color: #1e90ff;">
                <i class="fas fa-calendar-check me-2"></i>
                Demandes de congés en attente
              </div>
              <div class="card-body">
                <!-- Search Bar Component -->
                <form method="get" id="search-form">
                  <div class="row g-2 mb-3">
                    <!-- Barre de recherche -->
                    <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
                      <div class="input-group">
                        <span class="input-group-text text-white border-primary" style="background-color: #1e90ff;">
                          <i class="fas fa-search"></i>
                        </span>
                        <input type="search" id="searchApproval" name="q" class="form-control border-primary" placeholder="Rechercher une demande..." value="">
                      </div>
                    </div>

                    <!-- Filtre statut -->
                    <div class="col-12 col-sm-6 col-md-3 col-lg-3 order-2">
                      <select class="form-select" id="filterStatus" title="Filtrer par statut">
                        <option value="">Tous statuts</option>
                        <option value="submitted">Soumis</option>
                        <option value="approved">Approuvé</option>
                        <option value="refused">Refusé</option>
                        <option value="canceled">Annulé</option>
                        <option value="draft">Brouillon</option>
                      </select>
                    </div>
                    <!-- Boutons d'action -->
                    <div class="col-4 col-sm-4 col-md-4 col-lg-4 order-3">
                      <div class="d-flex gap-1">
                        <button type="button" class="btn btn-light border w-100 text-nowrap px-2" id="export-import-btn">
                          <i class="fas fa-file-import" id="export-import-icon"></i>
                          <span class="d-none d-lg-inline ms-1" id="export-import-text">Importer</span>
                        </button>
                        <button type="button" class="btn btn-primary w-100 text-nowrap px-2" data-bs-toggle="collapse" data-bs-target="#newLeaveRequest" aria-expanded="false" aria-controls="newLeaveRequest">
                          <i class="fas fa-plus"></i>
                          <span class="d-none d-lg-inline ms-1">Nouvelle demande</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="approvalTable">
                            <thead class="table-light borderless">
                                <tr class="main-row">
                                    <th class="d-none d-md-table-cell">
                                        <input type="checkbox" id="selectAll">
                                    </th>
                                    <th class="sortable" data-sortable="1" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Employé</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-md-table-cell sortable" data-sortable="2" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Type</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="3" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Date début</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="4" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Date fin</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="5" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Durée</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-lg-table-cell sortable" data-sortable="6" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Enfants</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-xl-table-cell sortable" data-sortable="7" style="cursor: pointer;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <span>Situation</span>
                                            <i class="fas fa-sort sort-icon ms-1"></i>
                                        </div>
                                    </th>
                                    <th class="d-none d-xl-table-cell text-center">Avis Chef</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in leave_requests %}
                                <tr data-status="{{ request.status }}">
                                    <td data-label="Sélection" class="d-none d-md-table-cell">
                                        <input type="checkbox" class="row-check">
                                    </td>
                                    <td data-label="Employé">{{ request.employee.full_name }}</td>
                                    <td data-label="Type" class="d-none d-md-table-cell">
                                        <span class="badge bg-info">{{ request.leave_type.name }}</span>
                                    </td>
                                    <td data-label="Date début" class="d-none d-lg-table-cell">
                                        
                                        {{ request.start_date|date:"d/m/Y" }}
                                    </td>
                                    <td data-label="Date fin" class="d-none d-lg-table-cell">
                                        
                                        {{ request.end_date|date:"d/m/Y" }}
                                    </td>
                                    <td data-label="Durée" class="d-none d-lg-table-cell text-center">
                                        <span class="badge bg-warning text-dark">{{ request.duration }} jour{{ request.duration|pluralize }}</span>
                                    </td>
                                    <td data-label="Enfants" class="d-none d-lg-table-cell text-center">
                                        <span class="badge bg-info">{{ request.employee.children.count }}</span>
                                    </td>
                                    <td data-label="Situation" class="d-none d-xl-table-cell">
                                        {% if request.employee.marital_status == 'S' %}
                                            <span class="badge bg-secondary">Célibataire</span>
                                        {% elif request.employee.marital_status == 'M' %}
                                            <span class="badge bg-success">Marié(e)</span>
                                        {% elif request.employee.marital_status == 'D' %}
                                            <span class="badge bg-warning text-dark">Divorcé(e)</span>
                                        {% elif request.employee.marital_status == 'W' %}
                                            <span class="badge bg-dark">Veuf(ve)</span>
                                        {% else %}
                                            <span class="text-muted">Non défini</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Avis Chef" class="d-none d-xl-table-cell text-center">
                                        {% if request.manager_decision == 'approved' %}
                                            <span class="badge bg-success">Favorable</span>
                                        {% elif request.manager_decision == 'refused' %}
                                            <span class="badge bg-danger">Défavorable</span>
                                        {% else %}
                                            <span class="badge bg-secondary">En attente</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Actions" class="actions-cell">
                                        <div class="d-flex gap-1 justify-content-end">
                                            <button class="btn btn-sm btn-light border text-success approveRequest" data-id="{{ request.request_id }}" title="Approuver">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-sm btn-light border text-danger refuseRequest" data-id="{{ request.request_id }}" title="Refuser">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button class="btn btn-sm btn-light border text-info viewDetails" data-id="{{ request.request_id }}" title="Voir détails">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="py-4">
                                            <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">Aucune demande de congé en attente</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                <!-- Pagination Component -->
                <nav class="mt-3">
                  <ul class="pagination justify-content-center flex-wrap" id="approvalPagination">
                    <li class="page-item disabled">
                      <a class="page-link" href="#" aria-label="Précédent" id="prevPageApproval">
                        <i class="fas fa-chevron-left d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">&laquo; Préc</span>
                      </a>
                    </li>
                    <!-- Les numéros de page seront générés dynamiquement -->
                    <li class="page-item">
                      <a class="page-link" href="#" aria-label="Suivant" id="nextPageApproval">
                        <i class="fas fa-chevron-right d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">Suiv &raquo;</span>
                      </a>
                    </li>
                  </ul>
                </nav>
                </div>
            </div>

            <!-- Section pour créer une demande de congé (collapsible) -->
            <div class="collapse" id="newLeaveRequest">
                <div class="card mb-4">
                    <div class="card-header text-white" style="background-color: #1e90ff;">
                        <i class="fas fa-plus me-2"></i>
                        Créer une demande de congé pour un employé
                    </div>
                    <div class="card-body">
                        <form id="hrLeaveRequestForm" method="POST" action="{% url 'submit_leave_request_alt' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="employeeSelect" class="form-label">Employé</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <select class="form-select" id="employeeSelect" name="employee_id" required>
                                            <option value="">Sélectionner un employé</option>
                                            {% for employee in employees %}
                                                <option value="{{ employee.id }}">{{ employee.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="leaveType" class="form-label">Type de congé</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <select class="form-select" id="leaveType" name="leave_type" required>
                                            <option value="">Sélectionner un type</option>
                                            {% for type in leave_types %}
                                                <option value="{{ type.type_id }}">{{ type.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="startDate" class="form-label">Date de début</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-plus"></i></span>
                                        <input type="date" class="form-control" id="startDate" name="start_date" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="endDate" class="form-label">Date de fin</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-minus"></i></span>
                                        <input type="date" class="form-control" id="endDate" name="end_date" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="duration" class="form-label">Durée (jours ouvrables)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                        <input type="number" class="form-control" id="duration" name="duration" min="0.5" step="0.5" required>
                                        <span class="input-group-text">jour(s)</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="certificate" class="form-label">Document justificatif</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-paperclip"></i></span>
                                        <input type="file" class="form-control" id="certificate" name="certificate">
                                    </div>
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="notes" class="form-label">Commentaires</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-comment-alt"></i></span>
                                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Motif de la demande de congé..."></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#newLeaveRequest">
                                    <i class="fas fa-times"></i>
                                    <span class="d-none d-lg-inline ms-1">Annuler</span>
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    <span class="d-none d-lg-inline ms-1">Sauvegarder</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir <span id="actionType"></span> cette demande de congé ?</p>
                <div class="mb-3">
                    <label for="comments" class="form-label">Commentaires</label>
                    <textarea class="form-control" id="comments" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmAction">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de détails sophistiqué -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl" style="max-width: 1400px;">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-gradient-primary text-white border-0">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    Détails de la demande de congé
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Section Employé -->
                <div class="card mb-4 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary mb-3">
                            <i class="fas fa-user me-2"></i>Informations Employé
                        </h6>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-id-badge text-muted me-3"></i>
                            <strong>Nom :</strong>
                            <span class="ms-2" id="detailEmployee"></span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-building text-muted me-3"></i>
                            <strong>Département :</strong>
                            <span class="ms-2" id="detailDepartment"></span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-heart text-muted me-3"></i>
                            <strong>Situation familiale :</strong>
                            <span class="ms-2" id="detailMaritalStatus"></span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-child text-muted me-3"></i>
                            <strong>Nombre d'enfants :</strong>
                            <span class="ms-2" id="detailChildrenCount"></span>
                        </div>
                    </div>
                </div>

                <!-- Section Congé -->
                <div class="card mb-4 border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-success mb-3">
                            <i class="fas fa-calendar-alt me-2"></i>Détails du Congé
                        </h6>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-tag text-muted me-3"></i>
                            <strong>Type :</strong>
                            <span class="ms-2" id="detailType"></span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-clock text-muted me-3"></i>
                            <strong>Durée :</strong>
                            <span class="ms-2" id="detailDuration"></span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-calendar-check text-muted me-3"></i>
                            <strong>Période :</strong>
                            <span class="ms-2" id="detailDates"></span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-calendar-plus text-muted me-3"></i>
                            <strong>Date de demande :</strong>
                            <span class="ms-2" id="detailRequestDate"></span>
                        </div>
                    </div>
                </div>

                <!-- Section Notes et Document -->
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-info mb-3">
                            <i class="fas fa-file-alt me-2"></i>Informations Complémentaires
                        </h6>
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-comment text-muted me-2 mt-1"></i>
                                <div>
                                    <strong>Notes :</strong>
                                    <div class="mt-1 text-muted" id="detailNotes"></div>
                                </div>
                            </div>
                        </div>
                        <div id="certificateContainer">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-paperclip text-muted me-2"></i>
                                <strong>Document joint :</strong>
                                <a href="#" id="detailCertificate" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye me-1"></i>Voir le document
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-success d-flex align-items-center" id="detailApprove">
                    <i class="fas fa-check me-2"></i>Approuver
                </button>
                <button type="button" class="btn btn-danger d-flex align-items-center" id="detailRefuse">
                    <i class="fas fa-times me-2"></i>Refuser
                </button>
                <button type="button" class="btn btn-secondary d-flex align-items-center" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-2"></i>Fermer
                </button>
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<link rel="stylesheet" href="{% static 'css/hr-capitalize.css' %}">
<script src="{% static 'js/leave_approval.js' %}"></script>
{% endblock %}