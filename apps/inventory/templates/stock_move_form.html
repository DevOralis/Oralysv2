{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% if request.session.user.permissions.inventory.update and request.session.user.permissions.inventory.write %}
  {% block extra_head %}
    <link rel="stylesheet" href="{% static 'vendor/css/select2.min.cs' %}">
    <script src="{% static 'vendor/js/select2.min.js' %}"></script>
  {% endblock %}

  {% block menu %}
    {% include 'inventory_menu.html' %}
  {% endblock %}

  {% block content %}
    <div class="content">
      <form method="post" id="move-form" enctype="multipart/form-data" data-state="{{ move.state|default:'draft' }}" data-is-done="{% if move and move.state == 'done' %}true{% else %}false{% endif %}">
        {% csrf_token %}
        <div class="card mb-4">
          <div class="card-header card-header-primary">
            {% if not move or move.state not in 'done,canceled' %}
              <i class="fas fa-edit me-2"></i>
              {% if move %}Modifier un {% else %}Ajouter un nouveau{% endif %} mouvement
            {% endif %}
            {% if move and move.state in 'done,canceled' %}
            <i class="fas fa-exchange-alt me-2"></i>
            {{ move.operation_type.label|upper }}
            {% endif %}
          </div>
          <div class="card-body">     
            {# ------------------- BARRE D'ACTIONS / BADGE D'ÉTAT ------------------- #}
            <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
              <div class="d-flex gap-2 flex-wrap">
                {% if move and move.state == 'done' %}
                  {# Aucun bouton d'action pour les mouvements terminés #}
                {% elif move and move.state == 'canceled' %}
                  {# Aucun bouton d'action pour les mouvements annulés #}
                {% elif not move %}
                  {# Nouveau mouvement : seulement "À faire" #}
                  <button class="btn btn-primary btn-sm me-2 text-nowrap px-2" type="submit" name="action" value="draft">
                    <i class="fas fa-tasks me-1"></i> <span class="d-lg-inline ms-1">À faire</span>
                  </button>
                {% else %}
                  {# Mouvement existant : ajouter bouton "Sauvegarder" + boutons d'état #}
                  <button class="btn btn-primary btn-sm me-2 text-nowrap px-2" type="submit" name="action" value="save">
                    <i class="fas fa-save me-1"></i> <span class="d-none d-lg-inline ms-1">Sauvegarder</span>
                  </button>
                  
                  {% if move.state == 'draft' %}
                    {# Brouillon : "Confirmer" et "Annuler" #}
                    <button class="btn btn-outline-warning btn-sm me-2 text-nowrap px-2" type="submit" name="action" value="confirm">
                      <i class="fas fa-check-circle me-1"></i> <span class="d-none d-lg-inline ms-1">Confirmer</span>
                    </button>
                    <button class="btn btn-outline-danger btn-sm me-2 text-nowrap px-2" type="submit" name="action" value="cancel">
                      <i class="fas fa-times me-1"></i> <span class="d-none d-lg-inline ms-1">Annuler</span>
                    </button>
                  {% elif move.state == 'confirmed' %}
                    {# Confirmé : "Valider" #}
                    <button class="btn btn-outline-success btn-sm me-2 text-nowrap px-2" type="submit" name="action" value="done">
                      <i class="fas fa-check me-1"></i> <span class="d-none d-lg-inline ms-1">Valider</span>
                    </button>
                  {% endif %}
                {% endif %}
              </div>
              <div class="ms-auto d-flex gap-2">
                <span id="move-state-badge" class="badge rounded-pill
                  {% if move and move.state == 'draft'      %}text-bg-primary
                  {% elif move and move.state == 'confirmed' %}text-bg-warning
                  {% elif move and move.state == 'done'      %}text-bg-success
                  {% elif move and move.state == 'canceled'  %}text-bg-secondary
                  {% else %}text-bg-light{% endif %}">
                  {% if move %}
                    {{ move.get_state_display }}
                  {% else %}
                    <span class="d-lg-inline ms-1">À faire</span>
                  {% endif %}
                </span>
              </div>
            </div>

            {# ------------------- INFOS GÉNÉRALES DU MOUVEMENT ------------------- #}
            {% if move and move.state in 'done,canceled' %}          
              <div class="row mb-2">
                <div class="col-12 col-md-6">
                  <strong>Référence :</strong> {{ move.reference }}
                </div>
              </div>
              <div class="row mb-2">
                <div class="col-12 col-md-6">
                  <strong>Date planifiée :</strong> {{ move.scheduled_date|date:'d/m/Y' }}
                </div>
                <div class="col-12 col-md-6">
                  <strong>Date effective :</strong> {{ move.effective_date|date:'d/m/Y' }}
                </div>
              </div>
              <div class="row mb-2">
                {% if 'transfert' in move.operation_type.label|lower %}
                  <div class="col-12 col-md-6">
                    <strong>Emplacement d'origine :</strong> {{ move.source_location|default:'—' }}
                  </div>
                  <div class="col-12 col-md-6">
                    <strong>Emplacement de destination :</strong> {{ move.dest_location|default:'—' }}
                  </div>
                {% elif 'consommation' in move.operation_type.label|lower %}
                  <div class="col-12 col-md-6">
                    <strong>Emplacement d'origine :</strong> {{ move.source_location|default:'—' }}
                  </div>
                  <div class="col-12 col-md-6">
                    <strong>Département :</strong> {{ move.department.name|default:'—' }}
                  </div>
                {% elif 'réception' in move.operation_type.label|lower %}
                  <div class="col-12 col-md-6">
                    <strong>Emplacement de destination :</strong> {{ move.dest_location|default:'—' }}
                  </div>
                  <div class="col-12 col-md-6">
                    <strong>Fournisseur :</strong> {{ move.supplier.name|default:'—' }}
                  </div>
                {% endif %}
              </div>
              {% if move.notes %}
                <div class="row mb-2">
                  <div class="col-12 col-md-12">
                    <strong>Notes :</strong> {{ move.notes }}
                  </div>
                </div>
              {% endif %}
              
              <h6 class="mt-4 mb-2"> <strong>Détail des produits :</strong></h6>
              <table class="table table-bordered table-responsive">
                <thead class="table-light borderless">
                  <tr>
                    <th>Produit</th>
                    <th>Quantité demandée</th>
                    <th>Unité</th>
                    <th>Quantité arrivée</th>
                  </tr>
                </thead>
                <tbody>
                    {% for line in move.lines.all %}
                    <tr>
                      <td data-label="Produit ">{{ line.product.name }}</td>
                      <td data-label="Qté.D ">{{ line.quantity_demanded|floatformat:2 }}</td>
                      <td data-label="Unité ">{{ line.uom.label }}</td>
                      <td data-label="Qté.A ">{{ line.quantity_arrived|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
              </table>
              <div class="mt-3 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                <a href="{% url 'stock_move_list' %}" class="btn btn-secondary">
                  <i class="fas fa-arrow-left me-1"></i> <span class="d-none d-lg-inline ms-1">Retour</span>
                </a>
                {% if move.state == 'done' %}
                  <a href="{% url 'stock_move_delivery_pdf' move.pk %}" class="btn btn-light border" target="_blank">
                    <i class="fas fa-file-pdf"></i> <span class="d-none d-lg-inline ms-1">PDF</span>
                  </a>
                {% endif %}
              </div>
            {% else %}
              <div class="row mb-3">
                <div class="col-12 col-md-6 form-label">
                  {{ move_form.operation_type.label_tag }} 
                  {{ move_form.operation_type }}
                </div>
                <div class="col-12 col-md-6 form-label">
                  {{ move_form.scheduled_date.label_tag }} 
                  {{ move_form.scheduled_date }}
                </div>
              </div>
              {% if move and move.reference %}
                <div class="row mb-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label">Référence :</label>
                    <div class="form-control-plaintext">{{ move.reference }}</div>
                  </div>
                </div>
              {% endif %}
              {# Dates planifiée / effective (readonly) #}
              {% if move and move.state == 'done' %}
                <div class="row mb-3">
                  <div class="col-12 col-md-12">
                    <label>Date planifiée</label>
                    <input type="text" class="form-control mb-2"
                          value="{{ move.scheduled_date|date:'d/m/Y' }}" readonly>
                    <label>Date effective</label>
                    <input type="text" class="form-control"
                          value="{{ move.effective_date|date:'d/m/Y' }}" readonly>
                  </div>
                </div>
              {% endif %}

              {# ------------------- EMPLACEMENTS / DEST / SRC ---------------------- #}
              <div class="row mb-3" id="location-fields">
                <div class="col-12 col-md-6 form-label" id="source-location-col">
                  {{ move_form.source_location.label_tag }} 
                  {{ move_form.source_location }}
                </div>
                <div class="col-12 col-md-6 form-label" id="dest-location-col">
                  {{ move_form.dest_location.label_tag }} 
                  {{ move_form.dest_location }}
                </div>
              </div>

              {# ------------ Champs spécifiques 'consommation' / 'livraison' -------- #}
              <div class="row mb-3" id="department-field" style="display:none;">
                <div class="col-12 col-md-6 form-label">
                  <label for="department-select">Département</label>
                  <select id="department-select" name="department" class="form-select">
                    <option value="">Choisir un département</option>
                    {% for dept in departments %}  
                      <option value="{{ dept.id }}" {% if move.department.id == dept.id %}selected{% endif %}>
                        {{ dept.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              <div class="row mb-3" id="supplier-field" style="display:none;">
                <div class="col-12 col-md-6 form-label">
                  <label for="supplier-select">Fournisseur</label>
                  <select id="supplier-select" name="supplier" class="form-select">
                    <option value="">Choisir un fournisseur</option>
                    {% for sup in suppliers %}
                      <option value="{{ sup.id }}" {% if move and move.supplier and move.supplier.id == sup.id %}selected{% endif %}>
                        {{ sup.name }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>

              {% if not move %}
                <div class="row mb-3" id="order-field" style="display:none;">
                  <div class="col-12 col-md-6 form-label">
                    <label for="order-select">Commande confirmée</label>
                    <select id="order-select" name="order" class="form-select">
                      <option value="">Choisir une commande</option>
                    </select>
                  </div>
                </div>
              {% endif %}

              <div class="form-label">
                {{ move_form.notes.label_tag }} 
                {{ move_form.notes }}
              </div>
              {% if move_form.notes.errors %}
                <div class="errorlist">{{ move_form.notes.errors }}</div>
              {% endif %}

              {# Date effective à dévoiler si état = done #}
              <div class="row mb-3" id="effective-date-field"
                  {% if not move or move.state != 'done' %}class="d-none"{% endif %}>
                <div class="col-12 col-md-6">
                  <label>Date effective</label>
                  <input type="text" class="form-control"
                        value="{{ move.effective_date|default_if_none:'' }}" readonly>
                </div>
              </div>

              {# -------------------- TABLEAU DES PRODUITS -------------------------- #}
              <div id="products-table">
                <table class="table table-responsive table-hover table-middle">
                  <thead class="table-light borderless">
                    <tr class="text-center">
                      <th>Produit</th>
                      <th>Quantité demandée</th>
                      <th>Unité</th>
                      {% if move and move.state == 'done' %}
                        <th id="arrived-column">Quantité arrivée</th>
                      {% endif %}
                      {% if not move or move.state != 'done' %}
                        <th></th>
                      {% endif %}
                    </tr>
                  </thead>
                  <tbody id="move-lines-tbody"><!-- lignes JS --></tbody>
                </table>
                <input type="hidden" name="lines_json" id="lines-json">
                {% if not move or move.state != 'done' %}
                  <a href="#" id="add-row-btn" class="btn btn-outline-primary">
                    <i class="fas fa-plus"></i> <span class="d-sm-inline ms-1">Ajouter une ligne</span>
                  </a>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
    {# --------------------- DATA : produits & lignes -------------------------- #}
    <script type="application/json" id="products-data">
      [
      {% for p in products %}
        {"id":"{{p.pk}}","name":"{{p.name|default:'Produit sans nom'|escapejs}}",
        "uom_id":"{{p.uom.pk}}","uom_label":"{{p.uom.label|escapejs}}"}
        {% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    </script>

    {# --------------------- DATA : stock par produit/emplacement -------------------------- #}
    {{ stock_by_product_location|json_script:"stock-by-product-location" }}

    {% if move_lines %}
      {{ move_lines|json_script:"move-lines-data" }}
    {% endif %}

    {# ---------------------- SweetAlert erreurs form -------------------------- #}
    {% if move_form.non_field_errors %}
      <script>
        window.formErrors = "{{ move_form.non_field_errors.0|escapejs }}";
      </script>
    {% endif %}
  {% endblock %}

  {% block extra_scripts %}
      <script src="{% static 'js/inventory_stock_move.js' %}"></script>
      <script src="{% static 'js/inventory_stock_move_data.js' %}"></script>
  {% endblock %}
{% endif %}