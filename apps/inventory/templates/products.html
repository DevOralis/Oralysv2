{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'vendor\css\sweetalert2.min.css' %}">
{% endblock %}

{% block menu %}
  {% include 'inventory_menu.html' %}
{% endblock %}

{% block content %}
<div class="content">
  <h3 class="border-bottom pb-2">
    <i class="fas fa-box text-primary me-2"></i>
    Gestion des produits
  </h3>
  <!-- Liste des produits -->
  <div class="card mb-4">
    <div class="card-header card-header-primary">
      <i class="fa-solid fa-cart-flatbed me-2"></i>
      Liste des produits
    </div>
    <div class="card-body">
      <form id="search-form" method="get">
        <div class="row g-2 mb-3">
          <!-- Barre de recherche -->
          <div class="col-12 col-sm-12 col-md-5 col-lg-5 order-1">
            <div class="input-group">
              <span class="input-group-text input-group-text-primary">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" name="q" id="product-search" class="form-control search-input-primary" placeholder="Recherche par nom, référence, prix, catégorie, stock min, unité, quantité..." value="{{ request.GET.q }}">
            </div>
          </div>
          <!-- Filtre catégories -->
          <div class="col-8 col-sm-8  col-md-3 col-lg-3 order-2">
            <select name="category" class="form-select" title="Filtrer par catégorie" onchange="this.form.submit()">
              <option value="">Toutes les catégories</option>
              {% for category in categories %}
                <option value="{{ category.label }}" {% if current_category == category.label %}selected{% endif %}>
                  {{ category.label }}
                </option>
              {% endfor %}
            </select>
          </div>
          <!-- Boutons d'action -->
          <div class="col-4 col-sm-4 col-md-4 col-lg-4 order-3">
            <div class="d-flex gap-1">
              <!-- Bouton Importer (visible par défaut) -->
              <button type="button" id="importBtn" class="btn btn-light border w-100 text-nowrap px-2" title="Importer">
                <i class="fas fa-file-import"></i><span class="d-none d-lg-inline ms-1">Importer</span></button>
              
              <!-- Lien Exporter (caché par défaut, visible avec sélection) -->
              <a id="exportLink" class="btn btn-light border w-100 text-nowrap px-2" title="Exporter" href="{% url 'product_export' %}{% if search or current_category %}?{% if search %}q={{ search }}{% endif %}{% if search and current_category %}&{% endif %}{% if current_category %}category={{ current_category }}{% endif %}{% endif %}" style="display: none;">
                <i class="fas fa-file-export"></i><span class="d-none d-lg-inline ms-1">Exporter</span>
              </a>
              {% if request.session.user.permissions.inventory.write %}
              <a class="btn btn-primary w-100 text-nowrap px-2" title="Nouveau Produit" href="{% url 'product_add' %}#product-form-card">
                <i class="fas fa-plus"></i>  <span class="d-none d-lg-inline ms-1">Nouveau Produit</span>
              </a>
              {% endif %}
              </div>
          </div>

        </div>
      </form>

      <table class="table table-responsive table-striped table-hover" id="searchableTable">
        <thead class="table-light borderless">
          <tr class="main-row">
            <th>
              <input type="checkbox" id="selectAll">
            </th>
            <th class="sortable" data-sort-field="default_code">
              <div class="d-flex align-items-center">
                <span>Réf.</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="sortable" data-sort-field="name">
              <div class="d-flex align-items-center">
                <span>Nom</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="category">
              <div class="d-flex align-items-center">
                <span>Catégorie</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="standard_price">
              <div class="d-flex align-items-center">
                <span>Prix</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="stock_minimal">
              <div class="d-flex align-items-center">
                <span>Stock min.</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="uom">
              <div class="d-flex align-items-center">
                <span>U.Mesure</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="total_quantity">
              <div class="d-flex align-items-center">
                <span>Q.Totale</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            {% if request.session.user.permissions.inventory.update or request.session.user.permissions.inventory.delete %}
            <th class="text-center actions-column">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
            {% include 'product_table_body.html' %}
        </tbody>
      </table>
      <!-- Pagination Component -->
      {% if page_obj.has_other_pages %}
      <nav class="mt-3">
        <ul class="pagination justify-content-center flex-wrap">
          {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&q={{ search }}{% endif %}{% if current_category %}{% if search %}&{% else %}&{% endif %}category={{ current_category }}{% endif %}{% if request.GET.sort_by %}&sort_by={{ request.GET.sort_by }}{% endif %}{% if request.GET.sort_order %}&sort_order={{ request.GET.sort_order }}{% endif %}" aria-label="Précédent">
            <i class="fas fa-chevron-left d-block d-sm-none"></i><span class="d-none d-sm-block">&laquo; Préc</span></a>
          </li>
          {% endif %}
          {% for num in page_obj.paginator.page_range %}
          <li class="page-item {% if page_obj.number == num %}active{% endif %}"><a class="page-link" href="?page={{ num }}{% if search %}&q={{ search }}{% endif %}{% if current_category %}{% if search %}&{% else %}&{% endif %}category={{ current_category }}{% endif %}{% if request.GET.sort_by %}&sort_by={{ request.GET.sort_by }}{% endif %}{% if request.GET.sort_order %}&sort_order={{ request.GET.sort_order }}{% endif %}" aria-label="Page {{ num }}">{{ num }}</a></li>
          {% endfor %}
          {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&q={{ search }}{% endif %}{% if current_category %}{% if search %}&{% else %}&{% endif %}category={{ current_category }}{% endif %}{% if request.GET.sort_by %}&sort_by={{ request.GET.sort_by }}{% endif %}{% if request.GET.sort_order %}&sort_order={{ request.GET.sort_order }}{% endif %}" aria-label="Suivant">
            <i class="fas fa-chevron-right d-block d-sm-none"></i><span class="d-none d-sm-block">Suiv &raquo;</span></a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>

  {% if request.session.user.permissions.inventory.write or request.session.user.permissions.inventory.update %}
  <!-- Formulaire produit + emplacements -->
  <div class="card mb-4" id="product-form-card">
    <div class="card-header card-header-primary">
      <i class="fas fa-edit me-2"></i>
      {% if product %}Modifier un {% else %}Ajouter un nouveau{% endif %} produit
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" id="product-form" action="{% if product %}{% url 'product_edit' product.pk %}{% else %}{% url 'product_add' %}{% endif %}">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <input type="hidden" id="product_id" name="id" value="{% if product %}{{ product.pk }}{% endif %}">
        <div class="row">
          <!-- Image Section - Left Side -->
          <div class="col-md-3 text-center">
            <label class="form-label">Image du produit :</label>
            <!-- Image Preview -->
            {% if product and product.image_1920 %}
              <img src="{{ product.image_1920.url }}" alt="Image produit" class="img-thumbnail mt-2 mb-2" style="width: 100%; max-width: 200px;">
            {% else %}
              <div class="img-thumbnail mt-2 mb-2 d-flex align-items-center justify-content-center" style="width: 100%; max-width: 200px; height: 150px; background-color: #f8f9fa;">
                <i class="fas fa-image text-muted" style="font-size: 2rem;"></i>
              </div>
            {% endif %}
            <!-- File Input -->
            <input type="file" name="image_1920" accept="image/*" class="form-control form-control-sm" id="id_image_1920">
            <!-- Clear Checkbox - only when image exists -->
            {% if product and product.image_1920 %}
              <div class="mt-2">
                <input type="checkbox" id="clear-image" name="clear_image" class="form-check-input me-1">
                <label for="clear-image" class="form-check-label">Effacer</label>
              </div>
            {% endif %}
            {% if form.image_1920.errors %}
              <div class="errorlist mt-2">{{ form.image_1920.errors }}</div>
            {% endif %}

            <div class="mt-3">
              <div class="d-flex align-items-center justify-content-center">
                <span class="me-2 form-label">Produit actif:</span>
                <div class="form-check form-switch">
                  {{ form.active }}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Fields Section - Right Side -->
          <div class="col-md-9">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">{{ form.name.label }}</label>
                {{ form.name }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.categ.label }}</label>
                {{ form.categ }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.uom.label }}</label>
                {{ form.uom }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.standard_price.label }}</label>
                {{ form.standard_price }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.barcode.label }}</label>
                {{ form.barcode }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.stock_minimal.label }}</label>
                {{ form.stock_minimal }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.dlc.label }}</label>
                <input type="date" name="dlc" class="form-control" value="{{ form.dlc.value|date:'Y-m-d' }}">
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.weight.label }}</label>
                {{ form.weight }}
              </div>
              <div class="col-md-4">
                <label class="form-label">{{ form.volume.label }}</label>
                {{ form.volume }}
              </div>
              <div class="col-12">
                <label class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% if form.description.errors %}
                  <div class="errorlist">{{ form.description.errors }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Bloc 3 : Stock par emplacement -->
        <hr>
          <table class="table table-sm table-hover table-responsive" id="pl-table">
            <thead class="table-light">
              <tr>
                <th class="d-none d-lg-table-cell">
                  <div class="d-flex align-items-center">
                    <span>Emplacement</span>
                  </div>
                </th>
                <th class="d-none d-lg-table-cell">
                  <div class="d-flex align-items-center">
                    <span>Quantité</span>
                  </div>
                </th>
                <th class="actions-column text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="pl-table-body">
              <!-- Les lignes seront générées par JS -->
            </tbody>
          </table>
        <input type="hidden" name="locations_json" id="locations-json">
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2 mb-3">
          <button type="button" class="btn btn-sm btn-outline-primary" id="add-pl-line">
            <i class="fas fa-plus text-center"></i> 
            <span class="d-none d-sm-inline ms-1">Ajouter un emplacement</span>
            <span class="d-inline d-sm-none ms-1"></span>
          </button>
          <div class="fw-bold">
            <span>Quantité totale :</span> 
            <span id="total-qty" class="total-qty text-primary">0</span>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-end mt-4">
          <a href="{% url 'product_list' %}" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-up"></i><span class="d-none d-sm-inline ms-1">Retour</span></a>
           <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i><span class="d-none d-sm-inline ms-1">Sauvegarder</span></button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Données des emplacements pour JavaScript -->
  <script type="application/json" id="locations-data">
    [
      {% for location in locations %}
        {"id": {{ location.pk }}, "name": "{{ location.name|escapejs }}"} {% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  </script>
  
  <!-- Données des emplacements de produits -->
  <script type="application/json" id="product-locations-data">{{ product_locations|default:"[]"|safe }}</script>
  
  <!-- Variables globales pour JavaScript -->
  <script>
    {% if product %}window.isEditMode = true;{% else %}window.isEditMode = false;{% endif %}
    {% if swal_success %}window.swalSuccess = '{{ swal_success|escapejs }}';{% endif %}
    {% if swal_error %}window.swalError = '{{ swal_error|escapejs }}';{% endif %}
  </script>
</div>
{% endblock %}

{% block extra_scripts %}
 <script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script>
<script src="{% static 'js/inventory_products_data.js' %}"></script>
<script src="{% static 'js/inventory_products.js' %}"></script>
{% endblock %}