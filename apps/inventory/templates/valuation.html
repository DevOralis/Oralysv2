{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'vendor\css\sweetalert2.min.css' %}">
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block menu %}
  {% include 'inventory_menu.html' %}
{% endblock %}

{% block content %}
<div class="content">
  <h3 class="border-bottom pb-2">
    <i class="fas fa-clipboard-list text-primary me-2"></i>
    Gestion d'inventaire
  </h3>
  <div class="card mb-4">
    <div class="card-header card-header-primary">
      <i class="fas fa-coins me-2"></i>
      Valeur des produits
    </div>
    <div class="card-body">
      <form id="search-form" method="get">
        <div class="row g-2 mb-3">
          <div class="col-12 col-sm-12 col-md-6 col-lg-6 order-1">
            <div class="input-group">
              <span class="input-group-text input-group-text-primary">
                <i class="fas fa-search"></i>
              </span>
              <input type="search" name="q" id="search-input" class="form-control border-primary" placeholder="Recherche par nom, référence, catégorie, prix, quantité..." value="{{ request.GET.q }}">
            </div>
          </div>
          <div class="col-8 col-sm-8  col-md-4 col-lg-4 order-2">
            <select name="category" class="form-select" title="Filtrer par catégorie" onchange="this.form.submit()">
              <option value="">Toutes les catégories</option>
              {% for category in categories %}
                <option value="{{ category.label }}" {% if current_category == category.label %}selected{% endif %}>
                  {{ category.label }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-4 col-sm-4 col-md-2 col-lg-2 order-3">
            <div class="d-flex gap-1">  
              <button type="button" id="generate-val-pdf" class="btn btn-light border w-100 text-nowrap px-2" title="Générer PDF">
                <i class="fas fa-file-pdf"></i><span class="d-none d-lg-inline ms-1">PDF</span>
              </button>
            </div>
          </div>
        </div>
      </form>
      
      <table class="table table-responsive table-hover " id="product-table">
        <thead class="table-light borderless">
          <tr class="main-row">
            <th class="sortable" data-sort-field="default_code">
              <div class="d-flex align-items-center">
                <span>Référence</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="sortable" data-sort-field="name">
              <div class="d-flex align-items-center">
                <span>Nom</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="category">
              <div class="d-flex align-items-center">
                <span>Catégorie</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="total_quantity">
              <div class="d-flex align-items-center">
                <span>Quantité Totale</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="standard_price">
              <div class="d-flex align-items-center">
                <span>Prix Unitaire</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th class="d-none d-lg-table-cell sortable" data-sort-field="total_price">
              <div class="d-flex align-items-center">
                <span>Prix Total</span>
                <i class="fas fa-sort ms-1 text-muted"></i>
              </div>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody id="product-table-body">
          <tr><td colspan="7" class="loading">Chargement des produits...</td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="d-none d-lg-table-cell"></td>
            <td class="total-price text-end d-none d-lg-table-cell">Total Stock :</td>
            <td class="total-price d-none d-lg-table-cell">
              <span id="totalStockValue">0.00</span>
            </td>
            <td class="d-none d-lg-table-cell"></td>
            <!-- Version mobile dans la même ligne -->
            <td colspan="7" class="text-center bg-light p-3 d-lg-none">
              <strong>Total Stock : <span id="totalStockValueMobile">0.00</span></strong>
            </td>
          </tr>
        </tfoot>
      </table>

      <nav class="mt-3">
        <ul class="pagination justify-content-center flex-wrap" id="pagination">
          <!-- Populé dynamiquement -->
        </ul>
      </nav>
    </div>
  </div>

  <!-- Modal pour affichage mobile des emplacements -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-gradient-primary text-white">
          <h5 class="modal-title" id="locationModalLabel">
            <i class="fas fa-map-marker-alt me-2"></i>
            <span id="modalProductName">Détails des emplacements</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th><i class="fas fa-warehouse me-1"></i>Emplacement</th>
                  <th><i class="fas fa-boxes me-1"></i>Quantité</th>
                  <th><i class="fas fa-tag me-1"></i>Prix Unitaire</th>
                  <th><i class="fas fa-coins me-1"></i>Prix Total</th>
                </tr>
              </thead>
              <tbody id="modalLocationTableBody">
                <!-- Contenu dynamique -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            Total des emplacements : <span id="modalTotalLocations">0</span>
          </small>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i>Fermer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script>
<script src="{% static 'js/inventory_valuation.js' %}"></script>
{% endblock %}