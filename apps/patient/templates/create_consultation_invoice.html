{% extends 'base.html' %}
{% load widget_tweaks %}

{% block menu %}
  {% include 'patient_menu.html' %}
{% endblock %}

{% block title %}Créer Consultation et Facture{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>Créer une Consultation et Facture</h2>
                <a href="{% url 'patient:consultation_invoice_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Retour à la liste
                </a>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        Nouvelle Consultation
                    </h5>
                </div>
                
                <div class="card-body">
                    <form method="post" id="consultationInvoiceForm">
                        {% csrf_token %}
                        
                        <!-- Informations Patient et Médecin -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Informations de base</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label required text-primary">Patient</label>
                                        <select class="form-select border-primary" name="patient_id" id="patient_id" required>
                                            <option value="">Sélectionner un patient...</option>
                                            {% for patient in patients %}
                                                <option value="{{ patient.id }}">
                                                    {{ patient.last_name }} {{ patient.first_name }}
                                                    {% if patient.cin %} - CIN: {{ patient.cin }}{% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-primary">Médecin</label>
                                        <select class="form-select border-primary" name="medecin_id" id="medecin_id">
                                            <option value="">Sélectionner un médecin...</option>
                                            {% for medecin in medecins %}
                                                <option value="{{ medecin.id }}">
                                                    {{ medecin.full_name }}
                                                    {% if medecin.speciality %} - {{ medecin.speciality.name }}{% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sélection des Actes -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-stethoscope me-2"></i>Actes réalisés</h6>
                            </div>
                            <div class="card-body">
                                <div class="border border-success rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8fff9;">
                                    <div class="row">
                                        {% for acte in actes %}
                                            <div class="col-md-6 col-lg-4 mb-3">
                                                <div class="card h-100 border-light shadow-sm acte-card">
                                                    <div class="card-body p-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input acte-checkbox" 
                                                                   type="checkbox" 
                                                                   name="actes" 
                                                                   value="{{ acte.id }}" 
                                                                   id="acte_{{ acte.id }}"
                                                                   data-price="{{ acte.price }}">
                                                            <label class="form-check-label w-100" for="acte_{{ acte.id }}">
                                                                <strong class="text-primary">{{ acte.libelle }}</strong><br>
                                                                <span class="badge bg-primary">{{ acte.price|floatformat:2 }} DH</span>
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="form-text text-success"><i class="fas fa-info-circle me-1"></i>Sélectionnez les actes réalisés pour cette consultation</small>
                            </div>
                        </div>

                        <!-- Résumé des coûts -->
                        <div class="row mb-4">
                            <div class="col-md-6 offset-md-6">
                                <div class="card border-warning shadow">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Résumé financier</h6>
                                    </div>
                                    <div class="card-body bg-light">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="fas fa-coins me-1 text-primary"></i>Total HT:</span>
                                            <strong id="total-ht" class="text-primary">0.00 DH</strong>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span><i class="fas fa-percentage me-1 text-info"></i>TVA (20%):</span>
                                            <span id="tva-amount" class="text-info">0.00 DH</span>
                                        </div>
                                        <hr class="my-2 border-primary">
                                        <div class="d-flex justify-content-between">
                                            <strong class="text-success"><i class="fas fa-receipt me-1"></i>Total TTC:</strong>
                                            <strong id="total-ttc" class="text-success fs-5">0.00 DH</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Commentaires -->
                        <div class="card mb-4 border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-comment me-2"></i>Commentaires et notes</h6>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control border-secondary" 
                                          name="commentaires" 
                                          rows="4" 
                                          placeholder="Ajoutez vos commentaires sur la consultation, le diagnostic, le traitement..."></textarea>
                                <small class="form-text text-muted"><i class="fas fa-info-circle me-1"></i>Ces informations apparaîtront sur la facture si nécessaire</small>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <div class="d-flex justify-content-center gap-3">
                                    <button type="submit" class="btn btn-primary btn-lg shadow" id="submitBtn">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>
                                        Créer Consultation et Facture
                                    </button>
                                    <a href="{% url 'patient:consultation_invoice_list' %}" class="btn btn-outline-secondary btn-lg">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Annuler et retour
                                    </a>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    La facture sera automatiquement générée après la création de la consultation
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const acteCheckboxes = document.querySelectorAll('.acte-checkbox');
    const totalHtElement = document.getElementById('total-ht');
    const tvaAmountElement = document.getElementById('tva-amount');
    const totalTtcElement = document.getElementById('total-ttc');
    const submitBtn = document.getElementById('submitBtn');
    
    function updateTotals() {
        let totalHt = 0;
        
        acteCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                totalHt += parseFloat(checkbox.dataset.price || 0);
            }
        });
        
        const tvaAmount = totalHt * 0.20; // 20% TVA
        const totalTtc = totalHt + tvaAmount;
        
        totalHtElement.textContent = totalHt.toFixed(2) + ' DH';
        tvaAmountElement.textContent = tvaAmount.toFixed(2) + ' DH';
        totalTtcElement.textContent = totalTtc.toFixed(2) + ' DH';
        
        // Désactiver le bouton si aucun acte sélectionné
        submitBtn.disabled = totalHt === 0;
    }
    
    acteCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTotals);
    });
    
    // Validation du formulaire
    document.getElementById('consultationInvoiceForm').addEventListener('submit', function(e) {
        const patientId = document.getElementById('patient_id').value;
        const checkedActes = document.querySelectorAll('.acte-checkbox:checked');
        
        if (!patientId) {
            e.preventDefault();
            alert('Veuillez sélectionner un patient');
            return false;
        }
        
        if (checkedActes.length === 0) {
            e.preventDefault();
            alert('Veuillez sélectionner au moins un acte');
            return false;
        }
    });
    
    // Mise à jour initiale des totaux
    updateTotals();
});
</script>

<style>
.required::after {
    content: " *";
    color: red;
}

.form-check-input:checked + .form-check-label {
    background-color: #e3f2fd;
    border-radius: 8px;
    padding: 8px;
    border: 2px solid #2196f3;
}

.card-body h6 {
    color: #495057;
    margin-bottom: 15px;
}

.acte-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.acte-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(33, 150, 243, 0.3) !important;
}

.acte-card input[type="checkbox"]:checked + label .card {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.border-primary {
    border-color: #0d6efd !important;
}

.border-info {
    border-color: #0dcaf0 !important;
}

.border-success {
    border-color: #198754 !important;
}

.border-warning {
    border-color: #ffc107 !important;
}

.border-secondary {
    border-color: #6c757d !important;
}
</style>
{% endblock %}
