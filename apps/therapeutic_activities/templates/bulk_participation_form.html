{% extends 'base.html' %}
{% load static %}
{% block title %}{{ page_title }}{% endblock %}

{% block menu %}
  {% include 'therapeutic_activities_menu.html' %}
{% endblock %}

{% block content %}
<div class="content">
  <h3 class="border-bottom pb-2">
    <i class="fas fa-users text-primary me-2"></i>
    Participation en masse
  </h3>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header text-white" style="background-color: #1e90ff;">
          <i class="fas fa-users-cog me-2"></i>Inscription en Masse
        </div>
        <div class="card-body">
          <form method="post" id="bulkParticipationForm">
            {% csrf_token %}
            
            <!-- Session -->
            <div class="mb-4">
              <label for="{{ form.session.id_for_label }}" class="form-label">
                Session : 
              </label>
              <select name="{{ form.session.name }}" id="{{ form.session.id_for_label }}" class="form-control" required>
                <option value="">Choisir une session...</option>
                {% for session in sessions %}
                  <option value="{{ session.id }}" {% if form.session.value == session.id %}selected{% endif %}>
                    {{ session.activity.title }} - {{ session.date|date:"d/m/Y" }} 
                    ({{ session.start_time }} - {{ session.end_time }}) 
                    - {{ session.location.name }}
                  </option>
                {% endfor %}
              </select>
              {% if form.session.errors %}
                <div class="text-danger mt-1">{{ form.session.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Sélection des patients -->
            <div class="mb-4">
              <label class="form-label">
                Patients : 
              </label>
              
              <!-- Barre de recherche -->
              <div class="mb-3">
                <div class="input-group">
                  <span class="input-group-text input-group-text-primary">
                    <i class="fas fa-search"></i>
                  </span>
                  <input type="text" id="patientSearch" class="form-control search-input-primary" 
                         placeholder="Rechercher des patients...">
                  <button type="button" class="btn btn-outline-primary" onclick="selectAllPatients()" id="selectAllBtn">
                    <span id="selectAllText">Tout sélectionner</span>
                    <span id="selectAllCount" class="badge bg-primary ms-1" style="display: none;"></span>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="deselectAllPatients()">
                    Tout désélectionner
                  </button>
                </div>
              </div>
              <!-- Liste des patients avec checkbox et pagination -->
              <div class="border rounded p-3">
                <div class="row" id="patientsList">
                  {% for patient in patients %}
                  <div class="col-md-6 mb-2 patient-item" data-patient-id="{{ patient.id }}" data-patient-name="{{ patient.get_full_name|lower }}">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" 
                             name="{{ form.patients.name }}" value="{{ patient.id }}"
                             id="patient_{{ patient.id }}">
                      <label class="form-check-label" for="patient_{{ patient.id }}">
                        <div class="d-flex align-items-center">
                          <div class="avatar-sm bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center">
                            <i class="fas fa-user"></i>
                          </div>
                          <div>
                            <strong>{{ patient.get_full_name }}</strong>
                            {% if patient.birth_date %}
                              <br><small class="text-muted">Né le {{ patient.birth_date|date:"d/m/Y" }}</small>
                            {% endif %}
                            {% if patient.phone %}
                              <br><small class="text-muted">{{ patient.phone }}</small>
                            {% endif %}
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                
                <!-- Pagination Controls -->
                <nav class="mt-3" id="patientsPagination" style="display: none;">
                  <ul class="pagination justify-content-center mb-0">
                    <li class="page-item" id="prevPagePatients">
                      <button class="page-link" type="button">
                        <i class="fas fa-chevron-left d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">« Préc</span>
                      </button>
                    </li>
                    <!-- Page numbers will be inserted here -->
                    <li class="page-item" id="nextPagePatients">
                      <button class="page-link" type="button">
                        <i class="fas fa-chevron-right d-block d-sm-none"></i>
                        <span class="d-none d-sm-block">Suiv »</span>
                      </button>
                    </li>
                  </ul>
                </nav>
              </div>
              
              <div class="mt-2 d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  <span id="selectedCount">0</span> patient(s) sélectionné(s) sur <span id="totalCount">{{ patients|length }}</span>
                </small>
                <small class="text-muted" id="pageInfo" style="display: none;">
                  Page <span id="currentPage">1</span> sur <span id="totalPages">1</span>
                </small>
              </div>
              {% if form.patients.errors %}
                <div class="text-danger mt-1">{{ form.patients.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Statut par défaut -->
            <div class="mb-4">
              <label for="{{ form.default_status.id_for_label }}" class="form-label">
                Statut par défaut : 
              </label>
              <select name="{{ form.default_status.name }}" id="{{ form.default_status.id_for_label }}" class="form-control" required>
                <option value="">Sélectionner un statut par défaut...</option>
                <option value="present" {% if form.default_status.value == 'present' %}selected{% endif %}>
                  Présent
                </option>
                <option value="absent" {% if form.default_status.value == 'absent' %}selected{% endif %}>
                  Absent
                </option>
                <option value="excused" {% if form.default_status.value == 'excused' %}selected{% endif %}>
                  Excusé
                </option>
              </select>
              {% if form.default_status.errors %}
                <div class="text-danger mt-1">{{ form.default_status.errors.0 }}</div>
              {% endif %}
            </div>
            <!-- Notes communes -->
            <div class="mb-4">
              <label for="{{ form.notes.id_for_label }}" class="form-label">
                Notes communes : 
              </label>
              <textarea name="{{ form.notes.name }}" id="{{ form.notes.id_for_label }}" 
                        class="form-control" rows="3" 
                        placeholder="Notes qui seront appliquées à toutes les participations...">{{ form.notes.value|default:'' }}</textarea>
              <small class="form-text text-muted">
                Ces notes seront appliquées à toutes les participations créées
              </small>
              {% if form.notes.errors %}
                <div class="text-danger mt-1">{{ form.notes.errors.0 }}</div>
              {% endif %}
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-end">
              <div class="me-2">
                <button type="button" class="btn btn-sm btn-secondary" onclick="window.history.back()">
                  <i class="fas fa-times"></i><span>Annuler</span>
                </button>
              </div>
              <div class="ms-2">
                <button type="submit" class="btn btn-sm btn-primary" id="submitBtn" disabled>
                  <i class="fas fa-save"></i><span>Sauvegarder</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
.avatar-sm {
  width: 32px;
  height: 32px;
  font-size: 14px;
}

.form-check-label {
  cursor: pointer;
  width: 100%;
}

.patient-item {
  transition: all 0.2s ease;
}

.patient-item:hover {
  background-color: #f8f9fa;
  border-radius: 5px;
}
</style>

<script>
// Pagination and patient management
let currentPage = 1;
let patientsPerPage = 6; // Show 5 patients per page
let allPatients = [];
let filteredPatients = [];
let globalSelectedPatients = new Set(); // Track all selected patients across pages

document.addEventListener('DOMContentLoaded', function() {
  const patientCheckboxes = document.querySelectorAll('input[name="patients"]');
  const selectedCountSpan = document.getElementById('selectedCount');
  const totalCountSpan = document.getElementById('totalCount');
  const submitBtn = document.getElementById('submitBtn');
  const searchInput = document.getElementById('patientSearch');
  
  // Initialize patients array
  allPatients = Array.from(document.querySelectorAll('.patient-item')).map(item => ({
    element: item,
    id: item.dataset.patientId,
    name: item.dataset.patientName,
    checkbox: item.querySelector('input[type="checkbox"]')
  }));
  
  filteredPatients = [...allPatients];
  
  // Initialize pagination if needed
  if (allPatients.length > patientsPerPage) {
    initializePagination();
  }
  
  // Show first page
  showPage(1);

  // Update selected count and submit button state
  function updateSelectedCount() {
    selectedCountSpan.textContent = globalSelectedPatients.size;
    submitBtn.disabled = globalSelectedPatients.size === 0;
    
    // Update select all button text
    const selectAllText = document.getElementById('selectAllText');
    const selectAllCount = document.getElementById('selectAllCount');
    
    if (globalSelectedPatients.size > 0) {
      selectAllText.textContent = 'Tout désélectionner';
      selectAllCount.textContent = globalSelectedPatients.size;
      selectAllCount.style.display = 'inline';
    } else {
      selectAllText.textContent = 'Tout sélectionner';
      selectAllCount.style.display = 'none';
    }
  }

  // Search functionality
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm === '') {
      filteredPatients = [...allPatients];
    } else {
      filteredPatients = allPatients.filter(patient => 
        patient.name.includes(searchTerm)
      );
    }
    
    currentPage = 1;
    if (filteredPatients.length > patientsPerPage) {
      initializePagination();
    } else {
      document.getElementById('patientsPagination').style.display = 'none';
      document.getElementById('pageInfo').style.display = 'none';
    }
    showPage(1);
  });

  // Add event listeners to checkboxes (delegated)
  document.getElementById('patientsList').addEventListener('change', function(e) {
    if (e.target.type === 'checkbox' && e.target.name === 'patients') {
      const patientId = e.target.value;
      if (e.target.checked) {
        globalSelectedPatients.add(patientId);
      } else {
        globalSelectedPatients.delete(patientId);
      }
      updateSelectedCount();
    }
  });

  // Initialize pagination
  function initializePagination() {
    const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
    const pagination = document.getElementById('patientsPagination');
    const pageInfo = document.getElementById('pageInfo');
    
    if (totalPages > 1) {
      pagination.style.display = 'block';
      pageInfo.style.display = 'block';
      document.getElementById('totalPages').textContent = totalPages;
      
      // Add page number buttons
      const prevButton = document.getElementById('prevPagePatients');
      const nextButton = document.getElementById('nextPagePatients');
      
      // Remove existing page numbers
      const existingPages = pagination.querySelectorAll('.page-number');
      existingPages.forEach(page => page.remove());
      
      // Add new page numbers
      for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        const pageItem = document.createElement('li');
        pageItem.className = 'page-item page-number';
        pageItem.innerHTML = `<button class="page-link" type="button">${i}</button>`;
        pageItem.addEventListener('click', () => showPage(i));
        nextButton.parentNode.insertBefore(pageItem, nextButton);
      }
      
      // Previous button
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) showPage(currentPage - 1);
      });
      
      // Next button  
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) showPage(currentPage + 1);
      });
    } else {
      pagination.style.display = 'none';
      pageInfo.style.display = 'none';
    }
  }

  // Show specific page
  function showPage(page) {
    currentPage = page;
    const startIndex = (page - 1) * patientsPerPage;
    const endIndex = startIndex + patientsPerPage;
    
    // Hide all patients
    allPatients.forEach(patient => {
      patient.element.style.display = 'none';
    });
    
    // Show patients for current page
    const patientsToShow = filteredPatients.slice(startIndex, endIndex);
    patientsToShow.forEach(patient => {
      patient.element.style.display = 'block';
      // Restore checkbox state from global selection
      patient.checkbox.checked = globalSelectedPatients.has(patient.id);
    });
    
    // Update pagination UI
    document.getElementById('currentPage').textContent = page;
    
    // Update page buttons
    const pageButtons = document.querySelectorAll('.page-number');
    pageButtons.forEach((btn, index) => {
      btn.classList.toggle('active', index + 1 === page);
    });
    
    // Update prev/next buttons
    const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
    document.getElementById('prevPagePatients').classList.toggle('disabled', page === 1);
    document.getElementById('nextPagePatients').classList.toggle('disabled', page === totalPages);
  }

  // Make functions globally available
  window.showPage = showPage;
  window.updateSelectedCount = updateSelectedCount;
  
  // Initial count update
  updateSelectedCount();
});

// Select all patients (across all pages)
function selectAllPatients() {
  if (globalSelectedPatients.size > 0) {
    // If some are selected, deselect all
    globalSelectedPatients.clear();
  } else {
    // Select all filtered patients
    filteredPatients.forEach(patient => {
      globalSelectedPatients.add(patient.id);
    });
  }
  
  // Update current page checkboxes
  const visibleCheckboxes = document.querySelectorAll('.patient-item:not([style*="display: none"]) input[name="patients"]');
  visibleCheckboxes.forEach(checkbox => {
    checkbox.checked = globalSelectedPatients.has(checkbox.value);
  });
  
  updateSelectedCount();
}

// Deselect all patients
function deselectAllPatients() {
  globalSelectedPatients.clear();
  const checkboxes = document.querySelectorAll('input[name="patients"]');
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectedCount();
}

// Reset form
function resetForm() {
  deselectAllPatients();
  document.getElementById('patientSearch').value = '';
  filteredPatients = [...allPatients];
  currentPage = 1;
  if (allPatients.length > patientsPerPage) {
    initializePagination();
  }
  showPage(1);
}

// Update selected count (function to be called from other functions)
function updateSelectedCount() {
  const count = globalSelectedPatients.size;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('submitBtn').disabled = count === 0;
  
  // Update select all button text
  const selectAllText = document.getElementById('selectAllText');
  const selectAllCount = document.getElementById('selectAllCount');
  
  if (count > 0) {
    selectAllText.textContent = 'Tout désélectionner';
    selectAllCount.textContent = count;
    selectAllCount.style.display = 'inline';
  } else {
    selectAllText.textContent = 'Tout sélectionner';
    selectAllCount.style.display = 'none';
  }
}
</script>
{% endblock %}
