{% if request.session.user.permissions.purchases.write %}
<!DOCTYPE html>
<html lang="fr">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% if supplier %}Modifier{% else %}Nouveau{% endif %} Fournisseur - ERP Clinique</title>
  <link rel="stylesheet" href="{% static 'vendor/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'vendor/fontawesome-free-6.4.0-web/css/all.min.css' %}">
  <link rel="stylesheet" href="{% static 'vendor/css/sweetalert2.min.css' %}">
  <script src="{% static 'vendor/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'vendor/js/sweetalert2@11.js' %}"></script>
</head>

<body>
  <div id="formulaire-fournisseur" class="content" style="margin-top:0px">
    <div class="card mb-4">
      <span id="supplier-list-url" data-url="{% url 'supplier_list' %}" hidden></span>

      <div class="card-header text-white" style="background-color: #1e90ff;">
        <i class="fas fa-edit me-2"></i>
        {% if supplier %}Modifier{% else %}Nouveau{% endif %} Fournisseur
      </div>
      <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'supplier_list' %}{% if supplier %}?edit={{ supplier.id }}{% endif %}" id="supplierForm">
          {% csrf_token %}
          {% if supplier %}
          <input type="hidden" name="supplier_id" value="{{ supplier.id }}">
          {% endif %}
          
          <div class="row g-3">
            <!-- Logo -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Logo :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-image"></i></span>
                <input type="file" name="logo" class="form-control">
              </div>
              {% if supplier and supplier.logo %}
                <div class="mt-2">
                  <img src="{{ supplier.logo.url }}" width="100" alt="Logo actuel">
                </div>
              {% endif %}
            </div>
            <!-- Nom -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Nom :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-user"></i></span>
                <input type="text" name="name" class="form-control" placeholder="Nom" required value="{{ supplier.name|default:'' }}">
              </div>
            </div>
            <!-- Société (radio) -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label d-block">Société ?</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="is_company" id="companyYes" value="True"
                  {% if supplier and supplier.is_company %}checked{% endif %}>
                <label class="form-check-label" for="companyYes">Oui</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="is_company" id="companyNo" value="False"
                  {% if supplier and not supplier.is_company %}checked{% endif %}>
                <label class="form-check-label" for="companyNo">Non</label>
              </div>
            </div>
            <!-- Adresse -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Adresse :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                <input type="text" name="street" class="form-control" placeholder="Adresse" value="{{ supplier.street|default:'' }}">
              </div>
            </div>
            <!-- Complément d'adresse -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Complément d'adresse :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map"></i></span>
                <input type="text" name="street2" class="form-control" placeholder="Complément d'adresse" value="{{ supplier.street2|default:'' }}">
              </div>
            </div>
            <!-- Code Postal -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Code Postal :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-mail-bulk"></i></span>
                <input type="text" name="zip" class="form-control" placeholder="Code Postal" value="{{ supplier.zip|default:'' }}">
              </div>
            </div>
            <!-- Ville -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Ville :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-city"></i></span>
                <select name="city" class="form-select" title="Choisir une ville">
                  <option value="">Choisir une ville</option>
                  {% for c in cities %}
                  <option value="{{ c.id }}" {% if supplier and supplier.city and supplier.city.id == c.id %}selected{% endif %}>{{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- Pays -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Pays :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-globe"></i></span>
                <select name="country" class="form-select" title="Choisir un pays">
                  <option value="">Choisir un pays</option>
                  {% for c in countries %}
                  <option value="{{ c.id }}" {% if supplier and supplier.country and supplier.country.id == c.id %}selected{% endif %}>{{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- Email -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Email :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                <input type="email" name="email" class="form-control" placeholder="Email" value="{{ supplier.email|default:'' }}">
              </div>
            </div>
            <!-- Téléphone -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Téléphone :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-phone"></i></span>
                <input type="text" name="phone" class="form-control" placeholder="Téléphone" value="{{ supplier.phone|default:'' }}">
              </div>
            </div>
            <!-- Mobile -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Mobile :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-mobile-alt"></i></span>
                <input type="text" name="mobile" class="form-control" placeholder="Mobile" value="{{ supplier.mobile|default:'' }}">
              </div>
            </div>
            <!-- ICE -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">ICE :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                <input type="text" name="ICE" class="form-control" placeholder="ICE" value="{{ supplier.ICE|default:'' }}">
              </div>
            </div>
            <!-- RC -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">RC :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                <input type="number" name="RC" class="form-control" placeholder="RC" value="{{ supplier.RC|default:'' }}">
              </div>
            </div>
            <!-- IF -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">IF :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                <input type="number" name="IF" class="form-control" placeholder="IF" value="{{ supplier.IF|default:'' }}">
              </div>
            </div>
            <!-- Langue -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">Langue :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-language"></i></span>
                <select name="lang" class="form-select" title="Choisir une langue">
                  <option value="">Choisir une langue</option>
                  {% for l in languages %}
                  <option value="{{ l.id }}" {% if supplier and supplier.lang and supplier.lang.id == l.id %}selected{% endif %}>{{ l.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- VAT -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">VAT :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-percent"></i></span>
                <input type="text" name="vat" class="form-control" placeholder="VAT" value="{{ supplier.vat|default:'' }}">
              </div>
            </div>
            <!-- RIB -->
            <div class="col-12 col-sm-6 col-md-4">
              <label class="form-label">RIB :</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-university"></i></span>
                <input type="text" name="RIB" class="form-control" placeholder="RIB" value="{{ supplier.RIB|default:'' }}">
              </div>
            </div>
            <!-- Commentaire -->
            <div class="col-12">
              <label class="form-label">Commentaire :</label>
              <textarea name="comment" class="form-control" rows="3" placeholder="Commentaire">{{ supplier.comment|default:'' }}</textarea>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 justify-content-end mt-4">
            <button type="reset" class="btn btn-secondary">
              <i class="fas fa-times"></i>
              <span class="d-none d-sm-inline ms-1">Annuler</span>
            </button>
            <button type="submit" class="btn btn-primary" id="submitSupplier">
              <i class="fas fa-save"></i>
              <span class="d-none d-sm-inline ms-1">{% if supplier %}Mettre à jour{% else %}Sauvegarder{% endif %}</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle form submission with SweetAlert confirmation
        const supplierForm = document.getElementById('supplierForm');
        const submitButton = document.getElementById('submitSupplier');
        const isEdit = {{ supplier|yesno:"true,false" }};

        supplierForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            Swal.fire({
                title: isEdit ? 'Confirmer la modification' : 'Confirmer la création',
                text: isEdit ? 'Voulez-vous vraiment modifier ce fournisseur ?' : 'Voulez-vous vraiment créer ce fournisseur ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#1e90ff',
                cancelButtonColor: '#6c757d',
                confirmButtonText: isEdit ? 'Oui, modifier' : 'Oui, créer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    supplierForm.submit(); // Proceed with form submission
                }
            });
        });

        // Check for status parameter in URL to show SweetAlert for success/error
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        if (status === 'created') {
            Swal.fire({
                icon: 'success',
                title: 'Succès',
                text: 'Le fournisseur a été créé avec succès !',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                window.location.href = "{% url 'supplier_list' %}";
            });
        } else if (status === 'updated') {
            Swal.fire({
                icon: 'success',
                title: 'Succès',
                text: 'Le fournisseur a été mis à jour avec succès !',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                window.location.href = "{% url 'supplier_list' %}";
            });
        } else if (status === 'error') {
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: 'Une erreur s\'est produite lors de la création ou de la mise à jour du fournisseur.',
            });
        }
    });
  </script>
</body>
</html>
{% endif %}